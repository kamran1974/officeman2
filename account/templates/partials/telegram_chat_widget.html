{% load static %}
<!DOCTYPE html>
<html>
<head>
    <!-- استایل‌های چت تلگرام -->

    <link rel="stylesheet" href="{% static 'css/jalalidatepicker.min.css' %}">
    <script src="{% static 'js/jalalidatepicker.min.js' %}"></script>
    <script src="{% static 'js/telegram-message-handler.js' %}"></script>
    <script src="{% static 'js/telegram-file-box-fix.js' %}"></script>
   

    
    <!-- اضافه کردن فایل انتخابگر ایموجی -->
    <script src="{% static 'js/telegram-emoji-picker.js' %}"></script>
    
    <!-- اضافه کردن فایل مدیریت پاسخ به پیام‌ها -->
    <script src="{% static 'js/telegram-reply-handler.js' %}"></script>
    
    <!-- اضافه کردن فایل نمایش پیام‌های ریپلای شده -->
    <script src="{% static 'js/telegram-reply-viewer.js' %}"></script>
    
    <!-- اضافه کردن فایل مدیریت اسکرول -->
    <script src="{% static 'js/telegram-scroll-manager.js' %}"></script>
    
    <!-- اضافه کردن فایل جستجو در پیام‌ها -->
    <script src="{% static 'js/telegram-search-messages.js' %}"></script>
</head>
<body>
<!-- ویجت چت شبیه تلگرام -->

<!-- اضافه کردن فایل جاوااسکریپت جدید -->
<script src="{% static 'js/jalali-datepicker-handler.js' %}"></script>
<!-- اضافه کردن فایل جاوااسکریپت جدید -->





<!-- اضافه کردن فایل جاوااسکریپت برای اصلاح مشکل overlay -->
<script src="{% static 'js/telegram-modal-fix.js' %}"></script>

<!-- اضافه کردن فایل جاوا اسکریپت برای دکمه زمان‌بندی -->
<script src="{% static 'js/telegram-schedule-button.js' %}"></script>

<!-- اضافه کردن فایل جاوااسکریپت برای ضبط صدا -->
<script src="{% static 'js/telegram-voice-recorder.js' %}"></script>

<!-- اضافه کردن فایل اصلاح کننده پخش‌کننده صوتی -->
<script src="{% static 'js/audio-player-fix.js' %}"></script>

<!-- اسکریپت اصلاح کننده نمایش پیش‌نمایش فایل -->
<script src="{% static 'js/telegram-file-preview-fix.js' %}"></script>

<!-- اسکریپت نمایش درصد پیشرفت آپلود فایل -->
<script src="{% static 'js/telegram-upload-progress.js' %}"></script>

<!-- اصلاح‌کننده تداخل توابع صوتی تلگرام -->
<script src="{% static 'js/telegram-audio-fix.js' %}"></script>

<style>
    /* استایل‌های اصلی چت تلگرام */
    .telegram-chat-container {
        position: fixed;
        bottom: 0;
        left: 20px;
        width: 350px;
        height: 520px;
        background-color: #1E222D;
        border-radius: 12px 12px 0 0;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        z-index: 999;
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease;
        transform: translateY(100%);
        visibility: hidden;
        opacity: 0;
        overflow: hidden;
        color: #fff;
    }
    
    .telegram-chat-container.open {
        transform: translateY(0);
        visibility: visible;
        opacity: 1;
    }

    /* هدر اصلی چت */
    .telegram-header {
        padding: 15px;
        background-color: #0F9D58;
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .telegram-header-title {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .telegram-header-title h3 {
        margin: 0;
        font-size: 17px;
        font-weight: 600;
    }

    .telegram-actions {
        display: flex;
        gap: 10px;
    }

    .telegram-action-btn {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
    }

    .telegram-action-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }

    /* بخش اصلی محتوا */
    .telegram-content {
        flex: 1;
        display: flex;
        overflow: hidden;
    }

    /* لیست مکالمات */
    .telegram-conversations {
        width: 100%;
        height: 100%;
        overflow-y: auto;
        border-right: 1px solid #2C3142;
        background-color: #1E222D;
        transition: width 0.3s ease;
    }

    /* وقتی چت باز است، لیست مکالمات مخفی می‌شود */
    .telegram-container-active .telegram-conversations {
        width: 0;
        display: none;
    }

    .telegram-search {
        padding: 12px;
        background-color: #2C3142;
        position: sticky;
        top: 0;
        z-index: 2;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
    }

    .telegram-search-input {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #3A4053;
        border-radius: 20px;
        outline: none;
        font-family: var(--main-font);
        font-size: 14px;
        background-color: #363C4E;
        color: #fff;
        transition: border-color 0.3s ease;
    }

    .telegram-search-input::placeholder {
        color: #9AA0B5;
    }

    .telegram-search-input:focus {
        border-color: #0F9D58;
        background-color: #3A4053;
    }

    .telegram-conversation-list {
        padding: 0;
        margin: 0;
        list-style: none;
    }

    .telegram-conversation-item {
        padding: 14px 15px;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        border-bottom: 1px solid #2C3142;
        transition: all 0.2s ease;
        background-color: #1E222D;
    }

    .telegram-conversation-item:hover {
        background-color: #2C3142;
    }

    .telegram-conversation-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background-color: #0F9D58;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 18px;
    }

    .telegram-conversation-avatar-sent {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background-color:#186e3c;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 18px;
    }

    .telegram-conversation-content {
        flex: 1;
        min-width: 0;
    }

    .telegram-conversation-top {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .telegram-conversation-name {
        font-weight: 600;
        font-size: 15px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #fff;
    }

    .telegram-conversation-time {
        font-size: 12px;
        color: #9AA0B5;
        white-space: nowrap;
    }

    .telegram-conversation-message {
        font-size: 13px;
        color: #9AA0B5;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
        display: flex;
        align-items: center;
    }

    .telegram-conversation-unread {
        min-width: 20px;
        height: 20px;
        border-radius: 10px;
        background-color: #0F9D58;
        color: white;
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 5px;
    }

    /* چت فعال */
    .telegram-active-chat {
        width: 0;
        height: 100%;
        display: flex;
        flex-direction: column;
        flex: 1;
        transition: width 0.3s ease;
        background-color: #1E222D;
    }

    .telegram-container-active .telegram-active-chat {
        width: 100%;
    }

    .telegram-chat-header {
        padding: 12px 15px;
        background-color: #2C3142;
        border-bottom: 1px solid #363C4E;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .telegram-back-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: #fff;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s ease;
    }

    .telegram-back-btn:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .telegram-chat-title {
        font-weight: 600;
        font-size: 16px;
        flex: 1;
        color: #fff;
    }

    .telegram-chat-body {
        flex: 1;
        padding: 12px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 2px;
        background-color: #17191F;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%232C3142' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2V6h4V4H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    .telegram-message {
        max-width: 75%;
        margin-bottom: 2px;
        display: flex;
        flex-direction: column;
        width: fit-content;
        background-color: transparent;
        padding: 0;
        animation: fadeInMessage 0.2s ease-out;
    }

    @keyframes fadeInMessage {
        from {
            opacity: 0;
            transform: translateY(5px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .telegram-message-incoming {
        align-self: flex-end; /* در RTL، پیام‌های دریافتی سمت چپ */
    }

    .telegram-message-outgoing {
        align-self: flex-start; /* در RTL، پیام‌های ارسالی سمت راست */
    }

    .telegram-message-content {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 8px;
        margin-bottom: 1px;
        width: fit-content;
        max-width: 100%;
    }
    
    .telegram-message-incoming .telegram-message-content {
        background-color: #2C3142;
        border-bottom-right-radius: 4px; /* گوشه سمت راست-پایین گرد نباشد */
        text-align: right;
       direction: rtl;
       margin-right: auto;
         /* برای چسباندن به سمت چپ در RTL */
    }
    
    .telegram-message-outgoing .telegram-message-content {
        background-color: #0F9D58;
        border-bottom-left-radius: 4px; /* گوشه سمت چپ-پایین گرد نباشد */
        text-align: right;
        direction: rtl;
       
        /* برای چسباندن به سمت راست در RTL */
    }

    .telegram-message-subject {
        font-weight: bold;
        margin-bottom: 5px;
        color: #fff;
    }

    .telegram-message-body {
        line-height: 1.5;
        color: #fff;
        margin: 0;
        padding: 0;
        white-space: pre-wrap;
        word-break: break-word;
        font-size: 14px;
        display: inline;
    }

    .telegram-message-time {
        font-size: 10px;
        color: #0F9D58;
        margin-top: 2px;
        margin-bottom: 0;
        padding: 0 5px;
        display: block;
        width: 100%;
    }

    .telegram-message-incoming .telegram-message-time {
        color: rgba(255, 255, 255, 0.6);
        text-align: left; /* زمان پیام‌های دریافتی سمت چپ باشد */
       
    }
    
    .telegram-message-outgoing .telegram-message-time {
        text-align: right; /* زمان پیام‌های ارسالی سمت راست باشد */
       
    }

    .telegram-input-container {
        padding: 8px 12px;
        background-color: #2C3142;
        border-top: 1px solid #363C4E;
        display: flex !important;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        width: 100%;
        position: relative;
        min-height: auto;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .telegram-input-wrapper {
        position: relative;
        width: 100%;
        margin-top: 0;
    }
    
    .telegram-input {
        flex: 1;
        padding: 20px 40px 12px 50px;
        border: 1px solid #3A4053;
        border-radius: 20px;
        outline: none;
        font-family: var(--main-font);
        font-size: 14px;
        background-color: #363C4E;
        color: #fff;
        max-height: 100px;
        min-height: 45px;
        resize: none;
        min-width: 0;
        width: 100%;
        overflow-y: auto;
        line-height: 1.5;
        direction: rtl;
        text-align: right;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .telegram-input:focus {
        border-color: #0F9D58;
        box-shadow: 0 0 0 2px rgba(15, 157, 88, 0.2);
    }
    
 
    
    .telegram-send-btn:hover {
        color: #0B8A4A;
        transform: scale(1.1);
    }
    
    /* گزینه‌های داخل INPUT */
    .telegram-footer {
        display: none; /* حذف نوار پایین جداگانه */
    }
    
    .telegram-container-active .telegram-footer {
        display: none; /* حتی در حالت فعال هم نمایش نده */
    }
    
    /* گزینه‌های داخل INPUT - فقط در صفحه چت فعال نمایش داده شوند */
    .telegram-input-options {
        position: absolute;
      
        left: 8px;
        bottom: 4px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        z-index: 2;
    }
    
    /* فقط در صفحه چت فعال نمایش داده شود */
    .telegram-container-active .telegram-input-options {
        display: flex;
        font-size: 15px;
    }
    
    .telegram-option-btn {

        border-radius: 0;
        background-color: transparent;
        color: #9AA0B5;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        padding: 0;
        font-size: 10px;
        opacity: 0.7;
    }
    
    .telegram-option-btn:hover {
        color: #ffffff;
        transform: scale(1.1);
        opacity: 1;
    }

    /* بهبود استایل‌های پنل ضبط صدا */
    .telegram-voice-recorder {
        display: flex;
        align-items: center;
        gap: 8px;
        background-color: #363C4E;
        padding: 8px 12px;
        border-radius: 20px;
        margin: 4px 0;
        width: 100%;
    }
    
    /* بهبود استایل‌های پیش‌نمایش فایل */
    .telegram-file-preview {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: #363C4E;
        padding: 8px 12px;
        border-radius: 20px;
        margin: 4px 0;
        width: 100%;
        overflow: hidden;
    }
    
    /* بهبود استایل‌های پنل زمانبندی */
    .telegram-schedule-panel {
        display: flex;
        flex-direction: column;
        background-color: #363C4E;
        padding: 12px;
        border-radius: 12px;
        margin: 4px 0;
        width: 100%;
    }
    
    .schedule-info {
        color: #fff;
        font-size: 13px;
        width: 100%;
    }
    
    .schedule-info .form-group {
        margin-bottom: 6px;
    }
    
    .schedule-info .form-label {
        display: block;
        margin-bottom: 3px;
        color: #9AA0B5;
        font-size: 12px;
    }
    
    .schedule-info .form-control {
        width: 100%;
        padding: 6px 10px;
        background-color: #2C3142;
        border: 1px solid #3A4053;
        border-radius: 6px;
        color: #fff;
        font-size: 13px;
    }
    
    .selected-time-display {
        margin-top: 8px;
        padding: 8px;
        background-color: rgba(15, 157, 88, 0.2);
        border-radius: 8px;
        color: #0F9D58;
        font-weight: 500;
    }
    
    .telegram-remove-schedule {
        align-self: flex-end;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background-color: #9AA0B5;
        color: #1E222D;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: 10px;
    }
    
    .telegram-remove-schedule:hover {
        background-color: #f44336;
        color: white;
    }
    
    /* استایل‌های مربوط به حالت کامل پنل‌ها وقتی که باز می‌شوند */
    .telegram-input-container.recording-active .telegram-input,
    .telegram-input-container.recording-active .telegram-input-options,
    .telegram-input-container.recording-active .telegram-send-btn,
    .telegram-input-container.file-preview-active .telegram-input,
    .telegram-input-container.file-preview-active .telegram-input-options,
    .telegram-input-container.file-preview-active .telegram-send-btn{
        display: none !important;
    }
    
    .telegram-input-container.recording-active .telegram-voice-recorder,
    .telegram-input-container.file-preview-active .telegram-file-preview {
        flex: 1;
        width: 100%;
    }
    
    /* تغییر استایل پنل زمانبندی برای نمایش بالای فوتر */
    .telegram-schedule-panel {
        position: absolute ;
        bottom: 80px !important;
        left: 0 ;
        right: 0 ;
        background-color: #2C3142 ;
        padding: 10px ;
        border-top: 1px solid #3A4053 ;
        z-index: 999999;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
        display: none;
    }
    
    /* اطمینان از نمایش فوتر چت باکس */
    .telegram-input-container {
        padding: 8px 12px;
        background-color: #2C3142;
        border-top: 1px solid #363C4E;
        display: flex !important;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        width: 100%;
        position: relative;
        min-height: auto;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .telegram-input-wrapper {
        position: relative;
        width: 100%;
        margin-top: 0;
    }
    
    .telegram-input {
        flex: 1;
        padding: 20px 40px 12px 50px;
        border: 1px solid #3A4053;
        border-radius: 20px;
        outline: none;
        font-family: var(--main-font);
        font-size: 14px;
        background-color: #363C4E;
        color: #fff;
        max-height: 100px;
        min-height: 45px;
        resize: none;
        min-width: 0;
        width: 100%;
        overflow-y: auto;
        line-height: 1.5;
        direction: rtl;
        text-align: right;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .telegram-input:focus {
        border-color: #0F9D58;
        box-shadow: 0 0 0 2px rgba(15, 157, 88, 0.2);
    }
    
    /* دکمه ارسال جدید - کوچک و بدون بک‌گراند */
    .telegram-send-btn {
        width: 18px;
        height: 18px;
        min-width: 18px;
        min-height: 18px;
        border-radius: 0;
        background-color: transparent;
        color: #0F9D58;
        display: none;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        padding: 0;
        flex-shrink: 0;
        position: absolute;
        right: 12px;
        bottom: 12px;
        z-index: 20;
        font-size: 17px;
    }
    
    /* فقط در صفحه چت فعال نمایش داده شود */
    .telegram-container-active .telegram-send-btn {
        display: flex;
    }
    
    /* نمایش در حالت پیش‌نمایش فایل */
    .telegram-input-container.file-preview-active .telegram-send-btn {
        display: flex !important;
        z-index: 20;
    }
    
    /* استایل برای دکمه ارسال در حالت پیش‌نمایش فایل */
    .telegram-file-preview-send-btn {
        width: 36px !important;
        height: 36px !important;
        min-width: 36px !important;
        min-height: 36px !important;
        border-radius: 50% !important;
        background-color: #0F9D58 !important;
        color: white !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        border: none !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
        padding: 0 !important;
        position: absolute !important;
        right: 16px !important;
        bottom: 23px !important;
        z-index: 30 !important;
        font-size: 16px !important;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
    }
    
    .telegram-file-preview-send-btn:hover {
        background-color: #0B8A4A !important;
        transform: scale(1.05) !important;
    }
    
    .telegram-send-btn:hover {
        color: #0B8A4A;
        transform: scale(1.1);
    }
    

    
    .telegram-option-btn {
        width: 18px;
        height: 18px;
        min-width: 18px;
        min-height: 18px;
        border-radius: 0;
        background-color: transparent;
        color: #0F9D58;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        padding: 0;
        font-size: 17px;
        opacity: 1;
    }
    
    .telegram-option-btn:hover {
        color: #0B8A4A;
        transform: scale(1.1);
    }
    
    /* نقطه چت در هدر */
    .telegram-chat-icon {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background-color: #0F9D58;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(15, 157, 88, 0.4);
        position: relative;
        font-size: 23px;
    }
    
    .telegram-chat-icon:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 4px 12px rgba(15, 157, 88, 0.5);
    }
    
    .telegram-notification-badge {
        position: absolute;
        top: -5px;
        left: -5px;
        background-color: #EA4335;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        border: 2px solid #1E222D;
    }
    
    @media (max-width: 768px) {
        .telegram-chat-container {
            width: 100%;
            left: 0;
            height: 80vh;
        }
    }
    
    .telegram-loading-message {
        padding: 20px;
        text-align: center;
        color: #9AA0B5;
        font-size: 14px;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        gap: 10px;
    }
    
    .telegram-loading-message i {
        font-size: 24px;
        color: #0F9D58;
        margin-bottom: 10px;
    }
    
    .telegram-empty-message {
        padding: 30px 20px;
        text-align: center;
        color: #9AA0B5;
        font-size: 15px;
        background-color: rgba(44, 49, 66, 0.5);
        border-radius: 10px;
        margin: 20px 0;
    }
    
    /* نشانگر فرستنده یا گیرنده بودن پیام */
    .telegram-conversation-item .message-status-indicator {
        width: 0;
        height: 0;
        display: none; /* کاملاً مخفی کردن نشانگر */
    }
    
    .telegram-conversation-item .message-sent {
        display: none; /* مخفی کردن کامل */
    }
    
    .telegram-conversation-item .message-received {
        display: none; /* مخفی کردن کامل */
    }
    
    .telegram-reply-icon {
        font-size: 10px;
        color: #9AA0B5;
        margin-right: 5px;
    }
    
    /* استایل‌های جدید برای لیست کاربران */
    .telegram-users-list {
        max-height: 350px;
        overflow-y: auto;
        background-color: #2C3142;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        margin-top: 10px;
        display: none;
        position: absolute;
        left: 12px;
        right: 12px;
        z-index: 3;
        border: 1px solid #3A4053;
    }
    
    .telegram-users-list.active {
        display: block;
    }
    
    .telegram-user-item {
        padding: 12px 15px;
        border-bottom: 1px solid #3A4053;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s ease;
    }
    
    .telegram-user-item:hover {
        background-color: #363C4E;
    }
    
    .telegram-user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #0F9D58;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 16px;
    }
    
    .telegram-user-name {
        font-size: 14px;
        font-weight: 500;
        color: #fff;
    }
    
    .telegram-users-loading {
        padding: 20px;
        text-align: center;
        color: #9AA0B5;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }
    
    .telegram-users-loading i {
        font-size: 20px;
        color: #0F9D58;
        margin-bottom: 5px;
    }
    
    .telegram-no-users {
        padding: 20px;
        text-align: center;
        color: #9AA0B5;
    }
    
    .telegram-search-wrapper {
        position: relative;
    }
    
    /* استایل‌های مربوط به ضمیمه‌های پیام */
    .telegram-message-attachments {
        margin-top: 12px;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .telegram-attachment-item {
        background-color: rgba(58, 64, 83, 0.5);
        border-radius: 10px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 1px solid rgba(70, 76, 95, 0.5);
        transition: all 0.3s ease;
    }
    
    .telegram-attachment-item:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        transform: translateY(-2px);
    }
    
    .telegram-message-incoming .telegram-attachment-item {
        background-color: rgba(58, 64, 83, 0.7);
    }
    
    .telegram-message-outgoing .telegram-attachment-item {
        background-color: rgba(11, 138, 74, 0.3);
        border-color: rgba(11, 138, 74, 0.5);
    }
    
    /* استایل‌های جدید برای نمایش فایل‌ها به صورت مستقل مثل تلگرام */
    .telegram-attachment-item-standalone {
        width: auto;
        max-width: 280px;
        border-radius: 8px;
     
        position: relative;
        min-width: 240px;
    }
    
    /* اصلاح استایل‌های ضمیمه‌ها برای پیام‌های دریافتی و ارسالی */
    .telegram-message-incoming .telegram-attachment-item,
    .telegram-message-incoming .telegram-attachment-item-standalone {
        align-self: flex-end; /* در RTL، ضمیمه‌های دریافتی سمت چپ */
    }
    
    .telegram-message-outgoing .telegram-attachment-item,
    .telegram-message-outgoing .telegram-attachment-item-standalone {
        align-self: flex-start; /* در RTL، ضمیمه‌های ارسالی سمت راست */
    }
    
    .telegram-message-incoming .telegram-attachment-item-standalone {
        background-color: #2C3142;
    }
    
    .telegram-message-outgoing .telegram-attachment-item-standalone {
        background-color: #0F9D58;
    }
    
    /* استایل برای تصاویر مستقل */
    .telegram-attachment-image-standalone {
        width: 100%;
        max-height: 180px;
        object-fit: cover;
        border-radius: 8px 8px 0 0;
        cursor: pointer;
    }
    
    /* استایل برای ویدئوهای مستقل */
    .telegram-video-container {
        position: relative;
        width: 100%;
        border-radius: 8px 8px 0 0;
        overflow: hidden;
        max-height: 180px;
        background-color: #000;
    }
    
    .telegram-attachment-video-standalone {
        width: 100%;
        height: auto;
        max-height: 180px;
        object-fit: contain;
        background-color: #000;
        display: block;
    }
    
    .telegram-video-thumbnail {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        background-color: #111;
        z-index: 1;
    }
    
    .telegram-video-play-btn {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        background-color: rgba(15, 157, 88, 0.8);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: white;
        font-size: 20px;
        z-index: 2;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        transition: all 0.2s ease;
    }
    
    .telegram-video-play-btn:hover {
        background-color: rgba(15, 157, 88, 1);
        transform: translate(-50%, -50%) scale(1.1);
    }
    
    /* پخش‌کننده صوتی شبیه تلگرام */
    .telegram-audio-player {
        width: 100%;
        padding: 12px;
        background-color: rgba(23, 25, 31, 0.6);
        border-radius: 8px;
        margin-top: 8px;
        direction: ltr;
    }
    
    .telegram-audio-controls {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .telegram-audio-play {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        border: none;
        background-color: #0F9D58;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        flex-shrink: 0;
    }
    
    .telegram-audio-play:hover {
        background-color: #0B8A4A;
        transform: scale(1.05);
    }
    
    .telegram-audio-progress {
        flex: 1;
        height: 6px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
        cursor: pointer;
        position: relative;
    }
    
    .telegram-audio-progress-bar {
        height: 100%;
        background-color: #0F9D58;
        width: 0;
        transition: width 0.1s linear;
        position: absolute;
        top: 0;
        left: 0;
    }
    
    .telegram-audio-time {
        font-size: 12px;
        color: #9AA0B5;
        min-width: 45px;
        text-align: right;
        font-family: monospace;
    }
    
    /* لایت باکس */
    .telegram-lightbox {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }
    
    .telegram-lightbox.active {
        opacity: 1;
        visibility: visible;
    }
    
    .telegram-lightbox-content {
        position: relative;
        max-width: 90%;
        max-height: 90%;
    }
    
    .telegram-lightbox-close {
        position: absolute;
        top: -45px;
        right: 0;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .telegram-lightbox-close:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }
    
    .telegram-lightbox-image {
        max-width: 100%;
        max-height: 85vh;
        object-fit: contain;
        border-radius: 5px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
    }
    
    /* استایل فایل‌های سند و PDF */
    .telegram-file-box {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 8px;
        background-color: #2C3142;
        margin-bottom: 5px;
        width: 100%;
    }
    
    .telegram-file-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background-color: #363C4E;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 16px;
        flex-shrink: 0;
    }
    
    .telegram-file-icon.doc {
        background-color: #4285F4;
    }
    
    .telegram-file-icon.excel {
        background-color: #0F9D58;
    }
    
    .telegram-file-icon.pdf {
        background-color: #DB4437;
    }
    
    .telegram-file-icon.presentation {
        background-color: #F4B400;
    }
    
    .telegram-file-icon.archive {
        background-color: #795548;
    }
    
    .telegram-file-icon.code {
        background-color: #607D8B;
    }
    
    .telegram-file-icon-wrapper {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background-color: #363C4E;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    .telegram-file-icon-ext {
        font-size: 12px;
        font-weight: bold;
        color: #fff;
        text-transform: uppercase;
    }
    
    .telegram-file-info {
        flex: 1;
        min-width: 0;
        margin-right: 5px;
    }
    
    .telegram-file-name {
        font-size: 13px;
        color: #fff;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 3px;
        max-width: 160px;
    }
    
    .telegram-file-meta {
        font-size: 11px;
        color: #9AA0B5;
        background-color: rgba(255, 255, 255, 0.1);
        padding: 1px 5px;
        border-radius: 3px;
        display: inline-block;
    }

    .telegram-attachment-meta-standalone {
        display: flex;
        justify-content: space-between;
        padding: 0 5px 3px;
    }
    
    .telegram-file-size {
        color: rgba(255, 255, 255, 0.7);
    }
    
    .telegram-download-btn {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        text-decoration: none;
        transition: background-color 0.2s ease;
    }
    
    .telegram-download-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    /* استایل متفاوت برای پیام‌های دریافتی و ارسالی */

   .telegram-message-outgoing .telegram-attachment-item-standalone .telegram-file-box {
        background-color: #0F9D58 ;

    }
    .telegram-message-outgoing .telegram-attachment-item-standalone .telegram-file-box .telegram-file-icon-wrapper{
            background: none;
    }
    .telegram-message-outgoing .telegram-attachment-item-standalone .telegram-file-box .telegram-download-btn{
        color: #ffffff;
        background: #3A4053;
    }
    .telegram-message-outgoing .telegram-attachment-item-standalone .telegram-file-box .telegram-file-meta{
        color: #ffffffc2;
        background: rgba(255, 255, 255, 0.1);
    }
    /* استایل‌های پخش‌کننده ویدیو که حذف شده بودند */
    .telegram-video-play-btn {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 42px;
        height: 42px;
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: white;
        font-size: 18px;
    }
    
    /* استایل‌های پخش‌کننده صوتی */
    .telegram-audio-progress {
        flex: 1;
        height: 4px;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        overflow: hidden;
        position: relative;
        cursor: pointer;
    }
    
    .telegram-audio-progress-bar {
        height: 100%;
        background-color: rgba(255, 255, 255, 0.6);
        width: 0;
        position: absolute;
        top: 0;
        left: 0;
    }
    
    .telegram-audio-time {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.6);
        min-width: 40px;
        text-align: center;
        font-family: monospace;
    }
    
    /* استایل‌های جدید پخش‌کننده صوتی */
    .telegram-audio-custom {
        width: 100%;
        padding: 10px;
        background-color: #2C3142;
        border-radius: 18px !important;
        direction: ltr;
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 240px;
        overflow: hidden;
    }

    .telegram-message-incoming .telegram-audio-custom {
        background-color: #2C3142;
    }

    .telegram-message-outgoing .telegram-audio-custom {
        background-color: #0F9D58;
    }

    .telegram-audio-custom .telegram-audio-play {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        border: none;
        background-color: #0F9D58;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        flex-shrink: 0;
        font-size: 14px;
    }

    .telegram-message-incoming .telegram-audio-custom .telegram-audio-play {
        background-color: #0F9D58;
    }
    
    .telegram-message-outgoing .telegram-audio-custom .telegram-audio-play {
        background-color: #3A4053;
    }

    .telegram-audio-custom .telegram-audio-play:hover {
        transform: scale(1.05);
    }

    /* نوار پیشرفت پخش‌کننده صوتی */
    .telegram-audio-custom .telegram-audio-progress {
        width: 100%;
        height: 6px;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
        overflow: hidden;
        position: relative;
        cursor: pointer;
    }

    .telegram-audio-custom .telegram-audio-progress-bar {
        height: 100%;
        background-color: #0F9D58;
        width: 0;
        position: absolute;
        top: 0;
        left: 0;
        transition: width 0.1s linear;
    }

    .telegram-message-incoming .telegram-audio-custom .telegram-audio-progress-bar {
        background-color: #0F9D58;
    }

    .telegram-message-outgoing .telegram-audio-custom .telegram-audio-progress-bar {
        background-color: #3A4053;
    }

    .telegram-audio-custom .telegram-audio-time {
        font-size: 12px;
        color: #ffffff;
        text-align: left;
        font-family: monospace;
        font-weight: 500;
        text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
        margin-top: 5px;
        display: block;
    }

    .telegram-audio-custom .telegram-download-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #363C4E;
        color: #fff;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
        margin-left: 5px;
        text-decoration: none;
    }
    
    .telegram-audio-custom .telegram-download-btn:hover {
        background-color: #4285F4;
    }
    
    /* دکمه دانلود در پیام‌های دریافتی */
    .telegram-message-incoming .telegram-audio-custom .telegram-download-btn:hover {
        background-color: #0F9D58;
    }
    
    /* استایل‌های منوی تغییر سرعت پخش */
    .telegram-audio-custom .telegram-audio-speed {
        position: relative;
        margin-left: 5px;
    }
    
    .telegram-audio-custom .telegram-audio-speed-btn {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background-color: #363C4E;
        color: #fff;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
        font-weight: bold;
        margin-left: 5px;
    }
    
    .telegram-audio-custom .telegram-audio-speed-btn:hover {
        background-color:#186e3c;
        transform: scale(1.05);
    }

    .telegram-message-outgoing .telegram-audio-custom .telegram-audio-speed-btn:hover {
        background-color:#3A4053;
        transform: scale(1.05);
    }
    
    .telegram-message-incoming .telegram-audio-custom .telegram-audio-speed-btn:hover {
        background-color: #0F9D58;
    }
    
    .telegram-audio-custom .telegram-audio-speed-options {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #2C3142;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        padding: 8px;
        display: none;
        flex-direction: column;
        width: 70px;
        margin-bottom: 8px;
        z-index: 99999;
        gap: 5px;
    }
    
    .telegram-audio-custom .telegram-audio-speed-option {
        padding: 5px 8px;
        background: none;
        border: none;
        text-align: center;
        color: #fff;
        font-size: 12px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.2s ease;
        font-weight: 500;
    }
    
    .telegram-audio-custom .telegram-audio-speed-option:hover {
        background-color: #363C4E;
    }
    
    /* منوی تغییر سرعت پس از گزینه دانلود */

    .telegram-message-time-audio {
        display: none;
    }

    .telegram-audio-custom .telegram-download-btn:hover {
        background-color: #0B8A4A;
        transform: scale(1.05);
    }

    .telegram-message-outgoing .telegram-audio-custom .telegram-download-btn:hover {
        background-color: #3A4053;
        transform: scale(1.05);
    }

    
    
    
    .telegram-message .telegram-audio-custom {
        min-width: 240px;
    }

    .telegram-attachment-item-standalone {
        max-width: 280px !important;
        background-color: transparent !important;
    }
    
    /* استایل زمان پیام */
    .telegram-message-time {
        font-size: 10px;
        color: #0F9D58;
        margin-top: 2px;
        margin-bottom: 0;
        padding: 0 5px;
        display: block;
        width: 100%;
    }

    .telegram-message-incoming .telegram-message-time {
        color: rgba(255, 255, 255, 0.6);
        text-align: left; /* زمان پیام‌های دریافتی سمت چپ باشد */
       
    }
    
    .telegram-message-outgoing .telegram-message-time {
        text-align: right; /* زمان پیام‌های ارسالی سمت راست باشد */
       
    }

    /* استایل‌های جدید برای نمایش وضعیت خوانده شدن */
    .telegram-message-status {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.6);
        display: flex;
        align-items: center;
        gap: 5px;
        margin-top: 2px;
    }

    .telegram-message-status-icon {
        margin-left: 5px;
    }
    
    .telegram-message-sent {
        color: #8e8e8e;
    }
    
    .telegram-message-seen {
        color: #0F9D58;
    }
    
    .telegram-message-pending {
        color: #FFB74D;
    }

    /* نشانگر خوانده شدن در لیست مکالمات */
    .telegram-conversation-read-status {
        display: inline-block;
        margin-left: 5px;
        font-size: 12px;
    }

    .telegram-conversation-read {
        color: #0F9D58; /* رنگ سبز برای آیکون خوانده شده */
    }
    
    .telegram-conversation-pending {
        color: #FFB74D; /* رنگ نارنجی برای آیکون در انتظار ارسال */
    }



 
    
    .telegram-option-btn:hover {
        background-color: #3A4053;
        color: #fff;
    }

    /* استایل‌های ضبط صدا */
    .telegram-voice-recorder {
        display: flex;
        align-items: center;
        gap: 10px;
        background-color: #363C4E;
        padding: 8px 12px;
        border-radius: 20px;
        margin-left: 10px;
    }
    
    .recorder-timer {
        font-size: 14px;
        color: #fff;
        font-family: monospace;
    }
    
    .recorder-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .recorder-btn.start-record {
        background-color: #f44336;
        color: white;
    }
    
    .recorder-btn.stop-record {
        background-color: #4CAF50;
        color: white;
    }
    
    .recorder-btn.cancel-record {
        background-color: #9AA0B5;
        color: white;
    }
    
    /* استایل‌های پیش‌نمایش فایل */
    .telegram-file-preview {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: #363C4E;
        padding: 8px 12px;
        border-radius: 20px;
        margin-left: 10px;
        flex: 1;
    }
    
    .file-preview-info {
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 4px;
        color: #fff;
        font-size: 14px;
        max-width: calc(100% - 60px);
        overflow: hidden;
        padding-right: 40px;
    }
    
    .file-name {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #fff;
        font-size: 14px;
    }
    
    .file-info {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .telegram-remove-file {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: #9AA0B5;
        color: #1E222D;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .telegram-remove-file:hover {
        background-color: #f44336;
        color: white;
    }
    
    /* استایل‌های پنل زمانبندی */
    .telegram-schedule-panel {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: #363C4E;
        padding: 8px 12px;
        border-radius: 20px;
        margin-left: 10px;
        flex: 1;
    }
    
    .schedule-info {
        color: #fff;
        font-size: 13px;
        width: 100%;
    }
    
    .schedule-info .form-group {
        margin-bottom: 6px;
    }
    
    .schedule-info .form-label {
        display: block;
        margin-bottom: 3px;
        color: #9AA0B5;
        font-size: 12px;
    }
    
    .schedule-info .form-control {
        width: 100%;
        padding: 6px 10px;
        background-color: #2C3142;
        border: 1px solid #3A4053;
        border-radius: 6px;
        display: block;
        text-align: center;
        margin-top: 10px;
    }

    /* اضافه کردن استایل برای دکمه انتخاب */
    .jdp-select-btn {
        background-color: #0F9D58 !important;
        color: #fff !important;
        padding: 8px 15px !important;
        margin-right: 5px !important;
        font-weight: bold !important;
        border-radius: 6px !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
    }
    
    .jdp-select-btn:hover {
        background-color: #0B8A4A !important;
        transform: scale(1.05) !important;
    }

    #scheduleTimeDisplay.not-selected {
        color: #ff5722;
        background-color: rgba(255, 87, 34, 0.1);
    }
    
    #scheduleTimeDisplay.selected {
        color: #0F9D58;
        background-color: rgba(15, 157, 88, 0.1);
    }
    
    #scheduleTimeDisplay {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    #scheduleTimeDisplay:hover {
        opacity: 0.8;
    }
    
    /* استایل جدید برای نمایش وضعیت پیام در کنار زمان */
    .telegram-message-time-container {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 4px;
        font-size: 11px;
        color: rgba(255, 255, 255, 0.5);
    }
    
    .telegram-message-incoming .telegram-message-time-container {
        justify-content: flex-start;
    }
    
    .telegram-message-status-icon {
        font-size: 11px;
    }
    
    /* رنگ آبی برای تیک‌های خوانده شده */
    .telegram-message-seen {
        color: #34b7f1 !important;
    }
    
    /* انحنادار کردن گوشه‌های پیام‌های صوتی */
    .telegram-audio-custom {
        border-radius: 18px !important;
        overflow: hidden;
    }
    
    /* استایل برای قسمت محتوای صوتی */
    .telegram-audio-content {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        margin-right: 8px;
    }
    
    /* تنظیم استایل زمان پخش */
    .telegram-audio-time {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 4px;
        align-self: flex-start;
    }

    /* استایل جدید برای نمایش زمان پخش */
    .telegram-audio-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        margin: 0 8px;
    }
    
    .telegram-audio-track {
        position: relative;
        height: 30px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        overflow: hidden;
    }
    
    .telegram-audio-progress-bar {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 0;
        background-color: rgba(255, 255, 255, 0.2);
        transition: width 0.1s linear;
    }
    
    .telegram-message-incoming .telegram-audio-progress-bar {
        background-color: rgba(15, 157, 88, 0.3);
    }
    
    .telegram-message-outgoing .telegram-audio-progress-bar {
        background-color: rgba(58, 64, 83, 0.3);
    }
    
    .telegram-audio-time-display {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-family: monospace;
        pointer-events: none;
        text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
    }

    /* استایل دکمه دانلود برای تصاویر */
    .telegram-image-download-btn {
        position: absolute;
        bottom: 31px;
        left: 2px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        text-decoration: none;
        transition: all 0.2s ease;
        z-index: 10;
    }

    .telegram-image-download-btn:hover {
        background-color: rgba(0, 0, 0, 0.7);
        transform: scale(1.1);
    }

    .telegram-message-incoming .telegram-image-download-btn:hover {
        background-color: #0F9D58;
    }

    .telegram-message-outgoing .telegram-image-download-btn:hover {
        background-color: #3A4053;
    }

    .telegram-attachment-meta-standalone {
        display: flex;
        justify-content: space-between;
        padding: 0 5px 3px;
        position: relative;
    }

    .telegram-conversation-message .telegram-message-status-icon {
        margin-right: 5px;
        font-size: 12px;
    }

    .telegram-conversation-message .telegram-message-pending {
        color: #FFB74D;
    }

    .telegram-conversation-message .telegram-message-sent {
        color: #9AA0B5;
    }

    .telegram-conversation-message .telegram-message-seen {
        color: #0F9D58;
    }

    .telegram-conversation-read {
        color: #0F9D58; /* رنگ سبز برای آیکون خوانده شده */
    }

    .telegram-conversation-message .telegram-message-pending {
        color: #FFB74D; /* رنگ نارنجی برای آیکون در انتظار ارسال */
    }

    .telegram-conversation-message .telegram-message-sent {
        color: #9AA0B5; /* رنگ خاکستری برای آیکون ارسال شده */
    }

    .telegram-conversation-message .telegram-message-seen {
        color: #0F9D58; /* رنگ سبز برای آیکون خوانده شده */
    }

    .telegram-conversation-message .telegram-message-status-icon {
        margin-right: 5px;
        font-size: 12px;
    }
    
    /* استایل‌های مربوط به جستجو در پیام‌ها */
    .telegram-search-chat {
        padding: 8px 12px;
        background-color: #2C3142;
        border-bottom: 1px solid #3A4053;
        position: relative;
        z-index: 2;
    }
    
    .telegram-search-chat-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .telegram-search-chat-input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #3A4053;
        border-radius: 20px;
        outline: none;
        font-family: var(--main-font);
        font-size: 13px;
        background-color: #363C4E;
        color: #fff;
        transition: border-color 0.3s ease;
    }
    
    .telegram-search-chat-input::placeholder {
        color: #9AA0B5;
    }
    
    .telegram-search-chat-input:focus {
        border-color: #0F9D58;
        background-color: #3A4053;
    }
    
    .telegram-search-chat-close {
        background: none;
        border: none;
        cursor: pointer;
        color: #9AA0B5;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
    }
    
    .telegram-search-chat-close:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: #fff;
    }
    
    .telegram-search-results {
        max-height: 200px;
        overflow-y: auto;
        margin-top: 8px;
    }
    
    .telegram-search-result-item {
        padding: 8px 10px;
        border-radius: 8px;
        margin-bottom: 5px;
        cursor: pointer;
        background-color: #363C4E;
        transition: all 0.2s ease;
    }
    
    .telegram-search-result-item:hover {
        background-color: #3A4053;
    }
    
    .telegram-search-result-text {
        font-size: 13px;
        color: #fff;
        margin-bottom: 3px;
    }
    
    .telegram-search-result-info {
        font-size: 11px;
        color: #9AA0B5;
    }
    
    .telegram-search-highlight {
        background-color: rgba(15, 157, 88, 0.3);
        padding: 0 2px;
        border-radius: 3px;
    }

    @media screen and (max-width: 768px) {
        .telegram-input {
          min-height: 80px;

        }
      .telegram-send-btn {
       font-size: 23px;
       bottom: 13px;
      }
      .telegram-input-options{
        bottom: 5px;
        row-gap: 8px;
      }
      .telegram-option-btn{ 
        font-size: 19px;
       
      }
      .telegram-emoji-btn{
        font-size: 23px!important;
        right: 20px!important;
      }
      .telegram-schedule-panel{
        bottom: 91px!important;
      }
    }
    
</style>

<!-- دکمه چت در هدر -->
{% with permissions=request.user.get_all_permissions %}
{% if "organization.view_message" in permissions or "organization.add_message" in permissions %}
<div class="telegram-chat-icon" id="telegramChatIcon">
    <i class="fa-solid fa-comments"></i>
    <span class="telegram-notification-badge" id="telegramNotificationBadge" style="display: none;"></span>
</div>
{% endif %}
{% endwith %}

<!-- ویجت اصلی چت تلگرام -->
{% with permissions=request.user.get_all_permissions %}
{% if "organization.view_message" in permissions or "organization.add_message" in permissions %}
<div class="telegram-chat-container" id="telegramChatContainer">
    <!-- هدر اصلی -->
    <div class="telegram-header">
        <div class="telegram-header-title">
            <i class="fa-solid fa-comments"></i>
            <h3>گفتگوها</h3>
        </div>
        <div class="telegram-actions">
            <!-- <button class="telegram-action-btn" id="telegramMinimize" aria-label="کمینه کردن">
                <i class="fa-solid fa-minus"></i>
            </button> -->
            <button class="telegram-action-btn" id="telegramClose" aria-label="بستن">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>

    <!-- محتوای اصلی -->
    <div class="telegram-content">
        <!-- لیست مکالمات -->
        <div class="telegram-conversations">
            <div class="telegram-search">
                <div class="telegram-search-wrapper">
                    <input type="text" class="telegram-search-input" id="telegramSearchInput" placeholder="جستجوی کاربران...">
                    <div class="telegram-users-list" id="telegramUsersList">
                        <!-- با جاوااسکریپت پر می‌شود -->
                        <div class="telegram-users-loading">
                            <i class="fa-solid fa-spinner fa-spin"></i>
                            <span>در حال بارگذاری کاربران...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="telegram-conversation-list" id="telegramConversationList">
                <!-- با جاوااسکریپت پر می‌شود -->
                <div class="telegram-loading-message">
                    <i class="fa-solid fa-spinner fa-spin"></i>
                    <span>در حال بارگذاری گفتگوها...</span>
                </div>
            </div>
        </div>

        <!-- چت فعال -->
        <div class="telegram-active-chat" id="telegramActiveChat">
            <div class="telegram-chat-header">
                <button class="telegram-back-btn" id="telegramBackBtn">
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
                <div class="telegram-chat-title" id="telegramChatTitle">نام کاربر</div>
                <button class="telegram-action-btn" id="telegramSearchBtn" title="جستجو در پیام‌ها">
                    <i class="fa-solid fa-search"></i>
                </button>
            </div>
            <div class="telegram-search-chat" id="telegramSearchChat" style="display: none;">
                <div class="telegram-search-chat-wrapper">
                    <input type="text" class="telegram-search-chat-input" id="telegramSearchChatInput" placeholder="جستجو در پیام‌ها...">
                    <button class="telegram-search-chat-close" id="telegramSearchChatClose">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                <div class="telegram-search-results" id="telegramSearchResults"></div>
            </div>
            <div class="telegram-chat-body" id="telegramChatBody">
                <!-- پیام‌ها با جاوااسکریپت پر می‌شند -->
                <div class="telegram-loading-message">
                    <i class="fa-solid fa-spinner fa-spin"></i>
                    <span>در حال بارگذاری پیام‌ها...</span>
                </div>
            </div>
            <div class="telegram-input-container">
                <div class="telegram-input-wrapper">
                    <textarea class="telegram-input" id="telegramInput" placeholder="پیام خود را بنویسید..."></textarea>
                    <button class="telegram-send-btn" id="telegramSendBtn">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                    <!-- گزینه‌های داخل INPUT -->
                    <div class="telegram-input-options">
                        <button type="button" class="telegram-option-btn" id="attachFileBtn" title="افزودن فایل">
                            <i class="fa-solid fa-paperclip"></i>
                        </button>
                        <button type="button" class="telegram-option-btn" id="recordVoiceBtn" title="ضبط صدا">
                            <i class="fa-solid fa-microphone"></i>
                        </button>
                    </div>
                    <!-- فیلد مخفی برای آپلود فایل -->
                    <input type="file" id="fileInput" style="display: none;" accept="image/*,audio/*,video/*,.pdf,.docx,.xlsx">
                </div>
                
                <!-- پنل ضبط صدا (به صورت پیش‌فرض مخفی) -->
                <div class="telegram-voice-recorder" id="voiceRecorder" style="display: none;">
                    <div class="recorder-timer">00:00</div>
                    <button class="recorder-btn start-record" id="startRecordBtn">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <button class="recorder-btn stop-record" id="stopRecordBtn" style="display: none;">
                        <i class="fa-solid fa-stop"></i>
                    </button>
                    <button class="recorder-btn cancel-record" id="cancelRecordBtn">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                
                <!-- پنل پیش‌نمایش فایل انتخاب شده (به صورت پیش‌فرض مخفی) -->
                <div class="telegram-file-preview" id="filePreview" style="display: none;">
                    <div class="file-preview-info"></div>
                    <button class="telegram-remove-file" id="removeFileBtn">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                </div>
                
                <!-- پنل زمان‌بندی (به صورت پیش‌فرض مخفی) - خارج از کانتینر ورودی -->
                <div class="telegram-schedule-panel" id="schedulePanel" style="display: none; position: absolute; bottom: 60px; left: 0; right: 0; background-color: #2C3142; padding: 8px; border-top: 1px solid #3A4053; z-index: 999999; box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);">
                    <div class="schedule-info">
                        <div class="form-group mb-1">
                            <label for="scheduledTimeInput" class="form-label" style="font-size:12px; margin-bottom:3px;">تاریخ و زمان ارسال:</label>
                            <input type="text" id="scheduledTimeInput" data-jdp-chat class="form-control" placeholder="انتخاب تاریخ و زمان" style="padding:6px 10px; font-size:13px;">
                        </div>
                    </div>
                        <button class="telegram-remove-schedule" id="removeScheduleBtn">
                        <i class="fa-solid fa-arrow-left"></i>
                        </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endwith %}

<!-- لایت باکس برای نمایش تصاویر -->
<div class="telegram-lightbox" id="telegramLightbox">
    <div class="telegram-lightbox-content">
        <button type="button" class="telegram-lightbox-close" onclick="closeTelegramLightbox()">
            <i class="fa-solid fa-times"></i>
        </button>
        <img src="" class="telegram-lightbox-image" id="telegramLightboxImage" alt="تصویر">
    </div>
</div>

<div class="jdp-modal-overlay" id="jdpModalOverlay"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // المان‌های اصلی
    const chatIcon = document.getElementById('telegramChatIcon');
    const notificationBadge = document.getElementById('telegramNotificationBadge');
    const chatContainer = document.getElementById('telegramChatContainer');
    const closeBtn = document.getElementById('telegramClose');
    const conversationList = document.getElementById('telegramConversationList');
    const searchInput = document.getElementById('telegramSearchInput');
    const activeChat = document.getElementById('telegramActiveChat');
    const chatBody = document.getElementById('telegramChatBody');
    const chatTitle = document.getElementById('telegramChatTitle');
    const messageInput = document.getElementById('telegramInput');
    const sendButton = document.getElementById('telegramSendBtn');
    const backBtn = document.getElementById('telegramBackBtn');

    // متغیرهای کلی
    let conversations = [];        // لیست گفتگوها
    let activeMessages = [];       // پیام‌های گفتگوی فعال
    let activeConversation = null; // گفتگوی فعال
    let unreadCount = 0;           // تعداد پیام‌های خوانده نشده
    let debugMode = false;         // حالت دیباگ برای نمایش لاگ‌ها
    let allUsers = [];             // لیست تمام کاربران برای جستجو
    let scheduledTime = null;      // زمان زمانبندی شده برای ارسال پیام
    window.selectedFile = null;    // فایل انتخاب شده برای آپلود
    let datepickerInstance = null; // نمونه تقویم شمسی
    let tempSelectedDate = null;   // تاریخ موقت انتخاب شده در تقویم
    let messageWasSent = false;    // آیا پیامی ارسال شده است؟

    // بررسی پیام‌های خوانده نشده در هنگام بارگذاری صفحه
    checkUnreadMessages();
    
    // بررسی دوره‌ای پیام‌های خوانده نشده هر 30 ثانیه
    setInterval(checkUnreadMessages, 30000);
    
    // نمایش/مخفی کردن چت
    chatIcon.addEventListener('click', function() {
        chatContainer.classList.add('open');
        loadAllMessages();
    });



    closeBtn.addEventListener('click', function() {
        chatContainer.classList.remove('open');
    });

    // برگشت به لیست گفتگوها
    backBtn.addEventListener('click', function() {
        // فقط اگر پیامی ارسال شده باشد، لیست گفتگوها را به‌روزرسانی کن
        if (messageWasSent) {
            loadAllMessages();
            messageWasSent = false; // بازنشانی پرچم پس از به‌روزرسانی
        }
        
        // نمایش لیست گفتگوها
        chatContainer.classList.remove('telegram-container-active');
        activeConversation = null;
    });

    // نمایش لیست کاربران با کلیک روی فیلد جستجو
    searchInput.addEventListener('focus', function() {
        if (allUsers.length === 0) {
            loadAllUsers();
        } else {
            showUsersList(allUsers);
        }
        document.getElementById('telegramUsersList').classList.add('active');
    });
    
    // جستجو در لیست کاربران
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        if (allUsers.length > 0) {
            const filteredUsers = allUsers.filter(user => {
                // جستجو در نام کاربر
                const nameMatch = user.name && user.name.toLowerCase().includes(searchTerm);
                
                // جستجو در id_number کاربر
                const idNumberMatch = user.id_number && user.id_number.toLowerCase().includes(searchTerm);
                
                return nameMatch || idNumberMatch;
            });
            showUsersList(filteredUsers, searchTerm);
        } else {
            // اگر هنوز کاربران بارگذاری نشده‌اند، بارگذاری کنید
            loadAllUsers();
        }
    });
    
    // مخفی کردن لیست کاربران با کلیک بیرون از آن
    document.addEventListener('click', function(e) {
        const usersList = document.getElementById('telegramUsersList');
        const searchWrapper = document.querySelector('.telegram-search-wrapper');
        
        if (usersList && usersList.classList.contains('active') && 
            searchWrapper && !searchWrapper.contains(e.target)) {
            usersList.classList.remove('active');
        }
    });

    // ارسال پیام با کلیک روی دکمه ارسال
    sendButton.addEventListener('click', sendMessage);

    // ارسال پیام با کلیک روی دکمه ارسال
    sendButton.addEventListener('click', sendMessage);

    // ارسال پیام با کلید Enter
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // ================ توابع اصلی ================

    // تابع لاگ دیباگ
    function debugLog(...args) {
        if (false) { 
            //('[DEBUG]', ...args);
        }
    }
    
    // بارگذاری لیست تمام کاربران
    function loadAllUsers() {
        const usersList = document.getElementById('telegramUsersList');
        if (usersList) {
            usersList.innerHTML = `
                <div class="telegram-users-loading">
                    <i class="fa-solid fa-spinner fa-spin"></i> در حال بارگذاری کاربران...
                </div>
            `;
            usersList.classList.add('active');
        }
        
        // استفاده از API جدید برای دریافت لیست کاربران
        $.ajax({
            url: '/api/get-users',
            type: 'GET',
            success: function(response) {
              
                if (response.success && response.users) {
                    allUsers = response.users.map(user => ({
                        id: user.id,
                        name: user.name,
                        id_number:user.id_number
                    }));
                
                    debugLog(`${allUsers.length} کاربر یافت شد`);
                    
                    // نمایش لیست کاربران
                    showUsersList(allUsers);
                } else {
                    console.error('خطا در دریافت لیست کاربران:', response.error || 'خطای نامشخص');
                    
                    const usersList = document.getElementById('telegramUsersList');
                    if (usersList) {
                        usersList.innerHTML = `
                            <div class="telegram-no-users">
                                <i class="fa-solid fa-exclamation-circle"></i> خطا در بارگذاری لیست کاربران
                            </div>
                        `;
                    }
                }
            },
            error: function(error) {
                console.error('خطا در بارگذاری لیست کاربران:', error);
                
                const usersList = document.getElementById('telegramUsersList');
                if (usersList) {
                    usersList.innerHTML = `
                        <div class="telegram-no-users">
                            <i class="fa-solid fa-exclamation-circle"></i> خطا در بارگذاری لیست کاربران
                        </div>
                    `;
                }
            }
        });
    }
    
    // نمایش لیست کاربران
    function showUsersList(users, searchTerm = '') {
        const usersList = document.getElementById('telegramUsersList');
        if (!usersList) return;
        
        if (users.length === 0) {
            usersList.innerHTML = `
                <div class="telegram-no-users">
                    ${searchTerm ? `هیچ کاربری با عبارت «${searchTerm}» یافت نشد` : 'هیچ کاربری یافت نشد'}
                </div>
            `;
            return;
        }
        
        let html = '';
        users.forEach(user => {
            // استفاده از id_number اگر نام خالی است
            const displayName = user.name && user.name.trim() !== '' ? user.name : ( `کاربر ${user.id}`);
            
            // اولین حرف نام برای آواتار
            const firstChar = displayName.charAt(0);
            
            html += `
                <div class="telegram-user-item" data-id="${user.id}" data-name="${displayName}">
                    <div class="telegram-user-avatar">${firstChar}</div>
                    <div class="telegram-user-name">${displayName}</div>
                </div>
            `;
        });
        
        usersList.innerHTML = html;
        
        // اضافه کردن رویداد کلیک به آیتم‌های کاربر
        usersList.querySelectorAll('.telegram-user-item').forEach(item => {
            item.addEventListener('click', function() {
                const userId = this.dataset.id;
                const userName = this.dataset.name;
                
                // ایجاد یک گفتگوی جدید با کاربر انتخاب شده
                createNewConversation(userId, userName);
                
                // مخفی کردن لیست کاربران
                usersList.classList.remove('active');
                
                // پاک کردن فیلد جستجو
                searchInput.value = '';
            });
        });
    }
    
    // ایجاد گفتگوی جدید با کاربر انتخاب شده
    function createNewConversation(userId, userName) {
        debugLog(`ایجاد گفتگوی جدید با ${userName} (شناسه: ${userId})`);
        
        // بررسی آیا این گفتگو قبلاً وجود دارد
        let existingConversation = conversations.find(conv => 
            conv.name === userName || 
            conv.userId === userId ||
            (conv.messages.length > 0 && conv.messages.some(m => 
                (m.recipient_id && m.recipient_id.toString() === userId.toString()) || 
                (m.sender_id && m.sender_id.toString() === userId.toString())
            ))
        );
        
        if (existingConversation) {
            debugLog(`گفتگو با ${userName} از قبل وجود دارد با شناسه ${existingConversation.id}`);
            openConversation(existingConversation);
            return;
        }
        
        // ایجاد گفتگوی جدید
        const newConversation = {
            id: `conv-user-${userId}`,
            name: userName,
            userId: userId, // اضافه کردن شناسه کاربر به عنوان بخشی از گفتگو
            messages: [],
            lastMessageDate: '',
            lastMessageText: 'گفتگوی جدید',
            lastMessageIsReceived: false,
            hasUnread: false,
            isNew: true
        };
        
        // افزودن به لیست گفتگوها
        conversations.unshift(newConversation);
        
        // به‌روزرسانی نمایش گفتگوها
        renderConversations(conversations);
        
        // باز کردن گفتگوی جدید
        openConversation(newConversation);
        
        // تمرکز روی فیلد ورود پیام
        setTimeout(() => {
            messageInput.focus();
        }, 100);
    }

    // بارگذاری همه پیام‌ها (دریافتی و ارسالی)
    function loadAllMessages() {
        showLoading(conversationList);
        debugLog("شروع بارگذاری پیام‌ها...");
        
        // بارگذاری پیام‌های دریافتی
        loadReceivedMessages()
            .then(receivedMessages => {
                debugLog(`${receivedMessages.length} پیام دریافتی یافت شد`);
                
                // بارگذاری پیام‌های ارسالی
                return loadSentMessages().then(sentMessages => {
                    debugLog(`${sentMessages.length} پیام ارسالی یافت شد`);
                    return { received: receivedMessages, sent: sentMessages };
                });
            })
            .then(({ received, sent }) => {
                // ترکیب پیام‌های دریافتی و ارسالی
                processAllMessages(received, sent);
            })
            .catch(error => {
                console.error('خطا در بارگذاری پیام‌ها:', error);
                // به جای نمایش داده‌های نمونه، یک لیست خالی نمایش می‌دهیم
                conversations = [];
                renderConversations(conversations);
                updateNotificationBadge(0);
            });
    }

    // بارگذاری پیام‌های دریافتی
    function loadReceivedMessages() {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '/api/received-messages',
                type: 'GET',
                success: function(response) {
                    debugLog('داده‌های پیام‌های دریافتی با موفقیت بارگذاری شد');
                    // تنظیم تعداد پیام‌های خوانده نشده در نشانگر اطلاع‌رسانی
                    updateNotificationBadge(response.unread_count);
                    const messages = response.messages.map(msg => {
                        // اگر scheduled_time نداشت، created_at را جایگزین کن
                        let date = msg.scheduled_time || msg.created_at;
                        if (!date || date === 'null' || date === null) {
                            date = msg.created_at;
                        }
                        return {
                            id: msg.id.toString(),
                            sender: msg.sender,
                            sender_id: msg.sender_id || null, // ذخیره شناسه فرستنده
                            subject: msg.subject || 'بدون موضوع',
                            body: msg.body || '',
                            date: date,
                            type: 'received',
                            is_read: msg.is_read,
                            attachments: msg.attachments || []
                        };
                    });
                    debugLog(`${messages.length} پیام دریافتی پردازش شد`);
                    resolve(messages);
                },
                error: function(error) {
                    console.error('خطا در بارگذاری پیام‌های دریافتی:', error);
                    reject(error);
                }
            });
        });
    }

    // بارگذاری پیام‌های ارسالی
    function loadSentMessages() {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '/api/sent-messages',
                type: 'GET',
                success: function(response) {
                

                    const messages = [];
                    response.messages.forEach(msg => {
                 
                        let date = msg.scheduled_time || msg.created_at;
                        if (!date || date === 'null' || date === null) {
                            date = msg.created_at;
                        }
                        
                        // استاندارد کردن فیلد ضمیمه‌ها
                        let attachments = [];
                        if (msg.attachments && Array.isArray(msg.attachments)) {
                            attachments = msg.attachments;
                        } else if (msg.attachment) {
                            // تبدیل attachment به آرایه attachments
                            if (Array.isArray(msg.attachment)) {
                                attachments = msg.attachment;
                            } else if (typeof msg.attachment === 'object') {
                                attachments = [msg.attachment];
                            }
                        }
                        
                        if (msg.recipients && msg.recipients.length > 0) {
                            msg.recipients.forEach(recipient => {
                                messages.push({
                                    id: msg.id.toString(),
                                    recipient: recipient.name ||recipient.id.number,
                                    recipient_id: recipient.id,
                                    recipient_id_number:recipient.id.number,
                                    subject: msg.subject || 'بدون موضوع',
                                    body: msg.body || '',
                                    date: date,
                                    type: 'sent',
                                    seen_by: msg.seen_by || [],
                                    scheduled_time: msg.scheduled_time || null,
                                    attachments: attachments // استفاده از آرایه استاندارد شده
                                });
                            });
                        } else {
                            messages.push({
                                id: msg.id.toString(),
                                recipient: 'نامشخص',
                                recipient_id: 0,
                                subject: msg.subject || 'بدون موضوع',
                                body: msg.body || '',
                                date: date,
                                type: 'sent',
                                seen_by: msg.seen_by || [],
                                scheduled_time: msg.scheduled_time || null,
                                attachments: attachments // استفاده از آرایه استاندارد شده
                            });
                        }
                    });
                    debugLog(`${messages.length} پیام ارسالی پردازش شد`);
                    resolve(messages);
                },
                error: function(error) {
                    console.error('خطا در بارگذاری پیام‌های ارسالی:', error);
                    reject(error);
                }
            });
        });
    }

    // پردازش و گروه‌بندی همه پیام‌ها
    function processAllMessages(receivedMessages, sentMessages) {
        // ترکیب همه پیام‌ها
        debugLog(`پردازش ${receivedMessages.length} پیام دریافتی و ${sentMessages.length} پیام ارسالی`);
        
        if (receivedMessages.length === 0 && sentMessages.length === 0) {
            debugLog('هیچ پیامی یافت نشد - نمایش لیست خالی');
            // به جای نمایش داده‌های نمونه، یک لیست خالی نمایش می‌دهیم
            conversations = [];
            renderConversations(conversations);
            updateNotificationBadge(0);
            return;
        }
        
        // گروه‌بندی پیام‌ها براساس فرد (ایجاد گفتگوها)
        const conversationMap = {};
        
        // پردازش پیام‌های دریافتی
        receivedMessages.forEach(message => {
            const { id, sender, sender_id, subject, body, date, is_read, attachments } = message;

            // تبدیل تاریخ به شمسی
            const jalaliDate = toJalaliDate(date);
            
            // نرمال‌سازی نام فرستنده - با بررسی وجود مقدار
            const displayName = sender && sender.trim() !== '' ? sender : (sender_id ? `کاربر ${sender_id}` : 'نامشخص');
            const normalizedSender = displayName.replace(/،\s*$/, '').trim();
            
            // ایجاد گفتگو اگر وجود ندارد
            if (!conversationMap[normalizedSender]) {
                let convId = sender_id ? `conv-user-${sender_id}` : `conv-${normalizedSender.replace(/\s+/g, '-')}`;
           
                // بررسی دقیق وجود فایل ضمیمه
                const hasAttachment = Array.isArray(attachments) && attachments.length > 0;
                
                conversationMap[normalizedSender] = {
                    id: convId,
                    name: normalizedSender,
                    userId: sender_id, // ذخیره شناسه فرستنده
                    messages: [],
                    lastMessageDate: jalaliDate,
                    lastMessageText: body || (hasAttachment ? (attachments[0].file_type === 'image' ? '🖼️ تصویر' : 
                                    attachments[0].file_type === 'video' ? '🎬 ویدیو' : 
                                    attachments[0].file_type === 'audio' ? '🎵 فایل صوتی' : 
                                    '📎 فایل ضمیمه') : subject),
                    lastMessageIsReceived: true,
                    hasUnread: is_read === false // وضعیت خوانده نشده بر اساس فیلد is_read تعیین می‌شود
                };
            } else if (sender_id && !conversationMap[normalizedSender].userId) {
                // اگر گفتگو وجود دارد اما شناسه کاربر ذخیره نشده، آن را ذخیره کنیم
                conversationMap[normalizedSender].userId = sender_id;
                
                // به‌روزرسانی ID گفتگو با استفاده از شناسه کاربر
                conversationMap[normalizedSender].id = `conv-user-${sender_id}`;
            }
            
            // افزودن پیام به گفتگو
            conversationMap[normalizedSender].messages.push({
                id: id,
                sender_id: sender_id, // ذخیره شناسه فرستنده در پیام
                subject: subject,
                body: body || '',
                date: jalaliDate || '',
                isReceived: true,
                is_read: is_read, // افزودن وضعیت خوانده شدن به پیام
                attachments: attachments || [] // اضافه کردن ضمیمه‌ها به پیام
            });
            
            // به‌روزرسانی وضعیت hasUnread گفتگو - اگر حداقل یک پیام خوانده نشده باشد، کل گفتگو خوانده نشده محسوب می‌شود
            if (is_read === false) {
                conversationMap[normalizedSender].hasUnread = true;
            }
            
            // به‌روزرسانی آخرین تاریخ و متن پیام اگر این پیام جدیدتر است
            if (date && (!conversationMap[normalizedSender].lastMessageDate || isNewer(jalaliDate, conversationMap[normalizedSender].lastMessageDate))) {
                // بررسی دقیق وجود فایل ضمیمه
                const hasAttachment = Array.isArray(attachments) && attachments.length > 0;
                
                conversationMap[normalizedSender].lastMessageDate = jalaliDate;
                if (body) {
                    conversationMap[normalizedSender].lastMessageText = body;
                } else if (hasAttachment) {
                    // استخراج پسوند فایل برای نمایش
                    const attachment = attachments[0];
                    let extension = '';
                    if (attachment.file_name) {
                        const parts = attachment.file_name.split('.');
                        if (parts.length > 1) {
                            extension = parts.pop().toLowerCase();
                        }
                    }
                    
                    // تعیین نوع فایل با پسوند
                    const fileType = attachment.file_type || '';
                    if (fileType === 'image') {
                        conversationMap[normalizedSender].lastMessageText = `🖼️ تصویر${extension ? ` (${extension})` : ''}`;
                    } else if (fileType === 'video') {
                        conversationMap[normalizedSender].lastMessageText = `🎬 ویدیو${extension ? ` (${extension})` : ''}`;
                    } else if (fileType === 'audio') {
                        if (extension === 'wav') {
                            conversationMap[normalizedSender].lastMessageText = `🎤 پیام صوتی${extension ? ` (${extension})` : ''}`;
                        } else {
                            conversationMap[normalizedSender].lastMessageText = `🎵 فایل صوتی${extension ? ` (${extension})` : ''}`;
                        }
                    } else if (fileType === 'pdf') {
                        conversationMap[normalizedSender].lastMessageText = '📄 فایل PDF';
                    } else if (fileType === 'doc' || fileType === 'docx') {
                        conversationMap[normalizedSender].lastMessageText = `📝 فایل Word${extension ? ` (${extension})` : ''}`;
                    } else if (fileType === 'xls' || fileType === 'xlsx') {
                        conversationMap[normalizedSender].lastMessageText = `📊 فایل Excel${extension ? ` (${extension})` : ''}`;
                    } else {
                        conversationMap[normalizedSender].lastMessageText = `📎 فایل${extension ? ` (${extension})` : ' ضمیمه'}`;
                    }
                } else {
                    conversationMap[normalizedSender].lastMessageText = subject;
                }
                conversationMap[normalizedSender].lastMessageIsReceived = true;
            }
        });
        
        // پردازش پیام‌های ارسالی
        sentMessages.forEach(message => {
            const { id, recipient, recipient_id, subject, body, date, seen_by, attachments } = message;
      
            // تبدیل تاریخ به شمسی
            const jalaliDate = toJalaliDate(date);
            
            // نرمال‌سازی نام گیرنده - با بررسی وجود مقدار
            const displayName = recipient && recipient.trim() !== '' ? recipient : (recipient_id ? `کاربر ${recipient_id}` : 'نامشخص');
            const normalizedRecipient = displayName.replace(/،\s*$/, '').trim();
            
            // ایجاد گفتگو اگر وجود ندارد
            if (!conversationMap[normalizedRecipient]) {
                let convId = recipient_id ? `conv-user-${recipient_id}` : `conv-${normalizedRecipient.replace(/\s+/g, '-')}`;
                
                // بررسی دقیق وجود فایل ضمیمه
                const hasAttachment = Array.isArray(attachments) && attachments.length > 0;
               
                conversationMap[normalizedRecipient] = {
                    id: convId,
                    name: normalizedRecipient,
                    userId: recipient_id, // ذخیره شناسه گیرنده
                    messages: [],
                    lastMessageDate: jalaliDate,
                    lastMessageText: body || (hasAttachment ? (attachments[0].file_type === 'image' ? '🖼️ تصویر' : 
                                    attachments[0].file_type === 'video' ? '🎬 ویدیو' : 
                                    attachments[0].file_type === 'audio' ? '🎵 فایل صوتی' : 
                                    '📎 فایل ضمیمه') : subject),
                    lastMessageIsReceived: false,
                    hasUnread: false, // پیام‌های ارسالی خوانده شده هستند
                    readStatus: seen_by && seen_by.length > 0 ? 'read' : 'sent'
                };
            } else if (recipient_id && !conversationMap[normalizedRecipient].userId) {
                // اگر گفتگو وجود دارد اما شناسه کاربر ذخیره نشده، آن را ذخیره کنیم
                conversationMap[normalizedRecipient].userId = recipient_id;
                
                // به‌روزرسانی ID گفتگو با استفاده از شناسه کاربر
                conversationMap[normalizedRecipient].id = `conv-user-${recipient_id}`;
            }
            
            // افزودن پیام به گفتگو
            conversationMap[normalizedRecipient].messages.push({
                id: id,
                recipient_id: recipient_id, // ذخیره شناسه گیرنده در پیام
                subject: subject,
                body: body || '',
                date: jalaliDate || '',
                isReceived: false,
                seen_by: seen_by || [], // اطلاعات خوانده شدن
                scheduled_time: message.scheduled_time,
                attachments: attachments || [] // اضافه کردن ضمیمه‌ها به پیام
            });
            
            // به‌روزرسانی آخرین تاریخ و متن پیام اگر این پیام جدیدتر است
            if (date && (!conversationMap[normalizedRecipient].lastMessageDate || isNewer(jalaliDate, conversationMap[normalizedRecipient].lastMessageDate))) {
                // بررسی دقیق وجود فایل ضمیمه
                const hasAttachment = Array.isArray(attachments) && attachments.length > 0;
                
                conversationMap[normalizedRecipient].lastMessageDate = jalaliDate;
                if (body) {
                    conversationMap[normalizedRecipient].lastMessageText = body;
                } else if (hasAttachment) {
                    // استخراج پسوند فایل برای نمایش
                    const attachment = attachments[0];
                    let extension = '';
                    if (attachment.file_name) {
                        const parts = attachment.file_name.split('.');
                        if (parts.length > 1) {
                            extension = parts.pop().toLowerCase();
                        }
                    }
                    
                    // تعیین نوع فایل با پسوند
                    const fileType = attachment.file_type || '';
                    if (fileType === 'image') {
                        conversationMap[normalizedRecipient].lastMessageText = `🖼️ تصویر${extension ? ` (${extension})` : ''}`;
                    } else if (fileType === 'video') {
                        conversationMap[normalizedRecipient].lastMessageText = `🎬 ویدیو${extension ? ` (${extension})` : ''}`;
                    } else if (fileType === 'audio') {
                        if (extension === 'wav') {
                            conversationMap[normalizedRecipient].lastMessageText = `🎤 پیام صوتی${extension ? ` (${extension})` : ''}`;
                        } else {
                            conversationMap[normalizedRecipient].lastMessageText = `🎵 فایل صوتی${extension ? ` (${extension})` : ''}`;
                        }
                    } else if (fileType === 'pdf') {
                        conversationMap[normalizedRecipient].lastMessageText = '📄 فایل PDF';
                    } else if (fileType === 'doc' || fileType === 'docx') {
                        conversationMap[normalizedRecipient].lastMessageText = `📝 فایل Word${extension ? ` (${extension})` : ''}`;
                    } else if (fileType === 'xls' || fileType === 'xlsx') {
                        conversationMap[normalizedRecipient].lastMessageText = `📊 فایل Excel${extension ? ` (${extension})` : ''}`;
                    } else {
                        conversationMap[normalizedRecipient].lastMessageText = `📎 فایل${extension ? ` (${extension})` : ' ضمیمه'}`;
                    }
                } else {
                    conversationMap[normalizedRecipient].lastMessageText = subject;
                }
                conversationMap[normalizedRecipient].lastMessageIsReceived = false;
                conversationMap[normalizedRecipient].readStatus = seen_by && seen_by.length > 0 ? 'read' : 'sent';
            }
        });
        
        // تبدیل نقشه به آرایه
        conversations = Object.values(conversationMap);
        
        // لاگ کردن نام گفتگوها و شناسه کاربران برای دیباگ
        const conversationSummary = conversations.map(c => ({
            name: c.name,
            id: c.id,
            userId: c.userId || 'نامشخص'
        }));
        debugLog(`${conversations.length} گفتگو ایجاد شد:`, conversationSummary);
        
        // مرتب‌سازی پیام‌ها در هر گفتگو براساس شناسه (تقریباً براساس زمان)
        conversations.forEach(conversation => {
            conversation.messages.sort((a, b) => parseInt(a.id) - parseInt(b.id));
        });
        
        // مرتب‌سازی گفتگوها: ابتدا پیام‌های خوانده نشده، سپس براساس تاریخ (جدیدترین اول)
        conversations.sort((a, b) => {
            // ابتدا بر اساس خوانده نشده‌ها مرتب می‌کنیم
            if (a.hasUnread && !b.hasUnread) return -1;
            if (!a.hasUnread && b.hasUnread) return 1;
            
            // آخرین پیام هر گفتگو را بدون فیلتر کردن پیام‌های زمان‌بندی شده پیدا می‌کنیم
            const lastMessageA = a.messages.length > 0 ? a.messages[a.messages.length - 1] : null;
            const lastMessageB = b.messages.length > 0 ? b.messages[b.messages.length - 1] : null;
            
            // اگر پیام معتبری نداشتیم، آن گفتگو را در آخر قرار دهیم
            if (!lastMessageA) return 1;
            if (!lastMessageB) return -1;
            
            // سپس بر اساس تاریخ آخرین پیام
            const dateA = lastMessageA.date ? convertPersianDateToNumber(lastMessageA.date) : 0;
            const dateB = lastMessageB.date ? convertPersianDateToNumber(lastMessageB.date) : 0;
            
            return dateB - dateA; // نزولی - جدیدترین اول
        });
        
        // شمارش پیام‌های خوانده نشده
        unreadCount = conversations.filter(c => c.hasUnread).length;
        updateNotificationBadge(unreadCount);
        
        // نمایش گفتگوها
        renderConversations(conversations);
        
        // نمایش تعداد پیام‌های خوانده نشده
        showUnreadCount();
    }
        
    // تبدیل تاریخ فارسی به عدد برای مقایسه
    function convertPersianDateToNumber(persianDate) {
        // اگر تاریخ تعریف نشده یا خالی است، عدد صفر برگردان
        if (!persianDate) return 0;
        
        // تبدیل اعداد فارسی به انگلیسی
        const toEnglishDigits = str => str.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d));
        const englishDate = toEnglishDigits(persianDate);
        
        // تلاش برای تطبیق تاریخ کامل (مثال: 1402/12/25 14:30)
        const fullDateMatch = englishDate.match(/(\d{4})\/(\d{1,2})\/(\d{1,2}) (\d{1,2}):(\d{2})/);
        if (fullDateMatch) {
            const year = parseInt(fullDateMatch[1]);
            const month = parseInt(fullDateMatch[2]);
            const day = parseInt(fullDateMatch[3]);
            const hour = parseInt(fullDateMatch[4]);
            const minute = parseInt(fullDateMatch[5]);
            
            return year * 10000000000 + month * 100000000 + day * 1000000 + hour * 100 + minute;
        }
        
        // تلاش برای تطبیق تاریخ بدون ساعت (مثال: 1402/12/25)
        const dateMatch = englishDate.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})/);
        if (dateMatch) {
            return parseInt(dateMatch[1]) * 10000 + parseInt(dateMatch[2]) * 100 + parseInt(dateMatch[3]);
        }
        
        // تلاش برای تطبیق زمان (مثال: 14:30)
        const timeMatch = englishDate.match(/(\d{1,2}):(\d{2})/);
        if (timeMatch) {
            return parseInt(timeMatch[1]) * 60 + parseInt(timeMatch[2]);
        }
        
        // اگر هیچ الگویی تطبیق نداشت، مقدار پیش‌فرض برگردان
        return 0;
    }

    // آیا تاریخ اول جدیدتر از تاریخ دوم است؟
    function isNewer(date1, date2) {
        if (!date1 || !date2) return false;
        
        const value1 = convertPersianDateToNumber(date1);
        const value2 = convertPersianDateToNumber(date2);
        
        return value1 > value2;
    }

    // تابع بررسی اینکه آیا تاریخ در آینده است
    function isInFuture(jalaliDateStr) {
        if (!jalaliDateStr) return false;
        
        try {
            // استفاده از تابع parseJalaliDate برای تبدیل تاریخ شمسی به میلادی
            const dateObj = parseJalaliDate(jalaliDateStr);
            if (!dateObj) return false;
            
            // مقایسه با زمان فعلی
            const now = new Date();
            
            //('تاریخ مورد بررسی:', jalaliDateStr, 'تبدیل شده به:', dateObj, 'زمان فعلی:', now);
            
            return dateObj > now;
        } catch (error) {
            console.error('خطا در تبدیل تاریخ:', error);
            return false;
        }
    }

    // باز کردن گفتگو و نمایش پیام‌ها
    function openConversation(conversation) {

        activeConversation = conversation;
        chatTitle.textContent = conversation.name;
        chatContainer.classList.add('telegram-container-active');
        
        // اطمینان از ذخیره شناسه کاربر در گفتگوی فعال
        if (!activeConversation.userId && conversation.name && allUsers.length > 0) {
            // جستجو در لیست کاربران موجود
            const foundUser = allUsers.find(user => user.name === conversation.name );
            if (foundUser) {
             
                activeConversation.userId = foundUser.id;
                
                // به‌روزرسانی شناسه در لیست گفتگوها نیز
                const convIndex = conversations.findIndex(c => c.id === conversation.id);
                if (convIndex !== -1) {
                    conversations[convIndex].userId = foundUser.id;
                }
            }
        }
        
        // اگر گفتگوی جدید است (با جستجوی کاربر ایجاد شده)
        if (conversation.isNew) {
            chatBody.innerHTML = `
                <div class="telegram-empty-message">
                    هنوز پیامی رد و بدل نشده است. پیام خود را بنویسید و ارسال کنید.
                </div>
            `;
            // تمرکز روی فیلد ورود پیام
            setTimeout(() => {
                messageInput.focus();
            }, 100);
            return;
        }
        
        showLoading(chatBody);
        
        // اگر پیام خوانده نشده دارد، آن‌ها را به عنوان خوانده شده علامت بزن
        if (conversation.hasUnread) {
            debugLog(`گفتگو با ${conversation.name} دارای پیام‌های خوانده نشده است`);
            
            // یافتن تمام پیام‌های خوانده نشده
            const unreadMessages = conversation.messages.filter(msg => 
                msg.isReceived && (typeof msg.is_read === 'undefined' || msg.is_read === false)
            );
            
            debugLog(`تعداد ${unreadMessages.length} پیام خوانده نشده در این گفتگو وجود دارد`);
            
            // علامت‌گذاری هر پیام به عنوان خوانده شده
            unreadMessages.forEach(msg => {
                markMessageAsSeen(msg.id);
                // به‌روزرسانی وضعیت محلی پیام
                msg.is_read = true;
            });
            
            // به‌روزرسانی وضعیت گفتگو
            conversation.hasUnread = false;
            
            // به‌روزرسانی نشانگر اطلاع‌رسانی
            showUnreadCount();
            
            // به‌روزرسانی نمایش گفتگوها
                renderConversations(conversations);
        }
        
        // بارگذاری محتوای پیام‌ها
        loadConversationMessages(conversation, true); // پارامتر true برای forceReload
    }
    
    // علامت‌گذاری پیام به عنوان خوانده شده
    function markMessageAsSeen(messageId) {
        // اضافه کردن لاگ دیباگ
        debugLog(`علامت‌گذاری پیام ${messageId} به عنوان خوانده شده...`);
        
        // ارسال درخواست به API برای علامت‌گذاری پیام به عنوان خوانده شده
        $.ajax({
            url: `/api/mark-message-seen/${messageId}`,
            type: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                debugLog(`پیام با شناسه ${messageId} به عنوان خوانده شده علامت‌گذاری شد`);
                
                // به‌روزرسانی وضعیت محلی پیام
                if (activeConversation) {
                    const message = activeConversation.messages.find(m => m.id === messageId);
                    if (message) {
                        message.is_read = true;
                    }
                }
            },
            error: function(error) {
                console.error(`خطا در علامت‌گذاری پیام ${messageId} به عنوان خوانده شده:`, error);
            }
        });
        }

    // بارگذاری محتوای پیام‌های یک گفتگو
    function loadConversationMessages(conversation, forceReload = false) {
        const messageIds = conversation.messages.map(m => m.id);
        activeMessages = [];
        
        // برای پیام‌های نمونه
        if (conversation.id.startsWith('sample-')) {
            const sampleMessages = [
                {
                    id: `${conversation.id}-1`,
                    subject: 'پیام نمونه',
                    body: `این یک پیام نمونه از ${conversation.name} است`,
                    date: '۱۴۰۳/۳/۱۵',
                    isReceived: true,
                    seen_by: []
                }
            ];
            renderMessages(sampleMessages);
                return;
            }
            
        debugLog(`بارگذاری ${messageIds.length} پیام برای گفتگو با ${conversation.name}`);
        
        // اگر forceReload فعال است یا بعد از ارسال پیام هستیم، مستقیماً از API بارگذاری کنیم
        // در غیر این صورت، از کش محلی استفاده کنیم
        if (forceReload || messageIds.some(id => id.toString().startsWith('temp-'))) {
            // بارگذاری مجدد پیام‌ها از API
            // ابتدا پیام‌های دریافتی را بارگذاری می‌کنیم
            $.ajax({
                url: '/api/received-messages',
                type: 'GET',
                async: true,
                success: function(receivedResponse) {
                    const receivedMessages = receivedResponse.messages.filter(msg => {
                        // فیلتر کردن پیام‌های مربوط به این گفتگو
                        return msg.sender === conversation.name || 
                               (msg.sender_id && msg.sender_id.toString() === conversation.userId?.toString());
                    });
                    
                    // سپس پیام‌های ارسالی را بارگذاری می‌کنیم
                    $.ajax({
                        url: '/api/sent-messages',
                        type: 'GET',
                        async: true,
                        success: function(sentResponse) {
                            const sentMessages = [];
                            sentResponse.messages.forEach(msg => {
                                if (msg.recipients && msg.recipients.length > 0) {
                                    // بررسی می‌کنیم آیا این پیام به کاربر فعلی ارسال شده است
                                    const isForCurrentUser = msg.recipients.some(recipient => 
                                        recipient.name === conversation.name || 
                                        (recipient.id && recipient.id.toString() === conversation.userId?.toString())
                                    );
                                    
                                    if (isForCurrentUser) {
                                        sentMessages.push(msg);
                                    }
                                }
                            });
                            
                            // ترکیب پیام‌های دریافتی و ارسالی
                            const allMessages = [...receivedMessages, ...sentMessages];
                            
                            // مرتب‌سازی پیام‌ها بر اساس ID (تقریباً بر اساس زمان)
                            allMessages.sort((a, b) => parseInt(a.id) - parseInt(b.id));
                            
                            // پردازش پیام‌ها و نمایش آن‌ها
                            const processedMessages = allMessages.map(msg => {
                                // تعیین نوع پیام (دریافتی یا ارسالی)
                                const isReceived = receivedMessages.includes(msg);
                                
                                // تبدیل تاریخ به شمسی
                                const jalaliDate = toJalaliDate(msg.scheduled_time || msg.created_at);
                                
                                // تعیین وضعیت ارسال پیام
                                let is_sent = true;
                                if (msg.scheduled_time) {
                                    // اگر پیام زمانبندی شده است، بررسی کنیم آیا زمان آن رسیده است
                                    const scheduledDate = new Date(msg.scheduled_time);
                                    const now = new Date();
                                    is_sent = scheduledDate <= now && msg.status !== 'pending';
                                }
                                
                                return {
                                    id: msg.id.toString(),
                                    subject: msg.subject || 'بدون موضوع',
                                    body: msg.body || '',
                                    date: jalaliDate,
                                    isReceived: isReceived,
                                    seen_by: msg.seen_by || [],
                                    scheduled_time: msg.scheduled_time,
                                    is_sent: is_sent,
                                    attachments: msg.attachments || []
                                };
                            });
                            
                            // ذخیره پیام‌ها در متغیر activeMessages
                            activeMessages = processedMessages;
                            
                            // نمایش پیام‌ها
                            renderMessages(activeMessages);
                            
                            // اسکرول به پایین پنجره چت
                            setTimeout(() => {
                                chatBody.scrollTop = chatBody.scrollHeight;
                            }, 100);
                        },
                        error: function(error) {
                            console.error('خطا در بارگذاری پیام‌های ارسالی:', error);
                            // در صورت خطا، از پیام‌های موجود استفاده می‌کنیم
                            loadMessagesFromCache();
                        }
                    });
                },
                error: function(error) {
                    console.error('خطا در بارگذاری پیام‌های دریافتی:', error);
                    // در صورت خطا، از پیام‌های موجود استفاده می‌کنیم
                    loadMessagesFromCache();
                }
            });
        } else {
            // بارگذاری از کش محلی
            loadMessagesFromCache();
        }
        
        // تابع کمکی برای بارگذاری پیام‌ها از کش محلی
        function loadMessagesFromCache() {
            // بارگذاری همزمان تمام پیام‌ها با استفاده از API جدید
            const loadPromises = messageIds.map(messageId => {
                return new Promise((resolve) => {
                    $.ajax({
                        url: `/api/message/${messageId}`,
                        type: 'GET',
                        success: function(response) {
                            debugLog(`پیام با شناسه ${messageId} دریافت شد`);
                            
                            // یافتن پیام در لیست گفتگو
                            const messageInfo = conversation.messages.find(m => m.id === messageId);
                            const isReceived = messageInfo ? messageInfo.isReceived : true;
                            
                            // استخراج اطلاعات پیام از JSON
                            const msg = response.message;
                            
                            // تبدیل تاریخ به شمسی
                            const jalaliDate = toJalaliDate(msg.scheduled_time || msg.created_at);
                            
                            // استخراج اطلاعات کاربرانی که پیام را خوانده‌اند
                            const seen_by = msg.seen_by || [];
                            
                            // تعیین وضعیت ارسال پیام
                            let is_sent = true;
                            if (msg.scheduled_time) {
                                // اگر پیام زمانبندی شده است، بررسی کنیم آیا زمان آن رسیده است
                                const scheduledDate = new Date(msg.scheduled_time);
                                const now = new Date();
                                is_sent = scheduledDate <= now && msg.status !== 'pending';
                            }
                            
                            // بررسی و استخراج ضمیمه‌ها
                            let attachments = [];
                            let hasAttachment = false;
                            
                            if (msg.attachments && msg.attachments.length > 0) {
                                hasAttachment = true;
                                attachments = msg.attachments.map(attachment => {
                                    // استخراج نام اصلی فایل
                                    let originalFileName = attachment.file_name || attachment.name || attachment.original_name || '';
                                    if (attachment.file_url) {
                                        // استخراج نام فایل از URL اگر نام فایل در دسترس نباشد
                                        const urlParts = attachment.file_url.split('/');
                                        const fileNameFromUrl = urlParts[urlParts.length - 1].split('?')[0];
                                        if (!originalFileName && fileNameFromUrl) {
                                            originalFileName = decodeURIComponent(fileNameFromUrl);
                                        }
                                    }
                                    
                                    // تشخیص نوع فایل
                                    const fileType = attachment.file_type || determineFileType(originalFileName);
                                    
                                    return {
                                        file_name: originalFileName || 'فایل ضمیمه',
                                        file_url: attachment.file_url || attachment.url || '',
                                        file_type: fileType
                                    };
                                });
                                
                                // به‌روزرسانی اطلاعات ضمیمه در پیام اصلی در گفتگو
                                if (messageInfo) {
                                    messageInfo.hasAttachment = true;
                                    messageInfo.fileType = attachments[0].file_type;
                                    messageInfo.fileName = attachments[0].file_name;
                                    messageInfo.attachments = attachments;
                                    messageInfo.seen_by = seen_by; // افزودن اطلاعات خوانده شدن
                                    
                                    
                                    // اگر پیام بدون متن است و این آخرین پیام گفتگو است، نوع فایل را نمایش بده
                                    if ((!msg.body || msg.body.trim() === '') && 
                                        conversation.messages[conversation.messages.length - 1].id === messageId) {
                                        
                                        // متن مناسب برای نوع فایل
                                        let attachmentText = '📎 فایل ضمیمه';
                                        const fileType = attachments[0].file_type;
                                        const fileName = attachments[0].file_name || '';
                                        
                                        if (fileType === 'image') {
                                            attachmentText = '🖼️ تصویر';
                                        } else if (fileType === 'video') {
                                            attachmentText = '🎬 ویدیو';
                                        } else if (fileType === 'audio') {
                                            if (fileName && (fileName.includes('voice_message') || fileName.includes('_voice_'))) {
                                                attachmentText = '🎤 پیام صوتی';
                                            } else {
                                                attachmentText = '🎵 فایل صوتی';
                                            }
                                        } else if (fileType === 'pdf') {
                                            attachmentText = '📄 فایل PDF';
                                        } else if (fileType === 'doc') {
                                            attachmentText = '📝 سند متنی';
                                        } else if (fileType === 'excel') {
                                            attachmentText = '📊 فایل اکسل';
                                        } else if (fileType === 'presentation') {
                                            attachmentText = '📊 فایل ارائه';
                                        } else if (fileType === 'archive') {
                                            attachmentText = '📦 فایل فشرده';
                                        }
                                        
                                        conversation.lastMessageText = attachmentText;
                                   
                                        // به‌روزرسانی نمایش گفتگوها
                                        renderConversations(conversations);
                                    }
                                }
                            }
                            
                            // افزودن پیام به لیست پیام‌های فعال
                            activeMessages.push({
                                id: messageId,
                                subject: msg.subject || 'بدون موضوع',
                                body: msg.body || '',
                                date: jalaliDate,
                                isReceived: isReceived,
                                hasAttachment: hasAttachment,
                                attachments: attachments,
                                seen_by: seen_by, // افزودن اطلاعات خوانده شدن
                                scheduled_time: msg.scheduled_time, // افزودن زمان زمانبندی شده
                                is_sent: is_sent // افزودن وضعیت ارسال پیام
                            });
                            
                            resolve();
                        },
                        error: function(error) {
                            console.error(`خطا در بارگذاری پیام ${messageId}:`, error);
                            
                            // در صورت خطا، از اطلاعات موجود در لیست گفتگو استفاده می‌کنیم
                            const messageInfo = conversation.messages.find(m => m.id === messageId);
                            if (messageInfo) {
                                activeMessages.push({
                                    id: messageId,
                                    subject: messageInfo.subject || 'بدون موضوع',
                                    body: messageInfo.body || '',
                                    date: messageInfo.date || '',
                                    isReceived: messageInfo.isReceived,
                                    hasAttachment: messageInfo.hasAttachment || false,
                                    fileType: messageInfo.fileType || '',
                                    fileName: messageInfo.fileName || '',
                                    attachments: messageInfo.attachments || [], // از اطلاعات قبلی استفاده کن
                                    scheduled_time: messageInfo.scheduled_time // افزودن زمان زمانبندی شده
                                });
                            }
                            
                            resolve();
                        }
                    });
                });
            });
            
            // انتظار برای بارگذاری تمام پیام‌ها
            Promise.all(loadPromises).then(() => {
                // مرتب‌سازی پیام‌ها براساس شناسه (به‌طور تقریبی براساس زمان)
                activeMessages.sort((a, b) => parseInt(a.id) - parseInt(b.id));
                
                debugLog(`${activeMessages.length} پیام برای گفتگو با ${conversation.name} آماده نمایش است`);
                
                // نمایش پیام‌ها
                renderMessages(activeMessages);
                
                // اسکرول به پایین پنجره چت
                setTimeout(() => {
                    chatBody.scrollTop = chatBody.scrollHeight;
                }, 100);
            });
        }
    }

    // ارسال پیام
    function sendMessage() {
        // بررسی اگر پنل زمانبندی باز است و تاریخ انتخاب نشده
        const schedulePanel = document.getElementById('schedulePanel');
        
        // اگر پنل زمانبندی باز است اما تاریخ انتخاب نشده
        if (schedulePanel && schedulePanel.style.display !== 'none' && !window.scheduledTime) {
            alert('لطفاً تاریخ ارسال پیام را انتخاب کنید.');
            return;
        }

        // دریافت متن پیام - اصلاح شده
        const messageInput = document.getElementById('telegramInput');
        const message = messageInput.value.trim();
        
        // تعریف متغیر attachments به عنوان آرایه خالی
        let attachments = [];
        
        // بررسی وجود گیرنده
        let recipientId = null;
        
        // روش‌های مختلف برای یافتن شناسه گیرنده
        if (activeConversation && activeConversation.userId) {
            // استفاده از شناسه کاربر ذخیره شده در گفتگوی فعال
            recipientId = activeConversation.userId;
        } else if (activeConversation && activeConversation.messages && activeConversation.messages.length > 0) {
            // استفاده از شناسه فرستنده یا گیرنده در پیام‌های قبلی
            const firstMessage = activeConversation.messages[0];
            if (firstMessage.sender_id && firstMessage.sender_id !== currentUser.id) {
                recipientId = firstMessage.sender_id;
            } else if (firstMessage.recipients && firstMessage.recipients.length > 0) {
                // استفاده از شناسه اولین گیرنده
                recipientId = firstMessage.recipients[0].id;
            }
        } else if (activeConversation && activeConversation.id) {
            // استخراج شناسه کاربر از شناسه گفتگو
            const conversationParts = activeConversation.id.split('_');
            if (conversationParts.length === 2) {
                const id1 = parseInt(conversationParts[0]);
                const id2 = parseInt(conversationParts[1]);
                
                // شناسه کاربری که خودمان نیستیم
                recipientId = id1 === currentUser.id ? id2 : id1;
            }
        }
        
        // اگر هنوز شناسه گیرنده پیدا نشده، از لیست کاربران بارگذاری کنیم
        if (!recipientId && activeConversation && activeConversation.name) {
            // بارگذاری لیست کاربران
            $.ajax({
                url: '/api/users',
                type: 'GET',
                async: false, // منتظر پاسخ می‌مانیم
                success: function(data) {
                    // جستجو برای کاربر با نام مشابه
                    const user = data.users.find(u => 
                        u.full_name === activeConversation.name || 
                        u.username === activeConversation.name
                    );
                    
                    if (user) {
                        recipientId = user.id;
                    }
                }
            });
        }
        
        // اگر گیرنده مشخص نشده، نمی‌توانیم پیام ارسال کنیم
        if (!recipientId) {
            alert('لطفاً گیرنده پیام را مشخص کنید.');
            return;
        }
        
        // اگر پیام خالی است و فایلی هم انتخاب نشده، نمی‌توانیم پیام ارسال کنیم
        if (!message && !window.selectedFile && !window.recordedAudio && !window.fileToSend) {
            alert('لطفاً متن پیام یا فایل پیوست را وارد کنید.');
            return;
        }
        
      
        
        // ذخیره شناسه کاربر در گفتگو برای استفاده‌های بعدی
        if (activeConversation) {
            activeConversation.userId = recipientId;
        }
                
        // پاک کردن فیلد ورودی
        messageInput.value = '';
                
        // ایجاد FormData برای ارسال فایل
        const formData = new FormData();

        // افزودن اطلاعات پیام به FormData
        formData.append('recipients[]', recipientId);
        
        // استفاده از نام کاربر یا شناسه کاربر برای موضوع پیام
        let subjectText = "پیام جدید";
        if (activeConversation) {
            if (activeConversation.name && activeConversation.name.trim() !== '') {
                subjectText = `گفتگو با ${activeConversation.name}`;
            } else if (activeConversation.userId) {
                subjectText = `گفتگو با کاربر ${activeConversation.userId}`;
            }
        }
        formData.append('subject', subjectText);
        
        //("salam",window.replyToMessageId);
        // اضافه کردن متن پیام
        formData.append('body', message || '');  // متن خالی برای اطمینان از وجود پارامتر

// اگر پیام در پاسخ به پیام دیگری است
        if (window.replyToMessageId) {
             formData.append('reply_to', +window.replyToMessageId);
            
        //('پاسخ به پیام با شناسه:', +window.replyToMessageId);
            } 

// اگر تاریخ زمانبندی انتخاب شده، آن را اضافه کن

        // اگر تاریخ زمانبندی انتخاب شده، آن را اضافه کن
        if (window.scheduledTime) {
            formData.append('scheduled_time', window.scheduledTime);
            //("زمان زمانبندی اضافه شد به پیام (فرمت میلادی ISO):", window.scheduledTime);
        }

        // افزودن فایل به FormData اگر وجود داشته باشد
        let hasFile = false;

        if (window.selectedFile) {
            formData.append('file', window.selectedFile);
            //("فایل انتخاب شده به فرم اضافه شد:", window.selectedFile.name);
            hasFile = true;
        } else if (window.recordedAudio) {
            // ارسال فایل صوتی به عنوان ضمیمه
            //("فایل صوتی تشخیص داده شد و به عنوان ضمیمه ارسال می‌شود");
            
            try {
                // استفاده از نام اصلی فایل به جای نام ثابت
                formData.append('file', window.recordedAudio);
                hasFile = true;
                
                // متن پیام را خالی می‌گذاریم
                formData.set('body', '');
                
                //("فایل صوتی به فرم اضافه شد:", window.recordedAudio.name);
            } catch (error) {
                console.error("خطا در افزودن فایل صوتی به FormData:", error);
            }
        } else if (window.fileToSend) {
            // استفاده از fileToSend اگر وجود داشته باشد
            try {
                formData.append('file', window.fileToSend);
                //("فایل از متغیر fileToSend به فرم اضافه شد:", window.fileToSend.name);
                hasFile = true;
                
                // نمایش اطلاعات بیشتر
                //("نوع فایل:", window.fileToSend.type);
                //("سایز فایل:", window.fileToSend.size);
            } catch (error) {
                console.error("خطا در افزودن فایل از fileToSend به FormData:", error);
            }
        }

        // نمایش شاخص بارگذاری
        const loading = document.createElement('div');
        loading.className = 'loading-overlay';
        loading.innerHTML = '<div class="loading-spinner"></div><p>در حال ارسال پیام...</p>';
        document.body.appendChild(loading);

        //("ارسال اطلاعات پیام به سرور...");

        // ارسال درخواست AJAX به سرور
        $.ajax({
            url: '/api/send-message',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')  // استفاده از تابع getCookie به جای getCsrfToken
            },
            success: function(data) {
                //('پیام با موفقیت ارسال شد:', Object.fromEntries(formData));
                
                // علامت‌گذاری که پیامی ارسال شده است
                messageWasSent = true;
                
                // پاک کردن فیلد ورودی
                const inputElement = document.getElementById('telegramInput');
                if (inputElement) {
                    inputElement.value = '';
                }
                
                // مخفی کردن پنل‌ها
                const filePreview = document.getElementById('filePreview');
                if (filePreview) filePreview.style.display = 'none';
                
                const schedulePanel = document.getElementById('schedulePanel');
                if (schedulePanel) schedulePanel.style.display = 'none';
                
                const voiceRecorder = document.getElementById('voiceRecorder');
                if (voiceRecorder) voiceRecorder.style.display = 'none';
                
                // پاک کردن متغیرهای جهانی
                window.selectedFile = null;
                window.scheduledTime = null;
                window.recordedAudio = null;
                window.fileToSend = null;
                
                // حذف شاخص بارگذاری
                document.body.removeChild(loading);
                
                // به جای بارگذاری مجدد تمام داده‌ها، فقط پیام‌های گفتگوی فعلی را بارگذاری می‌کنیم
                if (activeConversation) {
                    // اضافه کردن پیام جدید به لیست پیام‌های گفتگو
                    const messageId = data.message_id || `temp-${Date.now()}`;
                    const jalaliDate = toJalaliDate(window.scheduledTime ? new Date(window.scheduledTime) : new Date());
                    
                    // تعیین متن پیام نهایی - اگر پیام صوتی بود، متن را به "پیام صوتی" تغییر می‌دهیم
                    let finalMessage = message;
                    let fileType = '';
                    let fileName = '';
                    let extension = '';
                    
                    if (hasFile) {
                        const fileObj = window.selectedFile || window.recordedAudio || window.fileToSend;
                        fileType = determineFileType(fileObj);
                        fileName = fileObj?.name || 'فایل ضمیمه';
                        
                        // استخراج پسوند فایل
                        if (fileName) {
                            const parts = fileName.split('.');
                            if (parts.length > 1) {
                                extension = parts.pop().toLowerCase();
                            }
                        }
                        
                        // اگر متن پیام خالی است و فایل دارد، نوع فایل را با پسوند نمایش می‌دهیم
                        if (!message) {
                            if (fileType === 'image') {
                                finalMessage = `🖼️ تصویر${extension ? ` (${extension})` : ''}`;
                            } else if (fileType === 'video') {
                                finalMessage = `🎬 ویدیو${extension ? ` (${extension})` : ''}`;
                            } else if (fileType === 'audio') {
                                finalMessage = `🎵 فایل صوتی${extension ? ` (${extension})` : ''}`;
                            } else if (fileType === 'pdf') {
                                finalMessage = '📄 فایل PDF';
                            } else if (fileType === 'doc' || fileType === 'docx') {
                                finalMessage = `📝 فایل Word${extension ? ` (${extension})` : ''}`;
                            } else if (fileType === 'xls' || fileType === 'xlsx') {
                                finalMessage = `📊 فایل Excel${extension ? ` (${extension})` : ''}`;
                            } else if (fileType === 'ppt' || fileType === 'pptx') {
                                finalMessage = `📊 فایل PowerPoint${extension ? ` (${extension})` : ''}`;
                            } else if (fileType === 'zip' || fileType === 'rar' || fileType === 'archive') {
                                finalMessage = `📦 فایل فشرده${extension ? ` (${extension})` : ''}`;
                            } else if (fileType === 'code') {
                                finalMessage = `📝 فایل کد${extension ? ` (${extension})` : ''}`;
                            } else {
                                finalMessage = `📎 فایل${extension ? ` (${extension})` : ' ضمیمه'}`;
                            }
                        }
                    } else if (window.recordedAudio) {
                        finalMessage = '🎤 پیام صوتی';
                    }
                    
                    // افزودن پیام جدید به لیست پیام‌های گفتگوی فعال
                    activeConversation.messages.push({
                        id: messageId,
                        subject: 'پاسخ',
                        body: finalMessage,
                        date: jalaliDate,
                        isReceived: false,
                        scheduled_time: window.scheduledTime,
                        // اضافه کردن اطلاعات ضمیمه به پیام جدید
                        hasAttachment: hasFile,
                        attachments: hasFile ? [{
                            file_type: fileType,
                            file_name: fileName
                        }] : []
                    });
                    
                    // به‌روزرسانی اطلاعات آخرین پیام در گفتگوی فعال
                    activeConversation.lastMessageDate = jalaliDate;
                    activeConversation.lastMessageText = finalMessage;
                    activeConversation.lastMessageIsReceived = false;
                    activeConversation.readStatus = window.scheduledTime && isInFuture(jalaliDate) ? 'pending' : 'sent';
                    
                    // به‌روزرسانی نمایش گفتگوها در لیست
                    renderConversations(conversations);
                    
                    // بارگذاری مجدد پیام‌های گفتگوی فعال
                    loadConversationMessages(activeConversation, true); // پارامتر true برای forceReload
                    
                    // اسکرول به پایین پنجره چت
                    setTimeout(() => {
                        chatBody.scrollTop = chatBody.scrollHeight;
                    }, 200);
                }
            },
            error: function(error) {
                console.error('خطا در ارسال پیام:', error);
                
                // حذف شاخص بارگذاری
                document.body.removeChild(loading);
                
                // نمایش پیام خطا با جزئیات
                let errorMessage = 'خطا در ارسال پیام.';
                
                if (error.responseJSON && error.responseJSON.error) {
                    errorMessage += ' ' + error.responseJSON.error;
                } else if (error.status) {
                    errorMessage += ' کد خطا: ' + error.status;
                    if (error.status === 500) {
                        errorMessage += ' (خطای سرور داخلی)';
                    }
                }
                
                errorMessage += ' لطفاً دوباره تلاش کنید.';
                
                alert(errorMessage);
            }
        });
    }

    // ================ توابع رابط کاربری ================

    // تشخیص متن نمایشی برای آخرین پیام بر اساس نوع محتوا
    function getLastMessageDisplay(conversation) {
        // بررسی آخرین پیام برای ضمیمه
        const lastMessage = conversation.lastMessage || (conversation.messages?.length > 0 ? conversation.messages[conversation.messages.length - 1] : null);
        
 
        
        // اگر پیامی وجود ندارد، متن خالی برگردان
        if (!lastMessage) return '';
        
        // بررسی دقیق‌تر برای وجود ضمیمه - همه حالت‌های ممکن را بررسی می‌کنیم
        let hasAttachment = false;
        let attachments = null;
        
        // حالت 1: ضمیمه در lastMessage.attachments
        if (lastMessage.attachments && Array.isArray(lastMessage.attachments) && lastMessage.attachments.length > 0) {
            hasAttachment = true;
            attachments = lastMessage.attachments;
        } 
        // حالت 2: ضمیمه در lastMessage.attachment (تکی)
        else if (lastMessage.attachment && typeof lastMessage.attachment === 'object') {
            hasAttachment = true;
            attachments = [lastMessage.attachment];
        }
        // حالت 3: ضمیمه در conversation.attachments
        else if (conversation.attachments && Array.isArray(conversation.attachments) && conversation.attachments.length > 0) {
            hasAttachment = true;
            attachments = conversation.attachments;
        }
        // حالت 4: ضمیمه در lastMessage.hasAttachment (فقط نشانگر)
        else if (lastMessage.hasAttachment === true) {
            hasAttachment = true;
        }
        
        // اگر آخرین پیام ضمیمه دارد، نوع فایل را نمایش بده (با اولویت)
        if (hasAttachment && attachments) {
            // تشخیص نوع فایل ضمیمه
            let fileType = '';
            let fileName = '';
            
            const attachment = attachments[0]; // اولین ضمیمه را بررسی می‌کنیم
            
            if (attachment) {
                fileType = attachment.file_type || '';
                fileName = attachment.file_url || '';
                
                // اگر نوع فایل مشخص نیست، سعی کنیم از نام فایل تشخیص دهیم
                if (!fileType && fileName) {
                    fileType = determineFileType(fileName);
                }
                
                // استخراج پسوند فایل برای نمایش
                let extension = '';
                if (fileName) {
                    
                    const parts = fileName.split('.');
                    
                    if (parts.length > 1) {
                        extension = parts.pop().toLowerCase();
                    }
                }
          
                // نمایش بر اساس نوع فایل با پسوند
                if (fileType === 'image') {
                    return `🖼️ تصویر${extension ? ` (${extension})` : ''}`;
                } else if (fileType === 'video') {
                    return `🎬 ویدیو${extension ? ` (${extension})` : ''}`;
                } else if (extension === 'wav') {
                    return `🎤 پیام صوتی`;
                } else if (fileType === 'audio') {
                    return `🎵 فایل صوتی${extension ? ` (${extension})` : ''}`;
                } else if (fileType === 'pdf') {
                    return '📄 فایل PDF';
                } else if (fileType === 'doc' || fileType === 'docx') {
                    return `📝 فایل Word${extension ? ` (${extension})` : ''}`;
                } else if (fileType === 'xls' || fileType === 'xlsx') {
                    return `📊 فایل Excel${extension ? ` (${extension})` : ''}`;
                } else if (fileType === 'ppt' || fileType === 'pptx') {
                    return `📊 فایل PowerPoint${extension ? ` (${extension})` : ''}`;
                } else if (fileType === 'zip' || fileType === 'rar' || fileType === 'archive') {
                    return `📦 فایل فشرده${extension ? ` (${extension})` : ''}`;
                } else if (fileType === 'code') {
                    return `📝 فایل کد${extension ? ` (${extension})` : ''}`;
                } else {
                    // اگر نوع فایل شناخته شده نیست، پسوند را نمایش بده
                
                    return `📎 فایل${extension ? ` (${extension})` : ' ضمیمه'}`;
                    
                }
            } else {
                return '📎 فایل ضمیمه';
            }
        }
        
        // اگر پیام متن دارد، آن را نمایش بده
        if (lastMessage.body && lastMessage.body.trim() !== '') {
            return lastMessage.body;
        }
        
        // اگر پیام متن ندارد اما موضوع دارد، موضوع را نمایش بده
        if (lastMessage.subject && lastMessage.subject !== 'بدون موضوع') {
            return lastMessage.subject;
        }
        
        // اگر پیام متن و موضوع ندارد، متن پیش‌فرض نمایش بده
        return conversation.lastMessageText || ''; // متن خالی را برگردان به جای 'بدون پیام'
    }
    
    // نمایش گفتگوها
    function renderConversations(items) {
        conversationList.innerHTML = '';
        
        if (items.length === 0) {
            conversationList.innerHTML = `
                <div class="telegram-empty-message">
                   گفت‌و‌گویی یافت نشد ؛ برای ارسال پیام از قسمت جستجو، کاربر مورد نظر را انتخاب کنید.
                </div>
            `;
            return;
        }
        
        items.forEach(conversation => {
            const item = document.createElement('div');
            item.className = 'telegram-conversation-item';
            item.dataset.id = conversation.id;
            
            // ذخیره شناسه کاربر در ویژگی‌های data- برای استفاده‌های بعدی
            if (conversation.userId) {
                item.dataset.userId = conversation.userId;
            }
            
            // اولین حرف نام برای آواتار
            let firstChar = 'ن';
            if (conversation.name && conversation.name.length > 0) {
                firstChar = conversation.name.charAt(0);
            }
            
            // تعیین کلاس آواتار بر اساس نوع پیام‌ها
            const avatarClass = conversation.messages.some(m => !m.isReceived) ? 
                              'telegram-conversation-avatar-sent' : 'telegram-conversation-avatar';
            
            // یافتن آخرین پیام (بدون فیلتر کردن پیام‌های زمانبندی شده در آینده)
            const lastValidMessage = conversation.messages.length > 0 ? 
                                    conversation.messages[conversation.messages.length - 1] : null;
            
            // آخرین پیام برای نمایش با تشخیص هوشمند نوع محتوا
            let lastMessageText = '';
            if (lastValidMessage) {
                // ارسال کل پیام از جمله ضمیمه‌ها به تابع getLastMessageDisplay
                lastMessageText = getLastMessageDisplay({
                    ...conversation,
                    lastMessageText: lastValidMessage.body,
                    lastMessage: {
                        ...lastValidMessage,
                        hasAttachment: Array.isArray(lastValidMessage.attachments) && lastValidMessage.attachments.length > 0
                    }
                });
            }
            if (lastMessageText.length > 40) {
                lastMessageText = lastMessageText.substring(0, 40) + '...';
            }
            
            // آیکون وضعیت خوانده شدن
            let readStatusIcon = '';
            if (lastValidMessage && !lastValidMessage.isReceived) {
                // اگر پیام زمانبندی شده است و زمان آن در آینده است
                if (lastValidMessage.scheduled_time && isInFuture(lastValidMessage.date)) {
                    readStatusIcon = '<i class="fa-solid fa-clock telegram-message-status-icon telegram-message-pending"></i>';
                }
                // اگر پیام خوانده شده است
                else if (conversation.readStatus === 'read' || (lastValidMessage.seen_by && lastValidMessage.seen_by.length > 0)) {
                    readStatusIcon = '<i class="fa-solid fa-check-double telegram-message-status-icon telegram-message-seen"></i>';
                } 
                // در غیر این صورت، پیام فقط ارسال شده است
                else {
                    readStatusIcon = '<i class="fa-solid fa-check telegram-message-status-icon telegram-message-sent"></i>';
                }
            }
            
            // رندر نشانگر پیام‌های خوانده نشده
            let unreadHtml = '';
            if (conversation.hasUnread) {
                const unreadCount = countUnreadMessages(conversation);
                unreadHtml = `<div class="telegram-conversation-unread">${unreadCount}</div>`;
            }
            
            item.innerHTML = `
                <div class="${avatarClass}">${firstChar}</div>
                <div class="telegram-conversation-content">
                    <div class="telegram-conversation-top">
                        <div class="telegram-conversation-name">${conversation.name}</div>
                        <div class="telegram-conversation-time">${lastValidMessage ? lastValidMessage.date : ''}</div>
                    </div>
                    <div class="telegram-conversation-message">
                        ${lastValidMessage && !lastValidMessage.isReceived ? '<span class="telegram-reply-icon"><i class="fa-solid fa-reply"></i></span>' : ''}
                        ${readStatusIcon}
                        <span class="telegram-conversation-last-message">${lastMessageText}</span>
                    </div>
                </div>
                ${unreadHtml}
            `;
            
            // رویداد کلیک برای باز کردن گفتگو
            item.addEventListener('click', function() {
                // قبل از باز کردن گفتگو، اطمینان حاصل کنیم که شناسه کاربر از ویژگی data-user-id استخراج شود
                if (this.dataset.userId && !conversation.userId) {
                    conversation.userId = this.dataset.userId;
                    //(`شناسه کاربر ${this.dataset.userId} از ویژگی data-user-id استخراج شد`);
                }
                
                openConversation(conversation);
            });
            
            conversationList.appendChild(item);
        });
    }

    // نمایش پیام‌ها در گفتگوی فعال
    function renderMessages(messages, initialRender = false) {
        chatBody.innerHTML = '';
        
        if (messages.length === 0) {
            chatBody.innerHTML = '<div class="telegram-empty-message">هیچ پیامی در این گفتگو یافت نشد.</div>';
            return;
        }
        
        // ایجاد آرایه جدید برای همه پیام‌ها و ضمیمه‌ها
        let allItems = [];
        
        // برای هر پیام، ضمیمه‌ها را جدا کرده و به آرایه اضافه می‌کنیم
        messages.forEach(message => {
            // ابتدا متن پیام را اضافه می‌کنیم (اگر وجود داشته باشد)
            if (message.body && message.body.trim() !== '') {
                // حذف "پاسخ به: " از ابتدای متن پیام
                let cleanBody = message.body.trim();
                
                // اگر با "پاسخ به:" شروع می‌شود، آن را حذف کنیم
                if (cleanBody.startsWith('پاسخ به:')) {
                    cleanBody = cleanBody.substring('پاسخ به:'.length).trim();
                }
                
                // افزودن به لیست پیام‌ها
                allItems.push({
                    type: 'text',
                    id: message.id,
                    body: cleanBody,
                    date: message.date,
                    isReceived: message.isReceived,
                    seen_by: message.seen_by || [],
                    scheduled_time: message.scheduled_time || null
                });
            } else if (message.subject && message.subject !== 'بدون موضوع' && (!message.attachments || message.attachments.length === 0)) {
                // اگر پیام بدنه نداشته باشد، موضوع داشته باشد و فایل ضمیمه نداشته باشد، موضوع را به عنوان متن اضافه کنیم
                let cleanSubject = message.subject.trim();
                
                // اگر با "پاسخ به:" شروع می‌شود، آن را حذف کنیم
                if (cleanSubject.startsWith('پاسخ به:')) {
                    cleanSubject = cleanSubject.substring('پاسخ به:'.length).trim();
                }
                
                // افزودن به لیست پیام‌ها
                allItems.push({
                    type: 'text',
                    id: message.id,
                    body: cleanSubject,
                    date: message.date,
                    isReceived: message.isReceived,
                    seen_by: message.seen_by || [],
                    scheduled_time: message.scheduled_time || null
                });
            }
            
            // سپس ضمیمه‌ها را به صورت جداگانه اضافه می‌کنیم
            if (message.attachments && message.attachments.length > 0) {
                message.attachments.forEach((attachment, index) => {
                    allItems.push({
                        type: 'attachment',
                        id: message.id ,
                        fileType: attachment.file_type || determineFileType(attachment.file_name),
                        fileName: attachment.file_name || 'فایل ضمیمه',
                        fileUrl: attachment.file_url || '',
                        date: message.date,
                        isReceived: message.isReceived,
                        seen_by: message.seen_by || [],
                        scheduled_time: message.scheduled_time || null,
                        is_sent: message.is_sent
                    });
                });
            }
        });
        
        // مرتب‌سازی آیتم‌ها بر اساس ID (که تقریباً مرتب‌سازی بر اساس زمان است)
        allItems.sort((a, b) => {
            // اگر ID پیام‌ها عددی باشد
            const idA = a.id.toString().split('-')[0];
            const idB = b.id.toString().split('-')[0];
            return parseInt(idA) - parseInt(idB);
        });
        
        // نمایش هر آیتم در چت
        allItems.forEach(item => {
            const messageElement = document.createElement('div');
            messageElement.className = `telegram-message ${item.isReceived ? 'telegram-message-incoming' : 'telegram-message-outgoing'}`;
            // اضافه کردن ویژگی data-message-id به المنت پیام
            messageElement.dataset.messageId = item.id;
            messageElement.style.cursor = 'pointer'; // اضافه کردن نشانگر دست برای نمایش قابلیت کلیک
            
            let messageHTML = '';
            
            // بر اساس نوع آیتم، محتوای متفاوتی نمایش می‌دهیم
            if (item.type === 'text') {
                // نمایش پیام متنی - فقط متن بدون موضوع
                let messageContent = '';
                
                // تبدیل خطوط جدید به تگ <br>
                const bodyText = item.body ? item.body.replace(/\n/g, '<br>') : '';
                
                // فقط متن پیام را نمایش می‌دهیم
                if (bodyText) {
                    messageContent += `<div class="telegram-message-body">${bodyText}</div>`;
                }
                
                // متغیر برای نگهداری وضعیت خوانده شدن
                let readStatusHtml = '';
                
                // اضافه کردن وضعیت خوانده شدن برای پیام‌های ارسالی
                if (!item.isReceived) {
                    // بررسی اینکه آیا پیام در آینده ارسال خواهد شد
                    if (item.scheduled_time && isInFuture(item.date)) {
                        readStatusHtml = `<i class="fa-solid fa-clock telegram-message-status-icon telegram-message-pending"></i>`;
                    } else if (item.seen_by && item.seen_by.length > 0) {
                        readStatusHtml = `<i class="fa-solid fa-check-double telegram-message-status-icon telegram-message-seen"></i>`;
                    } else if (item.is_sent === false) {
                        // اگر پیام هنوز ارسال نشده باشد (برای پیام‌های زمانبندی شده)
                        readStatusHtml = `<i class="fa-solid fa-clock telegram-message-status-icon telegram-message-pending"></i>`;
                    } else {
                        readStatusHtml = `<i class="fa-solid fa-check telegram-message-status-icon telegram-message-sent"></i>`;
                    }
                }
                
                // از <div> به جای span استفاده می‌کنیم تا متن در خط جدید قرار بگیرد
                messageHTML = `
                    <div class="telegram-message-content">
                        ${messageContent}
                    </div>
                    <div class="telegram-message-time-container">
                        ${readStatusHtml}
                        <div class="telegram-message-time">${item.date}</div>
                    </div>
                `;
            } else if (item.type === 'attachment') {
                // نمایش ضمیمه به عنوان یک پیام مستقل
                const fileType = item.fileType;
                const fileName = item.fileName;
                const fileUrl = item.fileUrl;
                
                // استخراج نام خالص فایل بدون مسیر
                let cleanFileName = fileName;
                if (fileName && fileName.includes('/')) {
                    const parts = fileName.split('/');
                    cleanFileName = parts[parts.length - 1];
                } else if (fileName && fileName.includes('\\')) {
                    const parts = fileName.split('\\');
                    cleanFileName = parts[parts.length - 1];
                }
                
                // استخراج پسوند فایل
                let fileExtension = '';
                if (cleanFileName && cleanFileName.includes('.')) {
                    const parts = cleanFileName.split('.');
                    if (parts.length > 1) {
                        fileExtension = parts[parts.length - 1];
                    }
                }
                
                // ایجاد محتوای مناسب برای هر نوع فایل
                if (fileType === 'image') {
                    // متغیر برای نگهداری وضعیت خوانده شدن
                    let readStatusHtml = '';
                    
                    // اضافه کردن وضعیت خوانده شدن برای پیام‌های ارسالی
                    if (!item.isReceived) {
                        // بررسی اینکه آیا پیام در آینده ارسال خواهد شد
                        if (item.scheduled_time && isInFuture(item.date)) {
                            readStatusHtml = `<i class="fa-solid fa-clock telegram-message-status-icon telegram-message-pending"></i>`;
                        } else if (item.seen_by && item.seen_by.length > 0) {
                            readStatusHtml = `<i class="fa-solid fa-check-double telegram-message-status-icon telegram-message-seen"></i>`;
                        } else {
                            readStatusHtml = `<i class="fa-solid fa-check telegram-message-status-icon telegram-message-sent"></i>`;
                        }
                    }
                
                    messageHTML = `
                        <div class="telegram-attachment-item-standalone">
                            <img src="${fileUrl}" alt="${fileName}" class="telegram-attachment-image-standalone" onclick="openTelegramLightbox('${fileUrl}')">
                            <div class="telegram-attachment-meta-standalone">
                                <div class="telegram-message-time-container">
                                    ${readStatusHtml}
                                    <div class="telegram-message-time">${item.date}</div>
                                </div>
                                <a href="${fileUrl}" download="${cleanFileName}" class="telegram-image-download-btn">
                                    <i class="fa-solid fa-download"></i>
                                </a>
                            </div>
                        </div>
                    `;
                } else if (fileType === 'video') {
                    // متغیر برای نگهداری وضعیت خوانده شدن
                    let readStatusHtml = '';
                    
                    // اضافه کردن وضعیت خوانده شدن برای پیام‌های ارسالی
                    if (!item.isReceived) {
                        // بررسی اینکه آیا پیام در آینده ارسال خواهد شد
                        if (item.scheduled_time && isInFuture(item.date)) {
                            readStatusHtml = `<i class="fa-solid fa-clock telegram-message-status-icon telegram-message-pending"></i>`;
                        } else if (item.seen_by && item.seen_by.length > 0) {
                            readStatusHtml = `<i class="fa-solid fa-check-double telegram-message-status-icon telegram-message-seen"></i>`;
                        } else {
                            readStatusHtml = `<i class="fa-solid fa-check telegram-message-status-icon telegram-message-sent"></i>`;
                        }
                    }
                
                    messageHTML = `
                        <div class="telegram-attachment-item-standalone">
                            <div class="telegram-video-container">
                                <video class="telegram-attachment-video-standalone" preload="metadata" poster="" controls>
                                    <source src="${fileUrl}" type="video/mp4">
                                </video>
                                <div class="telegram-video-play-btn" onclick="playTelegramVideo(this)">
                                    <i class="fa-solid fa-play"></i>
                                </div>
                            </div>
                            <div class="telegram-attachment-meta-standalone">
                                <div class="telegram-message-time-container">
                                    ${readStatusHtml}
                                    <div class="telegram-message-time">${item.date}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (fileType === 'audio') {
                    // تشخیص اینکه آیا فایل صوتی یک ویس است - فقط فایل‌های WAV و موارد خاص
                    const isVoice = fileName.toLowerCase().includes('voice_message') || 
                                   fileName.toLowerCase().includes('audio_message') || 
                                   fileName.toLowerCase().includes('_voice_') || 
                                   fileName.toLowerCase().includes('_audio_') || 
                                   fileExtension.toLowerCase() === 'wav' ||
                                   (fileUrl && fileUrl.toLowerCase().includes('.wav'));
                    
                    // جدا کردن تاریخ و ساعت برای نمایش بهتر
                    let formattedDate = item.date;
                    
                    // متغیر برای نگهداری وضعیت خوانده شدن
                    let readStatusHtml = '';
                    
                    // اضافه کردن وضعیت خوانده شدن برای پیام‌های ارسالی
                    if (!item.isReceived) {
                        // بررسی اینکه آیا پیام در آینده ارسال خواهد شد
                        if (item.scheduled_time && isInFuture(item.date)) {
                            readStatusHtml = `<i class="fa-solid fa-clock telegram-message-status-icon telegram-message-pending"></i>`;
                        } else if (item.seen_by && item.seen_by.length > 0) {
                            readStatusHtml = `<i class="fa-solid fa-check-double telegram-message-status-icon telegram-message-seen"></i>`;
                        } else if (item.is_sent === false) {
                            // اگر پیام هنوز ارسال نشده باشد (برای پیام‌های زمانبندی شده)
                            readStatusHtml = `<i class="fa-solid fa-clock telegram-message-status-icon telegram-message-pending"></i>`;
                        } else {
                            readStatusHtml = `<i class="fa-solid fa-check telegram-message-status-icon telegram-message-sent"></i>`;
                        }
                    }
                    
                    // استخراج مدت زمان از نام فایل برای نمایش اولیه
                    let initialDuration = "00:00 / 00:00";
                    try {
                    if (fileName && fileName.includes('voice_message_') && fileName.includes('_')) {
                            // الگوی voice_message_20250629_1322_00m04s.wav
                        const parts = fileName.split('_');
                        if (parts.length >= 4) {
                            const durationPart = parts[parts.length - 1].split('.')[0]; // مثلا "00m04s"
                                
                                // استخراج دقیقه و ثانیه
                            const minuteMatch = durationPart.match(/(\d+)m/);
                            const secondMatch = durationPart.match(/(\d+)s/);
                                
                            if (minuteMatch && secondMatch) {
                                const minutes = minuteMatch[1].padStart(2, '0');
                                const seconds = secondMatch[1].padStart(2, '0');
                                    initialDuration = `00:00 / ${minutes}:${seconds}`;
                            }
                        }
                    }
                } catch (error) {
                    console.error("Error extracting duration from filename:", error);
                    }
                    
                    messageHTML = `
                        <div class="telegram-attachment-item-standalone">
                            <div class="telegram-audio-custom">
                                <button type="button" class="telegram-audio-play" data-url="${fileUrl}" onclick="setupTelegramAudio('${fileUrl}', this)">
                                    <i class="fa-solid fa-play"></i>
                                </button>
                                <div class="telegram-audio-wrapper">
                                    <div class="telegram-audio-track">
                                        <div class="telegram-audio-progress-bar"></div>
                                        <div class="telegram-audio-time-display">${initialDuration}</div>
                                    </div>
                                </div>
                                ${isVoice ? 
                                `<button class="telegram-audio-speed-btn" data-current-speed="1.0">1x</button>` : 
                                `<a href="${fileUrl}" download class="telegram-download-btn">
                                    <i class="fa-solid fa-download"></i>
                                </a>`}
                                <audio class="telegram-audio-element" style="display: none;"></audio>
                            </div>
                            <div class="telegram-message-time-container">
                                ${readStatusHtml}
                                <div class="telegram-message-time">${item.date}</div>
                            </div>
                        </div>
                    `;
                } else if (fileType === 'pdf') {
                    // استخراج صحیح نام فایل برای PDF
                    const pdfNameDisplay = fileName ? fileName.split(/[\\/]/).pop() : 'فایل PDF';
                    
                    // متغیر برای نگهداری وضعیت خوانده شدن
                    let readStatusHtml = '';
                    
                    // اضافه کردن وضعیت خوانده شدن برای پیام‌های ارسالی
                    if (!item.isReceived) {
                        // بررسی اینکه آیا پیام در آینده ارسال خواهد شد
                        if (item.scheduled_time && isInFuture(item.date)) {
                            readStatusHtml = `<i class="fa-solid fa-clock telegram-message-status-icon telegram-message-pending"></i>`;
                        } else if (item.seen_by && item.seen_by.length > 0) {
                            readStatusHtml = `<i class="fa-solid fa-check-double telegram-message-status-icon telegram-message-seen"></i>`;
                        } else if (item.is_sent === false) {
                            // اگر پیام هنوز ارسال نشده باشد (برای پیام‌های زمانبندی شده)
                            readStatusHtml = `<i class="fa-solid fa-clock telegram-message-status-icon telegram-message-pending"></i>`;
                        } else {
                            readStatusHtml = `<i class="fa-solid fa-check telegram-message-status-icon telegram-message-sent"></i>`;
                        }
                    }
                    
                    messageHTML = `
                        <div class="telegram-attachment-item-standalone">
                            <div class="telegram-file-box">
                                <div class="telegram-file-icon pdf">
                                    <i class="fa-solid fa-file-pdf"></i>
                                </div>
                                <div class="telegram-file-info">
                                    <div class="telegram-file-name">${pdfNameDisplay}</div>
                                    <div class="telegram-file-meta">PDF</div>
                                </div>
                                <a href="${fileUrl}" download class="telegram-download-btn">
                                    <i class="fa-solid fa-download"></i>
                                </a>
                            </div>
                            <div class="telegram-attachment-meta-standalone">
                                <div class="telegram-message-time-container">
                                    ${readStatusHtml}
                                    <div class="telegram-message-time">${item.date}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // سایر انواع فایل (غیر از تصویر، ویدیو، صوتی و PDF)
                    let fileIcon = 'fa-file';
                    let fileColor = '';
                    
                    // انتخاب آیکون و رنگ مناسب براساس نوع فایل
                    switch(fileType) {
                        case 'doc':
                            fileIcon = 'fa-file-word';
                            fileColor = 'doc';
                            break;
                        case 'excel':
                            fileIcon = 'fa-file-excel';
                            fileColor = 'excel';
                            break;
                        case 'presentation':
                            fileIcon = 'fa-file-powerpoint';
                            fileColor = 'presentation';
                            break;
                        case 'archive':
                            fileIcon = 'fa-file-zipper';
                            fileColor = 'archive';
                            break;
                        case 'code':
                            fileIcon = 'fa-file-code';
                            fileColor = 'code';
                            break;
                    }
                    
                    const displayName = cleanFileName || 'فایل ضمیمه';
                    const displayExtension = fileExtension ? fileExtension.toUpperCase() : '';
                    
                    // متغیر برای نگهداری وضعیت خوانده شدن
                    let readStatusHtml = '';
                    
                    // اضافه کردن وضعیت خوانده شدن برای پیام‌های ارسالی
                    if (!item.isReceived) {
                        // بررسی اینکه آیا پیام در آینده ارسال خواهد شد
                        if (item.scheduled_time && isInFuture(item.date)) {
                            readStatusHtml = `<i class="fa-solid fa-clock telegram-message-status-icon telegram-message-pending"></i>`;
                        } else if (item.seen_by && item.seen_by.length > 0) {
                            readStatusHtml = `<i class="fa-solid fa-check-double telegram-message-status-icon telegram-message-seen"></i>`;
                        } else if (item.is_sent === false) {
                            // اگر پیام هنوز ارسال نشده باشد (برای پیام‌های زمانبندی شده)
                            readStatusHtml = `<i class="fa-solid fa-clock telegram-message-status-icon telegram-message-pending"></i>`;
                        } else {
                            readStatusHtml = `<i class="fa-solid fa-check telegram-message-status-icon telegram-message-sent"></i>`;
                        }
                    }
                    
                    messageHTML = `
                        <div class="telegram-attachment-item-standalone">
                            <div class="telegram-file-box">
                                <div class="telegram-file-icon ${fileColor}">
                                    <i class="fa-solid ${fileIcon}"></i>
                                </div>
                                <div class="telegram-file-info">
                                    <div class="telegram-file-name">${displayName}</div>
                                    <div class="telegram-file-meta">${displayExtension}</div>
                                </div>
                                <a href="${fileUrl}" download class="telegram-download-btn">
                                    <i class="fa-solid fa-download"></i>
                                </a>
                            </div>
                            <div class="telegram-attachment-meta-standalone">
                                <div class="telegram-message-time-container">
                                    ${readStatusHtml}
                                    <div class="telegram-message-time">${item.date}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            messageElement.innerHTML = messageHTML;
            chatBody.appendChild(messageElement);
        });
        
        // اسکرول به آخرین پیام
        chatBody.scrollTop = chatBody.scrollHeight;
        
        // فعال کردن پخش‌کننده‌های صوتی - اصلاح شده
        const audioPlayButtons = chatBody.querySelectorAll('.telegram-audio-play');
        //(`Found ${audioPlayButtons.length} audio play buttons`);
        
        audioPlayButtons.forEach(button => {
            const audioUrl = button.getAttribute('data-url');
            if (audioUrl) {
                //(`Initializing audio player for: ${audioUrl}`);
                
                // استخراج مدت زمان از نام فایل قبل از بارگذاری
                try {
                    // استخراج نام فایل از URL
                const fileName = audioUrl.split('/').pop();
                    
                    // بررسی آیا این یک ویس مسیج با فرمت استاندارد است
                if (fileName && fileName.includes('voice_message_') && fileName.includes('_')) {
                        // الگوی voice_message_20250629_1322_00m04s.wav
                    const parts = fileName.split('_');
                    if (parts.length >= 4) {
                        const durationPart = parts[parts.length - 1].split('.')[0]; // مثلا "00m04s"
                            
                            // استخراج دقیقه و ثانیه
                        const minuteMatch = durationPart.match(/(\d+)m/);
                        const secondMatch = durationPart.match(/(\d+)s/);
                            
                        if (minuteMatch && secondMatch) {
                                const minutes = minuteMatch[1].padStart(2, '0');
                                const seconds = secondMatch[1].padStart(2, '0');
                                
                                // تنظیم نمایش زمان در المان مربوطه
                                const audioPlayer = button.closest('.telegram-audio-custom');
                                const timeDisplay = audioPlayer.querySelector('.telegram-audio-time-display');
                                if (timeDisplay) {
                                    timeDisplay.textContent = `00:00 / ${minutes}:${seconds}`;
                                    //("Duration set from filename:", `00:00 / ${minutes}:${seconds}`);
                                }
                        }
                    }
                }
            } catch (error) {
                console.error("Error extracting duration from filename:", error);
            }
            
                // آماده‌سازی پخش‌کننده بدون پخش فایل
                setTimeout(() => {
                    setupTelegramAudio(audioUrl, button, true);
                }, 100);
            }
        });

        // اضافه کردن رویداد کلیک به همه پیام‌ها برای نمایش شناسه پیام
        chatBody.querySelectorAll('.telegram-message').forEach(message => {
            message.addEventListener('click', function() {
                // استخراج شناسه پیام از ویژگی data-message-id
                const messageId = this.dataset.messageId;
                //('شناسه پیام کلیک شده:', messageId);
                
                // استخراج شناسه اصلی پیام (بدون پسوند -attachment-x)
                const originalId = messageId.split('-attachment-')[0];
                
                // یافتن پیام اصلی در آرایه activeMessages
                const originalMessage = activeMessages.find(msg => msg.id == originalId);
                if (originalMessage) {
                    //('اطلاعات کامل پیام:', originalMessage);
                } else {
                    // اگر پیام در activeMessages یافت نشد، احتمالاً یک ضمیمه است
                    //('این یک ضمیمه است با شناسه اصلی:', originalId);
                }
            });
        });
    }
    
    // تشخیص نوع فایل بر اساس پسوند
    function determineFileType(fileOrFileName) {
        // اگر ورودی خالی است
        if (!fileOrFileName) return 'document';
        
        // بررسی نوع ورودی (رشته یا شیء فایل)
        let fileName = '';
        if (typeof fileOrFileName === 'string') {
            fileName = fileOrFileName;
        } else if (fileOrFileName instanceof File || (typeof fileOrFileName === 'object' && fileOrFileName.name)) {
            // اگر شیء فایل است، نام فایل را استخراج کنیم
            fileName = fileOrFileName.name;
            
            // اگر نوع MIME فایل مشخص است، از آن استفاده کنیم
            if (fileOrFileName.type) {
                const mimeType = fileOrFileName.type.toLowerCase();
                if (mimeType.startsWith('image/')) return 'image';
                if (mimeType.startsWith('video/')) return 'video';
                if (mimeType.startsWith('audio/')) return 'audio';
                if (mimeType === 'application/pdf') return 'pdf';
                if (mimeType.includes('word') || mimeType.includes('document')) return 'doc';
                if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'excel';
                if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return 'presentation';
                if (mimeType.includes('zip') || mimeType.includes('archive') || mimeType.includes('compressed')) return 'archive';
            }
        }
        
        // اگر نام فایل وجود ندارد
        if (!fileName) return 'document';
        
        const extension = getFileExtension(fileName).toLowerCase();
        if (!extension) return 'document';
        
        // تشخیص نوع فایل بر اساس پسوند
        const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg', 'tif', 'tiff', 'heic'];
        const videoExtensions = ['mp4', 'webm', 'mov', 'avi', 'mkv', 'flv', '3gp', 'wmv', 'mpg', 'mpeg', 'm4v'];
        const audioExtensions = ['mp3', 'ogg', 'aac', 'flac', 'm4a', 'wav'];
        const pdfExtensions = ['pdf'];
        const docExtensions = ['doc', 'docx', 'rtf', 'txt', 'odt'];
        const excelExtensions = ['xls', 'xlsx', 'csv', 'ods'];
        const presentationExtensions = ['ppt', 'pptx', 'odp'];
        const archiveExtensions = ['zip', 'rar', '7z', 'tar', 'gz', 'bz2'];
        const codeExtensions = ['html', 'css', 'js', 'php', 'py', 'java', 'c', 'cpp', 'h', 'json', 'xml'];
        
        if (imageExtensions.includes(extension)) return 'image';
        if (videoExtensions.includes(extension)) return 'video';
        if (audioExtensions.includes(extension)) return 'audio';
        if (pdfExtensions.includes(extension)) return 'pdf';
        if (docExtensions.includes(extension)) return 'doc';
        if (excelExtensions.includes(extension)) return 'excel';
        if (presentationExtensions.includes(extension)) return 'presentation';
        if (archiveExtensions.includes(extension)) return 'archive';
        if (codeExtensions.includes(extension)) return 'code';
        
        // شناسایی فایل‌های صوتی ویس با نام فایل
        if (fileName.toLowerCase().includes('voice_message') || 
            fileName.toLowerCase().includes('audio_message') || 
            fileName.toLowerCase().includes('_voice_') || 
            fileName.toLowerCase().includes('_audio_')) {
            return 'audio';
        }
        
        return 'document';
    }
    
    // دریافت پسوند فایل
    function getFileExtension(fileName) {
        if (!fileName || typeof fileName !== 'string') return '';
        
        try {
            // در مسیر فایل، فقط نام فایل را استخراج می‌کنیم (برای مسیرهای کامل)
            const baseName = fileName.split(/[\\/]/).pop();
            
            // استخراج پسوند
            const parts = baseName.split('.');
            if (parts.length <= 1) return '';
            
            return parts.pop().toLowerCase();
        } catch (e) {
            return '';
        }
    }
    
    // باز کردن لایت باکس برای تصاویر
    function openTelegramLightbox(imageUrl) {
        const lightbox = document.getElementById('telegramLightbox');
        const lightboxImage = document.getElementById('telegramLightboxImage');
        
        if (lightbox && lightboxImage) {
            lightboxImage.src = imageUrl;
            lightbox.classList.add('active');
            
            // جلوگیری از اسکرول در صفحه
            document.body.style.overflow = 'hidden';
        }
    }
    
    // بستن لایت باکس
    function closeTelegramLightbox() {
        const lightbox = document.getElementById('telegramLightbox');
        
        if (lightbox) {
            lightbox.classList.remove('active');
            
            // برگرداندن اسکرول به حالت عادی
            document.body.style.overflow = '';
        }
    }
    
    // پخش/توقف ویدیو
    function playTelegramVideo(button) {
        const videoElement = button.closest('.telegram-video-container').querySelector('video');
        
        if (!videoElement) return;
        
        // توقف همه ویدیوهای دیگر
        document.querySelectorAll('.telegram-attachment-video-standalone').forEach(video => {
            if (video !== videoElement && !video.paused) {
                video.pause();
                const playBtn = video.closest('.telegram-video-container').querySelector('.telegram-video-play-btn');
                if (playBtn) {
                    playBtn.style.display = 'flex';
                }
            }
        });
        
        // پخش ویدیو
        videoElement.play();
        
        // مخفی کردن دکمه پخش
        button.style.display = 'none';
        
        // وقتی ویدیو متوقف یا تمام شد، دکمه پخش را نمایش بده
        videoElement.addEventListener('pause', function() {
            button.style.display = 'flex';
        });
        
        videoElement.addEventListener('ended', function() {
            button.style.display = 'flex';
        });
    }
    
    // تنظیم و پخش فایل صوتی
    function setupTelegramAudio(container) {
            const audioElements = container.querySelectorAll('audio');
            audioElements.forEach(audio => {
                if (audio.getAttribute('data-setup') === 'true') return;
                audio.setAttribute('data-setup', 'true');
                
                const customAudio = audio.closest('.telegram-audio-custom');
                if (!customAudio) return;
                
                const playBtn = customAudio.querySelector('.telegram-audio-play');
                const progressBar = customAudio.querySelector('.telegram-audio-progress');
                const progressBarFill = customAudio.querySelector('.telegram-audio-progress-fill');
                const timeDisplay = customAudio.querySelector('.telegram-audio-time');
                const speedBtn = customAudio.querySelector('.telegram-audio-speed-btn');
                
                if (playBtn) {
                    playBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        toggleTelegramAudio(audio, playBtn);
                    });
                }
                
                // اضافه کردن رویداد کلیک برای دکمه سرعت به صورت چرخشی
                if (speedBtn && !speedBtn.getAttribute('data-initialized')) {
                    speedBtn.setAttribute('data-initialized', 'true');
                    
                    // تعریف سرعت‌های پخش به ترتیب
                    const speedOptions = [0.5, 0.75, 1.0, 1.25, 1.5, 2.0];
                    
                    speedBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        // دریافت سرعت فعلی
                        const currentSpeed = parseFloat(this.getAttribute('data-current-speed') || 1.0);
                        
                        // یافتن ایندکس سرعت فعلی
                        let currentIndex = speedOptions.indexOf(currentSpeed);
                        if (currentIndex === -1) currentIndex = 2; // پیش‌فرض 1.0x
                        
                        // محاسبه سرعت بعدی (چرخشی)
                        const nextIndex = (currentIndex + 1) % speedOptions.length;
                        const nextSpeed = speedOptions[nextIndex];
                        
                        // تنظیم سرعت جدید
                        audio.playbackRate = nextSpeed;
                        this.textContent = nextSpeed + 'x';
                        this.setAttribute('data-current-speed', nextSpeed);
                    });
                }
                
                if (progressBar) {
                    progressBar.addEventListener('click', function(e) {
                        const rect = progressBar.getBoundingClientRect();
                        const pos = (e.clientX - rect.left) / rect.width;
                        audio.currentTime = pos * audio.duration;
                        updateAudioProgress(audio, progressBarFill, timeDisplay);
                    });
                }
                
                audio.addEventListener('timeupdate', function() {
                    updateAudioProgress(audio, progressBarFill, timeDisplay);
                });
                
                audio.addEventListener('ended', function() {
                    playBtn.classList.remove('playing');
                    progressBarFill.style.width = '0%';
                    timeDisplay.textContent = formatTime(audio.duration);
                });
            });
    }

    // حذف تابع قبلی toggleTelegramAudio و جایگزینی با نسخه جدید

    function toggleTelegramAudio(audioElement, playButton) {
        // توقف همه فایل‌های صوتی دیگر - بهینه‌سازی شده
        const playingAudios = Array.from(document.querySelectorAll('.telegram-audio-element')).filter(audio => !audio.paused);
        for (let i = 0; i < playingAudios.length; i++) {
            if (playingAudios[i] !== audioElement) {
                playingAudios[i].pause();
                const btn = playingAudios[i].closest('.telegram-audio-custom').querySelector('.telegram-audio-play');
                if (btn) {
                    btn.innerHTML = '<i class="fa-solid fa-play"></i>';
                }
            }
        }
        
        // پخش/توقف این فایل صوتی
        if (audioElement.paused) {
            audioElement.play();
            playButton.innerHTML = '<i class="fa-solid fa-pause"></i>';
        } else {
            audioElement.pause();
            playButton.innerHTML = '<i class="fa-solid fa-play"></i>';
        }
    }
    
    // اضافه کردن رویداد کلید ESC برای بستن لایت باکس
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeTelegramLightbox();
        }
    });
    
    // کلیک روی خارج از محتوای لایت باکس برای بستن آن
    document.getElementById('telegramLightbox')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeTelegramLightbox();
        }
    });
    
    // بستن منوهای سرعت پخش هنگام کلیک روی جاهای دیگر صفحه
    document.addEventListener('click', function(event) {
        // اگر کلیک روی دکمه سرعت یا گزینه‌های آن نباشد، همه منوهای سرعت را ببند
        if (!event.target.closest('.telegram-audio-speed') && 
            !event.target.closest('.telegram-audio-speed-options')) {
            document.querySelectorAll('.telegram-audio-speed-options').forEach(menu => {
                menu.style.display = 'none';
            });
        }
    });

    // فیلتر کردن گفتگوها بر اساس جستجو
    function filterConversations(searchTerm) {
        if (!searchTerm) {
            renderConversations(conversations);
            return;
        }
        
        const filtered = conversations.filter(conv => 
            conv.name.toLowerCase().includes(searchTerm) || 
            conv.messages.some(m => 
                (m.subject && m.subject.toLowerCase().includes(searchTerm)) || 
                (m.body && m.body.toLowerCase().includes(searchTerm))
            )
        );
        
        renderConversations(filtered);
    }

    // نمایش وضعیت بارگذاری
    function showLoading(container) {
        container.innerHTML = `
            <div class="telegram-loading-message">
                <i class="fa-solid fa-spinner fa-spin"></i>
                <span>در حال بارگذاری...</span>
            </div>
        `;
    }

    // به‌روزرسانی نشانگر اطلاع‌رسانی
    function updateNotificationBadge(count) {
        const notificationBadge = document.getElementById('telegramNotificationBadge');
        if (!notificationBadge) return;
        
        // اطمینان از اینکه مقدار count یک عدد است
        count = parseInt(count) || 0;
        if (count < 0) count = 0;
        
        // اگر شمارش بزرگتر از صفر است، نشانگر را نمایش بده
        if (count > 0) {
            notificationBadge.textContent = count;
            notificationBadge.style.display = 'flex';
            // به‌روزرسانی عنوان صفحه برای نمایش تعداد پیام‌های خوانده نشده
            document.title = `(${count}) پیام خوانده نشده | سامانه اداری`;
        } else {
            // اگر تعداد صفر است، نشانگر را مخفی کن
            notificationBadge.style.display = 'none';
            // برگرداندن عنوان صفحه به حالت عادی
            document.title = 'سامانه اداری';
        }
        
        // لاگ برای دیباگ
        debugLog(`تعداد پیام‌های خوانده نشده: ${count}`);
        
        // ذخیره مقدار در متغیر سراسری
        unreadCount = count;
    }

    // نمایش تعداد پیام‌های خوانده نشده
    function showUnreadCount() {
        // محاسبه تعداد کل پیام‌های خوانده نشده در تمام گفتگوها
        let totalUnreadMessages = 0;
        
        conversations.forEach(conversation => {
            // از تابع countUnreadMessages استفاده می‌کنیم که تعداد پیام‌های خوانده نشده یک گفتگو را محاسبه می‌کند
            totalUnreadMessages += countUnreadMessages(conversation);
        });
        
        // به‌روزرسانی نشانگر با تعداد کل پیام‌های خوانده نشده
        updateNotificationBadge(totalUnreadMessages);
        
        // لاگ برای دیباگ
        debugLog(`تعداد کل پیام‌های خوانده نشده: ${totalUnreadMessages}`);
        
        return totalUnreadMessages;
    }

    // دریافت کوکی CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // تبدیل تاریخ میلادی به تاریخ شمسی
    function toJalaliDate(gregorianDate) {
        // اگر تاریخ به صورت رشته شمسی است (مثلاً 1404/03/29 17:37)، همان را برگردان
        if (typeof gregorianDate === 'string') {
            // اگر فرمت شمسی است (شروع با 13 یا 14 و دارای /)
            if (/^(13|14)\d{2}\/\d{1,2}\/\d{1,2}/.test(gregorianDate)) {
                return gregorianDate;
            }
            // اگر فقط ساعت است (مثلاً 17:37)
            if (gregorianDate.includes(':') && !gregorianDate.includes('-') && !gregorianDate.includes('/')) {
                return gregorianDate;
            }
            // اگر فرمت ISO است، تبدیل به Date
            gregorianDate = new Date(gregorianDate);
        }
        if (isNaN(gregorianDate) || !gregorianDate) {
            return gregorianDate;
        }
        // ماه‌های شمسی
        const persianMonths = [
            'فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور',
            'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'
        ];
        // تبدیل تاریخ میلادی به شمسی با استفاده از الگوریتم دقیق
        function gregorianToJalali(gy, gm, gd) {
            var g_d_m, jy, jm, jd, gy2, days;
            g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
            if (gy > 1600) {
                jy = 979;
                gy -= 1600;
            } else {
                jy = 0;
                gy -= 621;
            }
            gy2 = (gm > 2) ? (gy + 1) : gy;
            days = (365 * gy) + (parseInt((gy2 + 3) / 4)) - (parseInt((gy2 + 99) / 100)) + (parseInt((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
            jy += 33 * (parseInt(days / 12053));
            days %= 12053;
            jy += 4 * (parseInt(days / 1461));
            days %= 1461;
            if (days > 365) {
                jy += parseInt((days - 1) / 365);
                days = (days - 1) % 365;
            }
            jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
            jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
            return [jy, jm, jd];
        }
        const date = gregorianDate;
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const hours = date.getHours();
        const minutes = date.getMinutes();
        // تبدیل به شمسی
        const jalali = gregorianToJalali(year, month, day);
        const jYear = jalali[0];
        const jMonth = jalali[1];
        const jDay = jalali[2];
        // ساخت خروجی به فرمت دلخواه (تاریخ و ساعت)
        return `${jYear}/${jMonth}/${jDay} ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    }
    
    // قالب‌بندی تاریخ شمسی برای نمایش بهتر
    function formatJalaliDate(jalaliDate) {
        // اگر تاریخ تعریف نشده یا خالی است، رشته خالی برگردان
        if (!jalaliDate) return '';
        
        // بررسی اینکه آیا تاریخ فقط ساعت است (مثل 14:30)
        if (jalaliDate.includes(':') && !jalaliDate.includes('/')) {
            return jalaliDate; // بدون تغییر برگردان
        }
        
        // نام‌های ماه‌های شمسی
        const persianMonths = [
            'فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور',
            'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'
        ];
        
        // تلاش برای تطبیق تاریخ کامل (مثال: 1402/12/25 14:30)
        const fullDateMatch = jalaliDate.match(/(\d{4})\/(\d{1,2})\/(\d{1,2}) (\d{1,2}):(\d{2})/);
        if (fullDateMatch) {
            const year = parseInt(fullDateMatch[1]);
            const month = parseInt(fullDateMatch[2]);
            const day = parseInt(fullDateMatch[3]);
            const hours = fullDateMatch[4];
            const minutes = fullDateMatch[5];
            
            // امروز را بررسی کن
            const today = new Date();
            const jalaliToday = toJalaliDate(today);
            const todayMatch = jalaliToday.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})/);
            
            if (todayMatch) {
                const todayYear = parseInt(todayMatch[1]);
                const todayMonth = parseInt(todayMatch[2]);
                const todayDay = parseInt(todayMatch[3]);
                
                // اگر امروز است، فقط ساعت را نشان بده
                if (year === todayYear && month === todayMonth && day === todayDay) {
                    return `${hours}:${minutes}`;
                }
                
                // اگر امسال است، ماه و روز را نشان بده
                if (year === todayYear) {
                    return `${day} ${persianMonths[month-1]} ${hours}:${minutes}`;
                }
            }
            
            // در غیر این صورت، تاریخ کامل را نشان بده
            return `${day} ${persianMonths[month-1]} ${year} ${hours}:${minutes}`;
        }
        
        // تلاش برای تطبیق تاریخ بدون ساعت (مثال: 1402/12/25)
        const dateMatch = jalaliDate.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})/);
        if (dateMatch) {
            const year = parseInt(dateMatch[1]);
            const month = parseInt(dateMatch[2]);
            const day = parseInt(dateMatch[3]);
            
            return `${day} ${persianMonths[month-1]} ${year}`;
        }
        
        // اگر هیچ الگویی تطبیق نداشت، همان رشته اصلی را برگردان
        return jalaliDate;
    }

    // نمایش تعداد پیام‌های خوانده نشده
    function showUnreadCount() {
        // محاسبه تعداد کل پیام‌های خوانده نشده در تمام گفتگوها
        let totalUnreadMessages = 0;
        
        conversations.forEach(conversation => {
            // از تابع countUnreadMessages استفاده می‌کنیم که تعداد پیام‌های خوانده نشده یک گفتگو را محاسبه می‌کند
            totalUnreadMessages += countUnreadMessages(conversation);
        });
        
        // به‌روزرسانی نشانگر با تعداد کل پیام‌های خوانده نشده
        updateNotificationBadge(totalUnreadMessages);
        
        // لاگ برای دیباگ
        debugLog(`تعداد کل پیام‌های خوانده نشده: ${totalUnreadMessages}`);
        
        return totalUnreadMessages;
    }
    
    // شمارش تعداد پیام‌های خوانده نشده در یک گفتگو
    function countUnreadMessages(conversation) {
        if (!conversation || !conversation.messages) return 0;
        
        // شمارش تعداد پیام‌های دریافتی خوانده نشده
        const count = conversation.messages.filter(msg => 
            msg.isReceived && (typeof msg.is_read === 'undefined' || msg.is_read === false)
        ).length;
        
        return count;
    }
    
    // بررسی پیام‌های خوانده نشده بدون باز کردن چت
    function checkUnreadMessages() {
        // اگر چت باز است، نیازی به بررسی نیست چون داده‌ها در حال به‌روزرسانی هستند
        if (chatContainer.classList.contains('open')) {
            return;
        }
        
        debugLog("بررسی دوره‌ای پیام‌های خوانده نشده...");
        
        $.ajax({
            url: '/api/received-messages',
            type: 'GET',
            success: function(response) {
                debugLog('تعداد پیام‌های خوانده نشده دریافت شد');
                
                // محاسبه تعداد کل پیام‌های خوانده نشده
                let totalUnreadMessages = 0;
                
                if (response.messages && Array.isArray(response.messages)) {
                    // شمارش تعداد پیام‌های خوانده نشده در پاسخ API
                    totalUnreadMessages = response.messages.filter(msg => 
                        msg.is_read === false
                    ).length;
                } else {
                    // اگر ساختار پاسخ متفاوت است، از مقدار unread_count استفاده می‌کنیم
                    totalUnreadMessages = response.unread_count || 0;
                }
                
                // به‌روزرسانی نشانگر اطلاع‌رسانی بدون باز کردن چت
                updateNotificationBadge(totalUnreadMessages);
                
                debugLog(`تعداد کل پیام‌های خوانده نشده: ${totalUnreadMessages}`);
            },
            error: function(error) {
                console.error('خطا در بررسی پیام‌های خوانده نشده:', error);
                // در صورت خطا، نشانگر را مخفی نکنیم تا وضعیت قبلی حفظ شود
            }
        });
    }

    // نمایش تعداد پیام‌های خوانده نشده
});

// اضافه کردن توابع سراسری برای دسترسی از HTML
window.openTelegramLightbox = function(imageUrl) {
    const lightbox = document.getElementById('telegramLightbox');
    const lightboxImage = document.getElementById('telegramLightboxImage');
    
    if (lightbox && lightboxImage) {
        lightboxImage.src = imageUrl;
        lightbox.classList.add('active');
        
        // جلوگیری از اسکرول در صفحه
        document.body.style.overflow = 'hidden';
    }
};

window.closeTelegramLightbox = function() {
    const lightbox = document.getElementById('telegramLightbox');
    
    if (lightbox) {
        lightbox.classList.remove('active');
        
        // برگرداندن اسکرول به حالت عادی
        document.body.style.overflow = '';
    }
};

window.playTelegramVideo = function(button) {
    const videoElement = button.closest('.telegram-video-container').querySelector('video');
    
    if (!videoElement) return;
    
    // توقف همه ویدیوهای دیگر
    document.querySelectorAll('.telegram-attachment-video-standalone').forEach(video => {
        if (video !== videoElement && !video.paused) {
            video.pause();
            const playBtn = video.closest('.telegram-video-container').querySelector('.telegram-video-play-btn');
            if (playBtn) {
                playBtn.style.display = 'flex';
            }
        }
    });
    
    // پخش ویدیو
    videoElement.play();
    
    // مخفی کردن دکمه پخش
    button.style.display = 'none';
    
    // وقتی ویدیو متوقف یا تمام شد، دکمه پخش را نمایش بده
    videoElement.addEventListener('pause', function() {
        button.style.display = 'flex';
    });
    
    videoElement.addEventListener('ended', function() {
        button.style.display = 'flex';
    });
};

window.setupTelegramAudio = function(audioUrl, button, skipPlay = false) {
        //("setupTelegramAudio called", audioUrl);
        
        // یافتن عناصر پخش‌کننده
        const audioPlayer = button.closest('.telegram-audio-custom');
        if (!audioPlayer) {
            console.error("Audio player container not found");
            return;
        }
        
        // بررسی وجود دکمه سرعت
        const speedBtn = audioPlayer.querySelector('.telegram-audio-speed-btn');
        const hasSpeedButton = !!speedBtn;
        
        // یافتن المان‌های مورد نیاز
        const audioTrack = audioPlayer.querySelector('.telegram-audio-track');
        const progressBar = audioPlayer.querySelector('.telegram-audio-progress-bar');
        const timeDisplay = audioPlayer.querySelector('.telegram-audio-time-display');
        
        if (!audioTrack || !progressBar || !timeDisplay) {
            console.error("Required audio elements not found", { audioTrack, progressBar, timeDisplay });
            return;
        }
        
        // استخراج مدت زمان از نام فایل
    let durationFromFilename = "00:00";
    try {
        // استخراج نام فایل از URL
                    const fileName = audioUrl.split('/').pop();
        
        // بررسی آیا این یک ویس مسیج با فرمت استاندارد است
                    if (fileName && fileName.includes('voice_message_') && fileName.includes('_')) {
            // الگوی voice_message_20250629_1322_00m04s.wav
                        const parts = fileName.split('_');
                        if (parts.length >= 4) {
                            const durationPart = parts[parts.length - 1].split('.')[0]; // مثلا "00m04s"
                
                // استخراج دقیقه و ثانیه
                            const minuteMatch = durationPart.match(/(\d+)m/);
                            const secondMatch = durationPart.match(/(\d+)s/);
                
                            if (minuteMatch && secondMatch) {
                    const minutes = minuteMatch[1].padStart(2, '0');
                    const seconds = secondMatch[1].padStart(2, '0');
                    durationFromFilename = `00:00 / ${minutes}:${seconds}`;
                    
                    // تنظیم نمایش زمان براساس مقادیر استخراج شده از نام فایل
                    if (timeDisplay) {
                        timeDisplay.textContent = durationFromFilename;
                    }
                    //("Duration extracted from filename:", durationFromFilename);
                }
            }
        }
    } catch (error) {
        console.error("Error extracting duration from filename:", error);
    }
    
    // یافتن یا ایجاد المان صوتی
    let audioElement = audioPlayer.querySelector('.telegram-audio-element');
    
    // پخش/توقف صوتی موجود
    if (audioElement && audioElement.src && !skipPlay) {
        if (audioElement.paused) {
            // توقف سایر صداها
            document.querySelectorAll('.telegram-audio-element').forEach(audio => {
                if (audio !== audioElement && !audio.paused) {
                    audio.pause();
                    const btn = audio.closest('.telegram-audio-custom').querySelector('.telegram-audio-play');
                    if (btn) {
                        btn.innerHTML = '<i class="fa-solid fa-play"></i>';
                    }
                }
            });
            
            // پخش صدا
            const playPromise = audioElement.play();
            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    button.innerHTML = '<i class="fa-solid fa-pause"></i>';
                }).catch(error => {
                    console.error('خطا در پخش صدا:', error);
                    button.innerHTML = '<i class="fa-solid fa-play"></i>';
                });
                } else {
                button.innerHTML = '<i class="fa-solid fa-pause"></i>';
            }
        } else {
            // توقف صدا
            audioElement.pause();
            button.innerHTML = '<i class="fa-solid fa-play"></i>';
        }
        return;
    }
    
    // ایجاد المان صوتی اگر وجود نداشت
    if (!audioElement) {
        audioElement = document.createElement('audio');
        audioElement.className = 'telegram-audio-element';
        audioElement.style.display = 'none';
        audioPlayer.appendChild(audioElement);
    }
    
    // تنظیم منبع صوتی
    audioElement.src = audioUrl;
    
    // تنظیم رویدادهای صوتی - فقط یک بار
    if (!audioElement.hasAttribute('data-initialized')) {
        // رویداد به‌روزرسانی زمان - بازنویسی شده برای سازگاری بهتر با کروم و سافاری
        audioElement.addEventListener('timeupdate', function() {
            // به‌روزرسانی زمان فعلی
            const currentMinutes = Math.floor(audioElement.currentTime / 60).toString().padStart(2, '0');
            const currentSeconds = Math.floor(audioElement.currentTime % 60).toString().padStart(2, '0');
            
            // تلاش برای استفاده از مدت زمان واقعی فایل صوتی
            if (audioElement.duration && !isNaN(audioElement.duration) && audioElement.duration !== Infinity) {
                // به‌روزرسانی نوار پیشرفت
                const percent = (audioElement.currentTime / audioElement.duration) * 100;
                progressBar.style.width = percent + '%';
                
                // حذف خط زیر که باعث خطا می‌شود
                // audioElement.currentTime = normalizedPosition * audioElement.duration;
                return;
            }
            
            // اگر مدت زمان نامعتبر است، از مدت زمان استخراج شده از نام فایل استفاده می‌کنیم
            let durationFromFilename = 0;
            try {
                const fileName = audioUrl.split('/').pop();
                if (fileName && fileName.includes('voice_message_') && fileName.includes('_')) {
                    const parts = fileName.split('_');
                    if (parts.length >= 4) {
                        const durationPart = parts[parts.length - 1].split('.')[0]; // مثلا "00m04s"
                        const minuteMatch = durationPart.match(/(\d+)m/);
                        const secondMatch = durationPart.match(/(\d+)s/);
                        if (minuteMatch && secondMatch) {
                            const minutes = parseInt(minuteMatch[1]);
                            const seconds = parseInt(secondMatch[1]);
                            durationFromFilename = minutes * 60 + seconds;
                        }
                    }
                }
            } catch (error) {
                console.error("Error extracting duration from filename:", error);
            }
            
            // اگر مدت زمان از نام فایل استخراج شد، از آن استفاده می‌کنیم
            if (durationFromFilename > 0) {
                // حذف خط زیر که باعث خطا می‌شود
                // audioElement.currentTime = normalizedPosition * durationFromFilename;
                
                // به‌روزرسانی نوار پیشرفت به صورت دستی - براساس زمان جاری
                const percent = (audioElement.currentTime / durationFromFilename) * 100;
                progressBar.style.width = percent + '%';
                
                // به‌روزرسانی نمایش زمان به صورت دستی
                const currentTimeInSeconds = Math.floor(audioElement.currentTime);
                const currentMinutes = Math.floor(currentTimeInSeconds / 60).toString().padStart(2, '0');
                const currentSeconds = Math.floor(currentTimeInSeconds % 60).toString().padStart(2, '0');
                
                // استخراج بخش زمان کل از متن فعلی
                const totalTimePart = timeDisplay.textContent.split(' / ')[1] || '00:00';
                timeDisplay.textContent = `${currentMinutes}:${currentSeconds} / ${totalTimePart}`;
                
                return;
            }
            
            // اگر هیچ مدت زمانی در دسترس نیست، حداقل سعی می‌کنیم موقعیت نوار پیشرفت را تغییر دهیم
            // حذف خط زیر که باعث خطا می‌شود
            // progressBar.style.width = (normalizedPosition * 100) + '%';
        });
        
        // علامت‌گذاری به عنوان مقداردهی شده
        audioElement.setAttribute('data-initialized', 'true');
    }
    
    // تنظیم رویداد دکمه تغییر سرعت به صورت چرخشی - فقط یک بار
    if (hasSpeedButton && !speedBtn.hasAttribute('data-initialized')) {
        // تعریف سرعت‌های پخش به ترتیب
        const speedOptions = [0.5, 0.75, 1.0, 1.25, 1.5, 2.0];
        
        speedBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // دریافت سرعت فعلی
            const currentSpeed = parseFloat(this.getAttribute('data-current-speed') || 1.0);
            
            // یافتن ایندکس سرعت فعلی
            let currentIndex = speedOptions.indexOf(currentSpeed);
            if (currentIndex === -1) currentIndex = 2; // پیش‌فرض 1.0x
            
            // محاسبه سرعت بعدی (چرخشی)
            const nextIndex = (currentIndex + 1) % speedOptions.length;
            const nextSpeed = speedOptions[nextIndex];
            
            // تنظیم سرعت جدید
            audioElement.playbackRate = nextSpeed;
            this.textContent = nextSpeed + 'x';
            this.setAttribute('data-current-speed', nextSpeed);
        });
        
        // علامت‌گذاری به عنوان مقداردهی شده
        speedBtn.setAttribute('data-initialized', 'true');
    }
    
    // اگر skipPlay فعال باشد، فقط آماده‌سازی می‌کنیم و پخش نمی‌کنیم
    if (skipPlay) return;
    
    // توقف همه پخش‌کننده‌های دیگر قبل از پخش این یکی
    document.querySelectorAll('.telegram-audio-element').forEach(audio => {
        if (audio !== audioElement && !audio.paused) {
            audio.pause();
            const btn = audio.closest('.telegram-audio-custom').querySelector('.telegram-audio-play');
            if (btn) {
                btn.innerHTML = '<i class="fa-solid fa-play"></i>';
            }
        }
    });
    
    // پخش صدا
    const playPromise = audioElement.play();
    
    // برخی مرورگرها نیاز به مدیریت promise دارند
    if (playPromise !== undefined) {
        playPromise.then(_ => {
            button.innerHTML = '<i class="fa-solid fa-pause"></i>';
        }).catch(error => {
            console.error('خطا در پخش صدا:', error);
            button.innerHTML = '<i class="fa-solid fa-play"></i>';
                    });
                } else {
        button.innerHTML = '<i class="fa-solid fa-pause"></i>';
    }
};

function toggleTelegramAudio(audioElement, playButton) {
    // توقف همه فایل‌های صوتی دیگر - بهینه‌سازی شده
    const playingAudios = Array.from(document.querySelectorAll('.telegram-audio-element')).filter(audio => !audio.paused);
    for (let i = 0; i < playingAudios.length; i++) {
        if (playingAudios[i] !== audioElement) {
            playingAudios[i].pause();
            const btn = playingAudios[i].closest('.telegram-audio-custom').querySelector('.telegram-audio-play');
            if (btn) {
                btn.innerHTML = '<i class="fa-solid fa-play"></i>';
            }
        }
    }
    
    // پخش/توقف این فایل صوتی
    if (audioElement.paused) {
        audioElement.play();
        playButton.innerHTML = '<i class="fa-solid fa-pause"></i>';
    } else {
        audioElement.pause();
        playButton.innerHTML = '<i class="fa-solid fa-play"></i>';
    }
}

// اضافه کردن یک رویداد کلیک گلوبال برای بستن منوهای سرعت پخش
document.addEventListener('click', function(event) {
    // اگر کلیک روی دکمه سرعت یا گزینه‌های آن نباشد، همه منوهای سرعت را ببند
    if (!event.target.closest('.telegram-audio-speed') && 
        !event.target.closest('.telegram-audio-speed-options')) {
        document.querySelectorAll('.telegram-audio-speed-options').forEach(menu => {
            menu.style.display = 'none';
        });
    }
});

// ================ توابع جدید برای آپلود فایل، ضبط صدا و زمانبندی ================

// متغیرهای عمومی
let recordedAudio = null;
let mediaRecorder = null;
let recordingStream = null;
let audioChunks = [];
let recordingTimer = null;
let recordingStartTime = null;
let recordingDuration = 0;

// رویدادهای دکمه‌های آپلود فایل، ضبط صدا و زمانبندی
document.getElementById('attachFileBtn').addEventListener('click', function() {
    const fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.click();
    } else {
        console.error('فیلد fileInput پیدا نشد!');
    }
});

document.getElementById('recordVoiceBtn').addEventListener('click', function() {
    if (document.getElementById('voiceRecorder').style.display === 'none') {
        showVoiceRecorder();
    } else {
        hideVoiceRecorder();
    }
});

// رویداد انتخاب فایل
document.getElementById('fileInput').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        window.selectedFile = e.target.files[0];
        window.showFilePreview(window.selectedFile);
    }
});

// رویداد حذف فایل انتخاب شده
document.getElementById('removeFileBtn').addEventListener('click', function() {
    window.selectedFile = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('filePreview').style.display = 'none';
});

// رویدادهای ضبط صدا
document.getElementById('startRecordBtn').addEventListener('click', startRecording);

// رویداد تغییر مقدار فیلد زمانبندی
scheduledTimeInput.addEventListener('change', function() {
    //('تاریخ تغییر کرد:', this.value);
    
    // تبدیل تاریخ انتخاب شده به تاریخ میلادی
    const selectedDate = new Date(this.value);
    if (!isNaN(selectedDate.getTime())) {
        scheduledTime = selectedDate.toISOString();
        //('تاریخ ذخیره شده:', scheduledTime);
        
        // نمایش تاریخ انتخاب شده در پنل زمانبندی
        const scheduleTimeDisplay = document.getElementById('scheduleTimeDisplay');
        if (scheduleTimeDisplay) {
            scheduleTimeDisplay.textContent = this.value;
            scheduleTimeDisplay.classList.remove('not-selected');
            scheduleTimeDisplay.classList.add('selected');
        }
        
        // نمایش پنل زمانبندی
        const schedulePanel = document.getElementById('schedulePanel');
        schedulePanel.style.display = 'flex';
    } else {
        alert('لطفاً یک تاریخ معتبر انتخاب کنید.');
        scheduledTime = null;
    }
});

function showSchedulePanel(setDefaultDate = true) {
    // مخفی کردن پنل‌های دیگر
    const voiceRecorder = document.getElementById('voiceRecorder');
    const filePreview = document.getElementById('filePreview');
    
    if (voiceRecorder) voiceRecorder.style.display = 'none';
    if (filePreview) filePreview.style.display = 'none';
    
    // نمایش پنل زمانبندی
    const schedulePanel = document.getElementById('schedulePanel');
    if (schedulePanel) {
        schedulePanel.style.display = 'flex';
        schedulePanel.style.position = 'absolute';
        schedulePanel.style.bottom = '60px';
        schedulePanel.style.left = '0';
        schedulePanel.style.right = '0';
        schedulePanel.style.zIndex = '999999';
    }
    
    // تنظیم فیلد ورودی تاریخ
    const scheduledTimeInput = document.getElementById('scheduledTimeInput');
    
    // اطمینان از وجود ویژگی data-jdp
    if (scheduledTimeInput) {
        if (!scheduledTimeInput.hasAttribute('data-jdp')) {
            scheduledTimeInput.setAttribute('data-jdp', '');
            scheduledTimeInput.setAttribute('type', 'text');
            scheduledTimeInput.setAttribute('placeholder', 'انتخاب تاریخ و زمان');
        }
        
        scheduledTimeInput.style.display = 'block';
    }
    
    // تنظیم تاریخ و ساعت فعلی به صورت پیش‌فرض
    const now = new Date();
    now.setHours(now.getHours() + 1); // یک ساعت بعد به عنوان پیش‌فرض
    const currentJalaliDate = getCurrentJalaliDate();
    
    // تنظیم مجدد تقویم شمسی
    if (typeof jalaliDatepicker !== 'undefined') {
        //('تنظیم مجدد تقویم شمسی');
        
        try {
            // حذف تمام رویدادهای قبلی
            jalaliDatepicker.dispose();
            
            // تنظیم مجدد تقویم
            jalaliDatepicker.startWatch({
                selector: '[data-jdp]',
                minDate: "today",
                hasSecond: false,
                time: true,
                autoHide: false,
                hideAfterChange: false,
                zIndex: 999999999,
                container: 'body',
                persianDigits: true,
                initDate: currentJalaliDate,
                onSelect: function(selected) {
                    //('تاریخ انتخاب شده:', selected);
                    
                    // تبدیل تاریخ شمسی به میلادی
                    const date = jalaliToGregorian(selected);
                    
                    if (date && !isNaN(date)) {
                        window.scheduledTime = date.toISOString();
                        //('تاریخ ذخیره شده:', window.scheduledTime);
                        console.log(window.scheduledTime);
                        // نمایش تاریخ انتخاب شده در پنل زمانبندی
                        const scheduleTimeDisplay = document.getElementById('scheduleTimeDisplay');
                        if (scheduleTimeDisplay) {
                            scheduleTimeDisplay.textContent = selected;
                            scheduleTimeDisplay.classList.remove('not-selected');
                            scheduleTimeDisplay.classList.add('selected');
                        }
                        
                        // به‌روزرسانی وضعیت دکمه ارسال
                        if (typeof updateSendButtonState === 'function') {
                            updateSendButtonState();
                        }
                    } else {
                        console.error('تاریخ انتخاب شده نامعتبر است');
                        alert('تاریخ انتخاب شده نامعتبر است. لطفا دوباره تلاش کنید.');
                        
                        // به‌روزرسانی وضعیت دکمه ارسال
                        if (typeof updateSendButtonState === 'function') {
                            updateSendButtonState();
                        }
                    }
                }
            });
            
            // نمایش تقویم با تاریخ فعلی
            setTimeout(() => {
                if (setDefaultDate) {
                    // تنظیم تاریخ پیش‌فرض
                    if (scheduledTimeInput) {
                        scheduledTimeInput.value = currentJalaliDate;
                    }
                    
                    // ذخیره تاریخ پیش‌فرض
                    const date = jalaliToGregorian(currentJalaliDate);
                    if (date && !isNaN(date)) {
                        window.scheduledTime = date.toISOString();
                        //('تاریخ پیش‌فرض ذخیره شد:', window.scheduledTime);
                        
                        // نمایش تاریخ انتخاب شده در پنل زمانبندی
                        const scheduleTimeDisplay = document.getElementById('scheduleTimeDisplay');
                        if (scheduleTimeDisplay) {
                            scheduleTimeDisplay.textContent = currentJalaliDate;
                            scheduleTimeDisplay.classList.remove('not-selected');
                            scheduleTimeDisplay.classList.add('selected');
                        }
                    }
                }
                
                // نمایش تقویم
                if (scheduledTimeInput) {
                    jalaliDatepicker.show(scheduledTimeInput);
                }
                
                // اضافه کردن کلاس active به overlay
                const overlay = document.getElementById('jdpModalOverlay');
                if (overlay) {
                    overlay.classList.add('active');
                }
            }, 300);
        } catch (error) {
            console.error('خطا در تنظیم تقویم شمسی:', error);
            
            // روش جایگزین برای نمایش تاریخ و زمان
            fallbackDateSelection();
        }
    } else {
        console.error('کتابخانه تقویم شمسی بارگذاری نشده است');
        
        // تلاش برای بارگذاری کتابخانه
        loadJalaliDatepicker(currentJalaliDate);
        
        // روش جایگزین برای نمایش تاریخ و زمان
        fallbackDateSelection();
    }
    
    // روش جایگزین برای نمایش تاریخ و زمان
    function fallbackDateSelection() {
        if (setDefaultDate) {
            // تنظیم تاریخ پیش‌فرض
            if (scheduledTimeInput) {
                scheduledTimeInput.value = currentJalaliDate;
            }
            
            // ذخیره تاریخ پیش‌فرض
            window.scheduledTime = now.toISOString();
            //('تاریخ پیش‌فرض با روش جایگزین ذخیره شد:', window.scheduledTime);
            
            // نمایش تاریخ انتخاب شده در پنل زمانبندی
            const scheduleTimeDisplay = document.getElementById('scheduleTimeDisplay');
            if (scheduleTimeDisplay) {
                scheduleTimeDisplay.textContent = currentJalaliDate;
                scheduleTimeDisplay.classList.remove('not-selected');
                scheduleTimeDisplay.classList.add('selected');
            }
        }
    }
    
    // به‌روزرسانی وضعیت دکمه ارسال
    if (typeof updateSendButtonState === 'function') {
        updateSendButtonState();
    }
}

// تبدیل تاریخ شمسی به میلادی
function jalaliToGregorian(jDate) {
    // این تابع یک تاریخ شمسی را به میلادی تبدیل می‌کند
    if (!jDate) return new Date();
    
    try {
        // اگر تاریخ به صورت رشته با فرمت "1404/04/29 09:55:00" باشد
        if (typeof jDate === 'string' && jDate.includes('/')) {
            // جداسازی تاریخ و زمان
            const parts = jDate.split(' ');
            const datePart = parts[0]; // مثلا 1404/04/29
            const timePart = parts.length > 1 ? parts[1] : '00:00:00'; // مثلا 09:55:00
            
            // جداسازی اجزای تاریخ
            const dateParts = datePart.split('/');
            if (dateParts.length !== 3) {
                console.error('فرمت تاریخ نامعتبر است');
                return new Date();
            }
            
            // تبدیل اعداد فارسی به انگلیسی
            const toEnglishDigits = str => str.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d));
            
            const jYear = parseInt(toEnglishDigits(dateParts[0]));
            const jMonth = parseInt(toEnglishDigits(dateParts[1]));
            const jDay = parseInt(toEnglishDigits(dateParts[2]));
            
            // بررسی معتبر بودن تاریخ شمسی
            if (isNaN(jYear) || isNaN(jMonth) || isNaN(jDay)) {
                console.error('اجزای تاریخ شمسی معتبر نیستند');
                return new Date();
            }
            
            // جداسازی اجزای زمان
            const timeParts = timePart.split(':');
            const hour = parseInt(toEnglishDigits(timeParts[0])) || 0;
            const minute = parseInt(toEnglishDigits(timeParts[1])) || 0;
            const second = timeParts.length > 2 ? parseInt(toEnglishDigits(timeParts[2])) || 0 : 0;
            
            // استفاده از الگوریتم تبدیل تاریخ شمسی به میلادی
            function jalaliToGregorianConverter(jy, jm, jd) {
                jy = parseInt(jy);
                jm = parseInt(jm);
                jd = parseInt(jd);
                
                var sal_a, gy, gm, gd, days;
                if (jy > 979) {
                    gy = 1600;
                    jy -= 979;
                } else {
                    gy = 621;
                }
                
                days = (365 * jy) + ((parseInt(jy / 33)) * 8) + (parseInt(((jy % 33) + 3) / 4)) + 78 + jd;
                
                if (jm < 7) {
                    days += (jm - 1) * 31;
                } else {
                    days += ((jm - 7) * 30) + 186;
                }
                
                gy += 400 * (parseInt(days / 146097));
                days = days % 146097;
                
                if (days > 36524) {
                    gy += 100 * (parseInt(--days / 36524));
                    days = days % 36524;
                    
                    if (days >= 365) days++;
                }
                
                gy += 4 * (parseInt(days / 1461));
                days = days % 1461;
                
                if (days > 365) {
                    gy += parseInt((days - 1) / 365);
                    days = (days - 1) % 365;
                }
                
                gd = days + 1;
                
                var sal_a = [0, 31, ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                
                for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) {
                    gd -= sal_a[gm];
                }
                
                return [gy, gm, gd];
            }
            
            // تبدیل تاریخ شمسی به میلادی
            const gDate = jalaliToGregorianConverter(jYear, jMonth, jDay);
            if (gDate && gDate.length === 3) {
                const gYear = gDate[0];
                const gMonth = gDate[1] - 1; // ماه در جاوااسکریپت از 0 شروع می‌شود
                const gDay = gDate[2];
                
                const date = new Date(gYear, gMonth, gDay, hour, minute, second);
                //('تاریخ میلادی:', date, 'ISO:', date.toISOString());
                return date;
            }
        }
        
        // اگر فرمت دیگری داشت، سعی می‌کنیم آن را به تاریخ تبدیل کنیم
        return new Date(jDate);
    } catch (error) {
        console.error('خطا در تبدیل تاریخ شمسی به میلادی:', error);
        return new Date();
    }
}

// بارگذاری کتابخانه تقویم شمسی
function loadJalaliDatepicker(defaultDate) {
    //('تلاش برای بارگذاری کتابخانه تقویم شمسی');
    
    // بررسی اگر قبلا بارگذاری شده است
    if (typeof jalaliDatepicker !== 'undefined') {
        //('کتابخانه تقویم شمسی قبلا بارگذاری شده است');
        return;
    }
    
    // اگر تاریخ پیش‌فرض تعیین نشده، از تاریخ فعلی استفاده کن
    if (!defaultDate) {
        defaultDate = getCurrentJalaliDate();
    }
    
    // بارگذاری فایل CSS
    const cssLink = document.createElement('link');
    cssLink.rel = 'stylesheet';
    cssLink.href = '{% static "vendor/jalalidatepicker/css/jalalidatepicker.min.css" %}';
    document.head.appendChild(cssLink);
    
    // بارگذاری فایل JavaScript
    const jsScript = document.createElement('script');
    jsScript.src = '{% static "vendor/jalalidatepicker/js/jalalidatepicker.min.js" %}';
    
    // تنظیم رویداد onload
    jsScript.onload = function() {
        //('کتابخانه تقویم شمسی با موفقیت بارگذاری شد');
        
        // اطمینان از بارگذاری کامل کتابخانه
        if (typeof jalaliDatepicker !== 'undefined') {
            // تنظیم تقویم شمسی
            jalaliDatepicker.startWatch({
                selector: '[data-jdp]',
                minDate: "today",
                hasSecond: false,
                time: true,
                autoHide: false,
                hideAfterChange: false,
                zIndex: 999999999,
                container: 'body',
                persianDigits: true,
                initDate: defaultDate,
                onSelect: function(selected) {
                    //('تاریخ انتخاب شده:', selected);
                    
                    // تبدیل تاریخ شمسی به میلادی
                    const date = jalaliToGregorian(selected);
                    
                    if (date && !isNaN(date)) {
                        window.scheduledTime = date.toISOString();
                        //('تاریخ ذخیره شده:', window.scheduledTime);
                        
                        // نمایش تاریخ انتخاب شده در پنل زمانبندی
                        const scheduleTimeDisplay = document.getElementById('scheduleTimeDisplay');
                        if (scheduleTimeDisplay) {
                            scheduleTimeDisplay.textContent = selected;
                        }
                    } else {
                        console.error('تاریخ انتخاب شده نامعتبر است');
                        alert('تاریخ انتخاب شده نامعتبر است. لطفا دوباره تلاش کنید.');
                    }
                }
            });
            
            // نمایش تقویم
            const scheduledTimeInput = document.getElementById('scheduledTimeInput');
            if (scheduledTimeInput) {
                // تنظیم تاریخ پیش‌فرض
                scheduledTimeInput.value = defaultDate;
                
                // ذخیره تاریخ پیش‌فرض
                const date = jalaliToGregorian(defaultDate);
                if (date && !isNaN(date)) {
                    window.scheduledTime = date.toISOString();
                    //('تاریخ پیش‌فرض ذخیره شد:', window.scheduledTime);
                    
                    // نمایش تاریخ انتخاب شده در پنل زمانبندی
                    const scheduleTimeDisplay = document.getElementById('scheduleTimeDisplay');
                    if (scheduleTimeDisplay) {
                        scheduleTimeDisplay.textContent = defaultDate;
                    }
                }
                
                setTimeout(() => {
                    jalaliDatepicker.show(scheduledTimeInput);
                    
                    // اضافه کردن کلاس active به overlay
                    const overlay = document.getElementById('jdpModalOverlay');
                    if (overlay) {
                        overlay.classList.add('active');
                    }
                }, 300);
            }
        } else {
            console.error('کتابخانه تقویم شمسی بارگذاری نشد');
            alert('خطا در بارگذاری تقویم شمسی. لطفا صفحه را رفرش کنید و دوباره تلاش کنید.');
        }
    };
    
    // تنظیم رویداد onerror
    jsScript.onerror = function() {
        console.error('خطا در بارگذاری کتابخانه تقویم شمسی');
        alert('خطا در بارگذاری تقویم شمسی. لطفا اتصال اینترنت خود را بررسی کنید و دوباره تلاش کنید.');
    };
    
    // افزودن اسکریپت به صفحه
    document.head.appendChild(jsScript);
}

// بارگذاری اولیه تقویم شمسی
document.addEventListener('DOMContentLoaded', function() {
    // دریافت تاریخ و ساعت فعلی
    const currentJalaliDate = getCurrentJalaliDate();
    
    // بارگذاری کتابخانه تقویم شمسی
    loadJalaliDatepicker(currentJalaliDate);
    
    // رویداد کلیک روی overlay برای بستن تقویم
    document.getElementById('jdpModalOverlay').addEventListener('click', function() {
        if (typeof jalaliDatepicker !== 'undefined') {
            jalaliDatepicker.hide();
            this.classList.remove('active');
        }
    });
});

// دریافت تاریخ و ساعت فعلی به فرمت شمسی
function getCurrentJalaliDate() {
    // این تابع یک تاریخ شمسی فعلی را برمی‌گرداند
    const now = new Date();
    
    // تبدیل تاریخ میلادی به شمسی با استفاده از الگوریتم دقیق
    function gregorianToJalali(gy, gm, gd) {
        var g_d_m, jy, jm, jd, gy2, days;
        g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
        if (gy > 1600) {
            jy = 979;
            gy -= 1600;
        } else {
            jy = 0;
            gy -= 621;
        }
        gy2 = (gm > 2) ? (gy + 1) : gy;
        days = (365 * gy) + (parseInt((gy2 + 3) / 4)) - (parseInt((gy2 + 99) / 100)) + (parseInt((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
        jy += 33 * (parseInt(days / 12053));
        days %= 12053;
        jy += 4 * (parseInt(days / 1461));
        days %= 1461;
        if (days > 365) {
            jy += parseInt((days - 1) / 365);
            days = (days - 1) % 365;
        }
        jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
        jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
        return [jy, jm, jd];
    }
    
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const day = now.getDate();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    
    // تبدیل به شمسی
    const jalali = gregorianToJalali(year, month, day);
    const jYear = jalali[0];
    const jMonth = jalali[1];
    const jDay = jalali[2];
    
    // ساخت خروجی به فرمت دلخواه (تاریخ و ساعت)
    return `${jYear}/${jMonth < 10 ? '0' + jMonth : jMonth}/${jDay < 10 ? '0' + jDay : jDay} ${hours < 10 ? '0' + hours : hours}:${minutes < 10 ? '0' + minutes : minutes}`;
}

// تبدیل تاریخ شمسی به میلادی
function parseJalaliDate(jalaliDateStr) {
    // فرمت ورودی: 1404/03/30 15:30
    if (!jalaliDateStr) return null;
    
    //('تبدیل تاریخ شمسی به میلادی:', jalaliDateStr);
    
    try {
        // جداسازی تاریخ و زمان
        const parts = jalaliDateStr.split(' ');
        const datePart = parts[0]; // مثلا 1404/03/30
        const timePart = parts.length > 1 ? parts[1] : '00:00'; // مثلا 15:30
        
        // جداسازی اجزای تاریخ
        const dateParts = datePart.split('/');
        if (dateParts.length !== 3) {
            console.error('فرمت تاریخ نامعتبر است');
            return null;
        }
        
        // تبدیل اعداد فارسی به انگلیسی
        const toEnglishDigits = str => str.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d));
        
        const jYear = parseInt(toEnglishDigits(dateParts[0]));
        const jMonth = parseInt(toEnglishDigits(dateParts[1]));
        const jDay = parseInt(toEnglishDigits(dateParts[2]));
        
        // جداسازی اجزای زمان
        const timeParts = timePart.split(':');
        const hour = parseInt(toEnglishDigits(timeParts[0]));
        const minute = parseInt(toEnglishDigits(timeParts[1]));
        
        // تبدیل تاریخ شمسی به میلادی با استفاده از الگوریتم دقیق
        function jalaliToGregorian(jy, jm, jd) {
            jy = parseInt(jy);
            jm = parseInt(jm);
            jd = parseInt(jd);
            
            var sal_a, gy, gm, gd, days;
            if (jy > 979) {
                gy = 1600;
                jy -= 979;
            } else {
                gy = 621;
            }
            
            days = (365 * jy) + ((parseInt(jy / 33)) * 8) + (parseInt(((jy % 33) + 3) / 4)) + 78 + jd;
            
            if (jm < 7) {
                days += (jm - 1) * 31;
            } else {
                days += ((jm - 7) * 30) + 186;
            }
            
            gy += 400 * (parseInt(days / 146097));
            days = days % 146097;
            
            if (days > 36524) {
                gy += 100 * (parseInt(--days / 36524));
                days = days % 36524;
                
                if (days >= 365) days++;
            }
            
            gy += 4 * (parseInt(days / 1461));
            days = days % 1461;
            
            if (days > 365) {
                gy += parseInt((days - 1) / 365);
                days = (days - 1) % 365;
            }
            
            gd = days + 1;
            
            var sal_a = [0, 31, ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            
            for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) {
                gd -= sal_a[gm];
            }
            
            return [gy, gm, gd];
        }
        
        // تبدیل تاریخ شمسی به میلادی
        const gDate = jalaliToGregorian(jYear, jMonth, jDay);
        if (gDate && gDate.length === 3) {
            const gYear = gDate[0];
            const gMonth = gDate[1] - 1; // ماه در جاوااسکریپت از 0 شروع می‌شود
            const gDay = gDate[2];
            
            const date = new Date(gYear, gMonth, gDay, hour, minute);
            //('تاریخ میلادی:', date.toISOString());
            return date;
        }
        
        return null;
    } catch (error) {
        console.error('خطا در تبدیل تاریخ شمسی به میلادی:', error);
        return null;
    }
}

// نمایش راهنمای انتخاب تاریخ
function showDatePickerHelp() {
    const scheduledTimeInput = document.getElementById('scheduledTimeInput');
    
    // اضافه کردن پلیس‌هولدر مناسب
    scheduledTimeInput.placeholder = 'مثال: 1404/03/30 15:30';
    
    // ایجاد راهنمای انتخاب تاریخ
    const helpText = document.createElement('div');
    helpText.className = 'date-picker-help';
    helpText.innerHTML = `
        <p>لطفا تاریخ و زمان را به فرمت زیر وارد کنید:</p>
        <p class="date-format-example">سال/ماه/روز ساعت:دقیقه</p>
        <p class="date-format-example">مثال: 1404/03/30 15:30</p>
        <div class="date-picker-buttons">
            <button type="button" class="date-picker-btn" data-time="1">یک ساعت بعد</button>
            <button type="button" class="date-picker-btn" data-time="3">سه ساعت بعد</button>
            <button type="button" class="date-picker-btn" data-time="24">فردا همین ساعت</button>
        </div>
    `;
    
    // اضافه کردن راهنما به پنل زمانبندی
    const schedulePanel = document.getElementById('schedulePanel');
    
    // حذف راهنمای قبلی اگر وجود دارد
    const oldHelp = schedulePanel.querySelector('.date-picker-help');
    if (oldHelp) {
        schedulePanel.removeChild(oldHelp);
    }
    
    schedulePanel.appendChild(helpText);
    
    // اضافه کردن رویداد کلیک به دکمه‌های انتخاب سریع
    const quickButtons = schedulePanel.querySelectorAll('.date-picker-btn');
    quickButtons.forEach(button => {
        button.addEventListener('click', function() {
            const hours = parseInt(this.dataset.time);
            const now = new Date();
            const selectedDate = new Date(now.getTime() + hours * 60 * 60 * 1000);
            
            // تبدیل به تاریخ شمسی
            const jalaliDate = toJalaliDate(selectedDate);
            
            // تنظیم تاریخ در فیلد ورودی
            scheduledTimeInput.value = jalaliDate;
            
            // ذخیره تاریخ
            scheduledTime = selectedDate.toISOString();
            
            // نمایش تاریخ انتخاب شده در پنل زمانبندی
            const scheduleTimeDisplay = document.getElementById('scheduleTimeDisplay');
            if (scheduleTimeDisplay) {
                scheduleTimeDisplay.textContent = jalaliDate;
            }
        });
    });
}

function getCurrentJalaliDate() {
    // این تابع یک تاریخ شمسی فعلی را برمی‌گرداند
    const now = new Date();
    
    // تبدیل تاریخ میلادی به شمسی با استفاده از الگوریتم دقیق
    function gregorianToJalali(gy, gm, gd) {
        var g_d_m, jy, jm, jd, gy2, days;
        g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
        if (gy > 1600) {
            jy = 979;
            gy -= 1600;
        } else {
            jy = 0;
            gy -= 621;
        }
        gy2 = (gm > 2) ? (gy + 1) : gy;
        days = (365 * gy) + (parseInt((gy2 + 3) / 4)) - (parseInt((gy2 + 99) / 100)) + (parseInt((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
        jy += 33 * (parseInt(days / 12053));
        days %= 12053;
        jy += 4 * (parseInt(days / 1461));
        days %= 1461;
        if (days > 365) {
            jy += parseInt((days - 1) / 365);
            days = (days - 1) % 365;
        }
        jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
        jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
        return [jy, jm, jd];
    }
    
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const day = now.getDate();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    
    // تبدیل به شمسی
    const jalali = gregorianToJalali(year, month, day);
    const jYear = jalali[0];
    const jMonth = jalali[1];
    const jDay = jalali[2];
    
    // ساخت خروجی به فرمت دلخواه (تاریخ و ساعت)
    return `${jYear}/${jMonth < 10 ? '0' + jMonth : jMonth}/${jDay < 10 ? '0' + jDay : jDay} ${hours < 10 ? '0' + hours : hours}:${minutes < 10 ? '0' + minutes : minutes}`;
}

// تبدیل تاریخ شمسی به میلادی
function jalaliToGregorian(jDate) {
    // این تابع یک تاریخ شمسی را به میلادی تبدیل می‌کند
    if (!jDate) return new Date();
    
    try {
        // اگر تاریخ به صورت رشته با فرمت "1404/04/29 09:55:00" باشد
        if (typeof jDate === 'string' && jDate.includes('/')) {
            // جداسازی تاریخ و زمان
            const parts = jDate.split(' ');
            const datePart = parts[0]; // مثلا 1404/04/29
            const timePart = parts.length > 1 ? parts[1] : '00:00:00'; // مثلا 09:55:00
            
            // جداسازی اجزای تاریخ
            const dateParts = datePart.split('/');
            if (dateParts.length !== 3) {
                console.error('فرمت تاریخ نامعتبر است');
                return new Date();
            }
            
            // تبدیل اعداد فارسی به انگلیسی
            const toEnglishDigits = str => str.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d));
            
            const jYear = parseInt(toEnglishDigits(dateParts[0]));
            const jMonth = parseInt(toEnglishDigits(dateParts[1]));
            const jDay = parseInt(toEnglishDigits(dateParts[2]));
            
            // بررسی معتبر بودن تاریخ شمسی
            if (isNaN(jYear) || isNaN(jMonth) || isNaN(jDay)) {
                console.error('اجزای تاریخ شمسی معتبر نیستند');
                return new Date();
            }
            
            // جداسازی اجزای زمان
            const timeParts = timePart.split(':');
            const hour = parseInt(toEnglishDigits(timeParts[0])) || 0;
            const minute = parseInt(toEnglishDigits(timeParts[1])) || 0;
            const second = timeParts.length > 2 ? parseInt(toEnglishDigits(timeParts[2])) || 0 : 0;
            
            // استفاده از الگوریتم تبدیل تاریخ شمسی به میلادی
            function jalaliToGregorianConverter(jy, jm, jd) {
                jy = parseInt(jy);
                jm = parseInt(jm);
                jd = parseInt(jd);
                
                var sal_a, gy, gm, gd, days;
                if (jy > 979) {
                    gy = 1600;
                    jy -= 979;
                } else {
                    gy = 621;
                }
                
                days = (365 * jy) + ((parseInt(jy / 33)) * 8) + (parseInt(((jy % 33) + 3) / 4)) + 78 + jd;
                
                if (jm < 7) {
                    days += (jm - 1) * 31;
                } else {
                    days += ((jm - 7) * 30) + 186;
                }
                
                gy += 400 * (parseInt(days / 146097));
                days = days % 146097;
                
                if (days > 36524) {
                    gy += 100 * (parseInt(--days / 36524));
                    days = days % 36524;
                    
                    if (days >= 365) days++;
                }
                
                gy += 4 * (parseInt(days / 1461));
                days = days % 1461;
                
                if (days > 365) {
                    gy += parseInt((days - 1) / 365);
                    days = (days - 1) % 365;
                }
                
                gd = days + 1;
                
                var sal_a = [0, 31, ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                
                for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) {
                    gd -= sal_a[gm];
                }
                
                return [gy, gm, gd];
            }
            
            // تبدیل تاریخ شمسی به میلادی
            const gDate = jalaliToGregorianConverter(jYear, jMonth, jDay);
            if (gDate && gDate.length === 3) {
                const gYear = gDate[0];
                const gMonth = gDate[1] - 1; // ماه در جاوااسکریپت از 0 شروع می‌شود
                const gDay = gDate[2];
                
                const date = new Date(gYear, gMonth, gDay, hour, minute, second);
                //('تاریخ میلادی:', date, 'ISO:', date.toISOString());
                return date;
            }
        }
        
        // اگر فرمت دیگری داشت، سعی می‌کنیم آن را به تاریخ تبدیل کنیم
        return new Date(jDate);
    } catch (error) {
        console.error('خطا در تبدیل تاریخ شمسی به میلادی:', error);
        return new Date();
    }
}

// به‌روزرسانی وضعیت دکمه ارسال بر اساس وضعیت انتخاب تاریخ
function updateSendButtonState() {
    const sendButton = document.getElementById('telegramSendBtn');
    const schedulePanel = document.getElementById('schedulePanel');
    const isSchedulePanelVisible = schedulePanel && (schedulePanel.style.display === 'flex' || schedulePanel.style.display === 'block');
    
    if (isSchedulePanelVisible && !window.scheduledTime) {
        // اگر پنل زمان‌بندی نمایش داده شده و تاریخی انتخاب نشده، دکمه ارسال غیرفعال شود
        sendButton.style.opacity = '0.5';
        sendButton.style.cursor = 'not-allowed';
        sendButton.title = 'لطفا ابتدا تاریخ ارسال را انتخاب کنید';
            } else {
        // در غیر این صورت، دکمه ارسال فعال باشد
        sendButton.style.opacity = '1';
        sendButton.style.cursor = 'pointer';
        sendButton.title = 'ارسال پیام';
    }
}

    // بارگذاری لیست کاربران
    function loadAllUsers() {
        const usersList = document.getElementById('telegramUsersList');
        if (usersList) {
            usersList.innerHTML = `
                <div class="telegram-users-loading">
                    <i class="fa-solid fa-spinner fa-spin"></i> در حال بارگذاری کاربران...
                </div>
            `;
            usersList.classList.add('active');
        }
        
        // استفاده از API جدید برای دریافت لیست کاربران
        $.ajax({
            url: '/api/get-users',
            type: 'GET',
            success: function(response) {
                if (response.success && response.users) {
                    allUsers = response.users.map(user => ({
                        id: user.id,
                        name: user.name,
                        id_number:user.id_number
                    }));
                    
                    debugLog(`${allUsers.length} کاربر یافت شد`);
                    
                    // نمایش لیست کاربران
                    showUsersList(allUsers);
                } else {
                    console.error('خطا در دریافت لیست کاربران:', response.error || 'خطای نامشخص');
                    
                    const usersList = document.getElementById('telegramUsersList');
                    if (usersList) {
                        usersList.innerHTML = `
                            <div class="telegram-no-users">
                                <i class="fa-solid fa-exclamation-circle"></i> خطا در بارگذاری لیست کاربران
                            </div>
                        `;
                    }
                }
            },
            error: function(error) {
                console.error('خطا در بارگذاری لیست کاربران:', error);
                
                const usersList = document.getElementById('telegramUsersList');
                if (usersList) {
                    usersList.innerHTML = `
                        <div class="telegram-no-users">
                            <i class="fa-solid fa-exclamation-circle"></i> خطا در بارگذاری لیست کاربران
                        </div>
                    `;
                }
            }
        });
    }

    // بارگذاری لیست کاربران در پس‌زمینه
    function loadUsersInBackground() {
        //('بارگذاری لیست کاربران در پس‌زمینه...');
        
        // استفاده از API جدید برای بارگذاری لیست کاربران
        $.ajax({
            url: '/api/get-users',
            type: 'GET',
            success: function(response) {
                if (response.success && response.users) {
                    allUsers = response.users.map(user => ({
                        id: user.id,
                        name: user.name,
                        id_number:user.id_number
                    }));
                    
                    //(`${allUsers.length} کاربر در پس‌زمینه بارگذاری شد`);
                    
                    // به‌روزرسانی شناسه کاربران در گفتگوهای موجود
                    if (allUsers.length > 0 && conversations.length > 0) {
                        conversations.forEach(conv => {
                            if (!conv.userId) {
                                const foundUser = allUsers.find(user => user.name === conv.name);
                                if (foundUser) {
                                    conv.userId = foundUser.id;
                                    //(`شناسه کاربر ${foundUser.id} برای گفتگو با ${conv.name} تنظیم شد`);
                                    
                                    // به‌روزرسانی ID گفتگو با استفاده از شناسه کاربر
                                    conv.id = `conv-user-${foundUser.id}`;
                                }
                            }
                        });
                        
                        // به‌روزرسانی نمایش گفتگوها
                        renderConversations(conversations);
                    }
                } else {
                    console.error('خطا در دریافت لیست کاربران در پس‌زمینه:', response.error || 'خطای نامشخص');
                    
                    // تلاش مجدد بعد از 5 ثانیه
                    setTimeout(loadUsersInBackground, 5000);
                }
            },
            error: function(error) {
                console.error('خطا در بارگذاری لیست کاربران در پس‌زمینه:', error);
                
                // تلاش مجدد بعد از 5 ثانیه
                setTimeout(loadUsersInBackground, 5000);
            }
        });
    }

    // اجرای اولیه
    document.addEventListener('DOMContentLoaded', function() {
        // بارگذاری اولیه پیام‌ها
        if (chatContainer.classList.contains('open')) {
                loadAllMessages();
        }
        
        // بارگذاری لیست کاربران در پس‌زمینه - بلافاصله شروع شود
        loadUsersInBackground();
    });

    // نمایش محلی پیام ارسال شده
    function showLocalSentMessage(messageText) {
            const now = new Date();
        const jalaliDate = toJalaliDate(now);
        
        // افزودن به لیست پیام‌های فعال
        activeMessages.push({
            id: `temp-${Date.now()}`,
            subject: 'پاسخ',
            body: messageText,
            date: jalaliDate,
            isReceived: false
        });
        
        // نمایش مجدد پیام‌ها
        renderMessages(activeMessages);
        
        // پاک کردن فیلد ورودی
        const inputElement = document.getElementById('telegramInput');
        if (inputElement) {
            inputElement.value = '';
        }
    }

    // تابع جدید برای تشخیص وضعیت پیام
    function getMessageStatus(message) {
        // اگر پیام دریافتی است، وضعیت خاصی ندارد
        if (message.isReceived) {
            return {
                icon: '',
                text: '',
                class: ''
            };
        }
        
        // تاریخ فعلی برای مقایسه با زمان زمانبندی شده
        const now = new Date();
        
        // اگر پیام زمانبندی شده است و زمان آن در آینده است
        if (message.scheduled_time && isInFuture(message.date)) {
            return {
                icon: '<i class="fa-solid fa-clock telegram-message-status-icon telegram-message-pending"></i>',
                text: 'در انتظار ارسال',
                class: 'telegram-message-pending'
            };
        }
        
        // اگر پیام خوانده شده است
        if (message.seen_by && message.seen_by.length > 0) {
            return {
                icon: '<i class="fa-solid fa-check-double telegram-message-status-icon telegram-message-seen"></i>',
                text: `خوانده شده توسط ${message.seen_by.length} نفر`,
                class: 'telegram-message-seen'
            };
        }
        
        // در غیر این صورت، پیام فقط ارسال شده است
        return {
            icon: '<i class="fa-solid fa-check telegram-message-status-icon telegram-message-sent"></i>',
            text: 'ارسال شده',
            class: 'telegram-message-sent'
        };
    }

    // تابع تست برای بررسی عملکرد پیام‌های صوتی
    window.testAudioPlayers = function() {
        //("Testing audio players...");
        
        // یافتن همه دکمه‌های پخش صوتی
        const audioButtons = document.querySelectorAll('.telegram-audio-play');
        //(`Found ${audioButtons.length} audio buttons`);
        
        // بررسی هر دکمه
        audioButtons.forEach((button, index) => {
            const audioUrl = button.getAttribute('data-url');
            const audioPlayer = button.closest('.telegram-audio-custom');
            const timeDisplay = audioPlayer ? audioPlayer.querySelector('.telegram-audio-time-display') : null;
            const progressBar = audioPlayer ? audioPlayer.querySelector('.telegram-audio-progress-bar') : null;
            
            //(`Audio button ${index + 1}:`);
            //(`- URL: ${audioUrl}`);
            //(`- Player container: ${audioPlayer ? 'Found' : 'Not found'}`);
            //(`- Time display: ${timeDisplay ? 'Found' : 'Not found'}`);
            //(`- Progress bar: ${progressBar ? 'Found' : 'Not found'}`);
            
            // تست آماده‌سازی پخش‌کننده
            if (audioUrl && audioPlayer && timeDisplay && progressBar) {
                //(`- Initializing player ${index + 1}...`);
                setupTelegramAudio(audioUrl, button, true);
            }
        });
    };

    // اجرای تست بعد از بارگذاری صفحه
    window.addEventListener('load', function() {
        setTimeout(testAudioPlayers, 1000);
    });
</script> 
</body>
</html>
</html>